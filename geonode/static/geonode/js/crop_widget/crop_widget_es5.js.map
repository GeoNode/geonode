{"version":3,"sources":["crop_widget.js"],"names":["IDS_VALUT","SEND_B_ID","CANCEL_B_ID","OK_B_ID","DISMISS_B_ID","GRAIN_WRAP_ID","FILE_INPUT_ID","WORKSPACE_ID","WORKSPACE_CONTAINER_ID","MODAL_OVERLAY_ID","FILE_LABEL_ID","ThumbnailService","document_id","get_path","base64_url","formData","FormData","append","_b64toBlob","url","location","origin","String","$","ajax","data","type","contentType","processData","headers","_getCookie","success","reload","error","Error","name","value","document","cookie","parts","split","length","pop","shift","image_element","callback","thumbnail_url","src","b64Data","sliceSize","byteCharacters","atob","byteArrays","offset","slice","byteNumbers","Array","i","charCodeAt","byteArray","Uint8Array","push","Blob","CssManager","dom_elem_id","removeClass","addClass","val","DomBuilder","widget_grain","wrap","grain_wrapper","prepend","workspace_html","body","_create_flow_buttons","CropTask","dom_builder","css_manager","data_service","previous_image","cropper","Cropper","aspectRatio","crop","event","image_src","create_workspace","on","load_start_image","bind","dismiss_current_image","apply_current_image","cancel_cropping","send_cropped_image","file_event","window","File","FileReader","FileList","target","files","file","fr","onload","e","destroy","attr","result","onloadend","init_cropper","change_modal_visibility","readAsDataURL","_clear_input","h","height","w","width","getCroppedCanvas","toDataURL","makeImvisible","makeVisible","set_previous_image","postThumbnail","CropWidget","element","prefetch_image","tagName","service","init","undefined","getThumbnail"],"mappings":"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","sourcesContent":["const IDS_VALUT = {\n    SEND_B_ID: 'id_crop_save_button',\n    CANCEL_B_ID: 'id_crop_cancel_button',\n    OK_B_ID: 'id_crop_ok_button',\n    DISMISS_B_ID: 'id_crop_dismiss_button',\n    GRAIN_WRAP_ID: 'id_crop_entry',\n    FILE_INPUT_ID: 'id_crop_file',\n    WORKSPACE_ID: 'id_crop_modal_workspace',\n    WORKSPACE_CONTAINER_ID: 'id_crop-modal-container',\n    MODAL_OVERLAY_ID: 'id_crop-modal-overlay',\n    FILE_LABEL_ID: 'id_crop-file-label'\n}\n\n\nclass ThumbnailService {\n\n    constructor(document_id, get_path) {\n        this.document_id = document_id;\n        this.get_path = get_path;\n    }\n\n    postThumbnail(base64_url) {\n        const formData = new FormData();\n        formData.append(\"img\", this._b64toBlob(base64_url), 'blob.png');\n        const url = location.origin + '/base/' + String(this.document_id) + '/thumbnail_upload';\n        $.ajax({\n            url: url,\n            data: formData,\n            type: 'POST',\n            contentType: false,\n            processData: false,\n            headers: {\n                \"X-CSRFToken\": this._getCookie('csrftoken')\n            },\n            success: () => {\n                location.reload();\n            },\n            error: () => {\n                throw Error('Cannot upload new thumbnail');\n            }\n        });\n    }\n\n    _getCookie(name) {\n        const value = \"; \" + document.cookie;\n        const parts = value.split(\"; \" + name + \"=\");\n        if (parts.length === 2) {\n            return parts.pop().split(\";\").shift();\n        }\n    }\n\n    getThumbnail(image_element, callback = null) {\n        const url = location.origin + this.get_path + String(this.document_id);\n        return $.ajax({\n            url: url,\n            type: 'GET',\n            contentType: false,\n            processData: false,\n            headers: {\n                \"X-CSRFToken\": this._getCookie('csrftoken')\n            },\n            success: (data) => {\n                if (data && data.thumbnail_url) {\n                    image_element.src = data.thumbnail_url;\n                } else {\n                    image_element.src = '/static/geonode/img/missing_thumb.png';\n                }\n                if (callback !== null) {\n                    callback();\n                }\n            },\n            error: () => {\n                image_element.src = '/static/geonode/img/missing_thumb.png';\n            }\n        });\n\n    }\n\n    _b64toBlob(b64Data, contentType, sliceSize = 512) {\n        contentType = contentType || '';\n        b64Data = b64Data.split(',')[1];\n\n        const byteCharacters = atob(b64Data);\n        const byteArrays = [];\n\n        for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {\n            const slice = byteCharacters.slice(offset, offset + sliceSize);\n\n            const byteNumbers = new Array(slice.length);\n            for (let i = 0; i < slice.length; i++) {\n                byteNumbers[i] = slice.charCodeAt(i);\n            }\n\n            const byteArray = new Uint8Array(byteNumbers);\n\n            byteArrays.push(byteArray);\n        }\n\n        return new Blob(byteArrays, {type: contentType});\n    }\n}\n\nclass CssManager {\n\n    makeVisible(dom_elem_id) {\n        $('#' + dom_elem_id).removeClass('invisible');\n    }\n\n    makeImvisible(dom_elem_id) {\n        $('#' + dom_elem_id).addClass('invisible');\n    }\n\n    change_modal_visibility() {\n        if ($('#' + IDS_VALUT.FILE_INPUT_ID).val()) {\n            $('#' + IDS_VALUT.WORKSPACE_CONTAINER_ID).removeClass('invisible');\n            $('#' + IDS_VALUT.MODAL_OVERLAY_ID).removeClass('invisible');\n        } else {\n            $('#' + IDS_VALUT.WORKSPACE_CONTAINER_ID).addClass('invisible');\n            $('#' + IDS_VALUT.MODAL_OVERLAY_ID).addClass('invisible');\n        }\n    }\n}\n\nclass DomBuilder {\n    // class too manage building required dom to display cropper\n\n    constructor(widget_grain) {\n        this.widget_grain = widget_grain;\n        $(this.widget_grain).wrap(() => `<div id=${IDS_VALUT.GRAIN_WRAP_ID} class=crop-widget></div>`);\n        $(this.widget_grain).wrap(() => ``);\n\n        this.grain_wrapper = $('#' + IDS_VALUT.GRAIN_WRAP_ID);\n        this.grain_wrapper.append(`<div id=${IDS_VALUT.MODAL_OVERLAY_ID} class=\"crop-modal-overlay invisible\"></div>`);\n        this.grain_wrapper.prepend(`<div class=\"thumbnail-title\">Thumbnail</div>`);\n\n    }\n\n    _create_flow_buttons() {\n        this.grain_wrapper.append(`<input type=file id=${IDS_VALUT.FILE_INPUT_ID} name=files class=crop-input /> `);\n        this.grain_wrapper.append(`<label id=${IDS_VALUT.FILE_LABEL_ID} for=${IDS_VALUT.FILE_INPUT_ID} class=\"btn btn-default crop-input-label\">Choose file</label>`);\n        this.grain_wrapper.append(`<button type=button id=${IDS_VALUT.SEND_B_ID} class=\\\"btn btn-default invisible\\\">Save</button><button type=button id=${IDS_VALUT.CANCEL_B_ID} class=\"btn btn-default invisible\">Cancel</button>`);\n\n    }\n\n    create_workspace() {\n        const workspace_html = `\n                              <div id=${IDS_VALUT.WORKSPACE_CONTAINER_ID} class=\"crop-modal-container invisible\">                                  \n                                  <img id=${IDS_VALUT.WORKSPACE_ID} class=\"crop-modal-workspace\">                                      \n                                  <button type=button id=${IDS_VALUT.OK_B_ID} class=\"btn btn-default\">OK</button><button type=button id=${IDS_VALUT.DISMISS_B_ID} class=\"btn btn-default\">Dismiss</button>                                      \n                              </div>`;\n\n\n        $(document.body).append(workspace_html);\n        this._create_flow_buttons();\n\n    }\n\n}\n\nclass CropTask {\n\n    constructor(dom_builder, css_manager, data_service) {\n        this.dom_builder = dom_builder;\n        this.css_manager = css_manager;\n        this.previous_image = null;\n        this.data_service = data_service;\n    }\n\n    init_cropper() {\n        this.cropper = new Cropper($('#' + IDS_VALUT.WORKSPACE_ID)[0], {\n            aspectRatio: 4 / 3,\n            crop(event) {\n            },\n        });\n    }\n\n    set_previous_image(image_src) {\n        this.previous_image = image_src;\n    }\n\n    init() {\n        this.dom_builder.create_workspace();\n        $('#' + IDS_VALUT.FILE_INPUT_ID).on('change', this.load_start_image.bind(this));\n        $('#' + IDS_VALUT.DISMISS_B_ID).on('click', this.dismiss_current_image.bind(this));\n        $('#' + IDS_VALUT.OK_B_ID).on('click', this.apply_current_image.bind(this));\n\n        $('#' + IDS_VALUT.CANCEL_B_ID).on('click', this.cancel_cropping.bind(this));\n        $('#' + IDS_VALUT.SEND_B_ID).on('click', this.send_cropped_image.bind(this));\n        this.previous_image = this.dom_builder.widget_grain.src;\n    }\n\n    load_start_image(file_event) {\n        if (window.File && window.FileReader && window.FileList && window.Blob) {\n\n            if (file_event.target.files.length) {\n                const file = file_event.target.files[0];\n                const fr = new FileReader();\n\n                fr.onload = (e) => {\n                    if (this.cropper) {\n                        this.cropper.destroy();\n                    }\n                    $('#' + IDS_VALUT.WORKSPACE_ID).attr('src', e.target.result);\n\n                }\n                fr.onloadend = (e) => {\n                    this.init_cropper();\n                    this.css_manager.change_modal_visibility();\n                };\n                fr.readAsDataURL(file);\n\n\n            }\n        } else {\n            throw Error('FileAPI is not supported');\n        }\n    }\n\n    _clear_input() {\n        $('#' + IDS_VALUT.FILE_INPUT_ID).val('');\n    }\n\n    dismiss_current_image() {\n        this._clear_input();\n        this.cropper.destroy();\n        this.css_manager.change_modal_visibility();\n\n    }\n\n    apply_current_image() {\n        const h = this.dom_builder.widget_grain.height;\n        const w = this.dom_builder.widget_grain.width;\n        $(this.dom_builder.widget_grain).attr('src', this.cropper.getCroppedCanvas({\n            width: 400,\n        }).toDataURL());\n        $(this.dom_builder.widget_grain).attr('height', h);\n        $(this.dom_builder.widget_grain).attr('width', w);\n        this.css_manager.makeImvisible(IDS_VALUT.FILE_LABEL_ID);\n        this.css_manager.makeImvisible(IDS_VALUT.FILE_INPUT_ID);\n        this.css_manager.makeVisible(IDS_VALUT.SEND_B_ID);\n        this.css_manager.makeVisible(IDS_VALUT.CANCEL_B_ID);\n        this.cropper.destroy();\n        this._clear_input();\n        this.css_manager.change_modal_visibility();\n    }\n\n    cancel_cropping() {\n        $(this.dom_builder.widget_grain).attr('src', this.previous_image);\n        this._clear_input();\n        this.css_manager.makeImvisible(IDS_VALUT.CANCEL_B_ID);\n        this.css_manager.makeImvisible(IDS_VALUT.SEND_B_ID);\n        this.css_manager.makeVisible(IDS_VALUT.FILE_INPUT_ID);\n        this.css_manager.makeVisible(IDS_VALUT.FILE_LABEL_ID);\n    }\n\n    send_cropped_image() {\n        this.set_previous_image(this.dom_builder.widget_grain.src);\n        this.data_service.postThumbnail(this.previous_image)\n        this.css_manager.makeVisible(IDS_VALUT.FILE_INPUT_ID);\n        this.css_manager.makeImvisible(IDS_VALUT.SEND_B_ID);\n        this.css_manager.makeImvisible(IDS_VALUT.CANCEL_B_ID);\n    }\n\n\n}\n\n\nclass CropWidget {\n\n    /**\n     *\n     * @param element: img html DOM element, widget grain and final destination\n     * @param document_id id of resource. is used to build get and post requests\n     * @param get_path: api endpoint path to get current thumbnail\n     * @param prefetch_image: in case current/previous thumbnail is not API accessible provide its static url\n     *\n     */\n    constructor(element, document_id, get_path, prefetch_image = null) {\n        this.element = element;\n        if (this.element.tagName !== 'IMG') {\n            throw Error('Base element should be <img>');\n        }\n        this.dom_builder = new DomBuilder(this.element);\n        this.css_manager = new CssManager();\n        this.service = new ThumbnailService(document_id, get_path);\n        this.crop = null;\n        this.prefetch_image = prefetch_image;\n    }\n\n    init() {\n        this.crop = new CropTask(this.dom_builder, this.css_manager, this.service);\n        if (this.prefetch_image === '') {\n            this.element.src = '/static/geonode/img/missing_thumb.png';\n            this.crop.init();\n        } else if (this.prefetch_image === null || this.prefetch_image === undefined) {\n            this.service.getThumbnail(this.element, this.crop.init.bind(this.crop));\n        } else {\n            this.element.src = this.prefetch_image;\n            this.crop.init();\n        }\n    }\n}\n\n\n"],"file":"crop_widget_es5.js"}