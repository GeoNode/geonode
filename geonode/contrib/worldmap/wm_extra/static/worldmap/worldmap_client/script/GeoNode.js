Ext.namespace("GeoNode");
GeoNode.DataGrid=Ext.extend(Ext.util.Observable,{dataTitleHeaderText:"UT:Title",dataNameHeaderText:"UT:Name",dataDetailText:"UT: Click here for more information about this layer.",constructor:function(a){Ext.apply(this,a);this.loadData()},owsURL:function(a){a=this.ows+"?"+Ext.urlEncode(a);this.proxy&&(a=this.proxy+"?"+Ext.urlEncode({url:a}));return a},loadData:function(){var a=this.owsURL({service:"WMS",request:"GetCapabilities"});this.capabilities=new GeoExt.data.WMSCapabilitiesStore({url:a,fields:[{name:"name",
type:"string"},{name:"abstract",type:"string"},{name:"queryable",type:"boolean"},{name:"formats"},{name:"styles"},{name:"llbbox"},{name:"minScale"},{name:"maxScale"},{name:"prefix"},{name:"attribution"},{name:"keywords"},{name:"metadataURLs"},{name:"owsType"}]});gxp.util.dispatch([function(a){this.capabilities.load({callback:a,scope:this})}],this.doLayout,this)},doLayout:function(){var a=new GeoExplorer.CapabilitiesRowExpander({tpl:new Ext.Template("<p><b>"+GeoExplorer.CapabilitiesRowExpander.prototype.abstractText+
"</b> {abstract}</p><p><b>"+GeoExplorer.CapabilitiesRowExpander.prototype.attributionText+"</b> {attribution:this.attributionLink}</p><p><b>"+GeoExplorer.CapabilitiesRowExpander.prototype.metadataText+"</b> {metadataURLs:this.metadataLinks}</p><p><b>"+GeoExplorer.CapabilitiesRowExpander.prototype.keywordText+"</b> {keywords:this.keywordList}</p><p><b>"+GeoExplorer.CapabilitiesRowExpander.prototype.downloadText+'</b> <a class="download pdf" href="{name:this.pdfUrl}">PDF</a>, <a class="download kml" href="{name:this.kmlUrl}">KML</a>, <a class="download geotiff" href="{name:this.geoTiffUrl}">GeoTIFF</a><span class="{owsType:this.showWFS}">, <a class="download shp" href="{name:this.shpUrl}">SHP (ZIP)</a></span></p><p><a href="/data/{name}">'+
this.dataDetailText+"</a></p>"),ows:this.ows});new Ext.grid.GridPanel({store:this.capabilities,plugins:[a],columns:[a,{header:this.dataTitleHeaderText,dataIndex:"title"},{header:this.dataNameHeaderText,dataIndex:"name"}],viewConfig:{autoFill:!0},height:300,renderTo:this.renderTo})}});Ext.namespace("GeoNode");
var time_periods=[["5000M BCE","*"],["500M BCE",-5E8],["50M BCE",-5E7],["5M BCE",-5E6],["1M BCE",-1E6],["100K BCE",-1E5],["10K BCE",-1E4],["1K BCE",-1E3],["500 BCE",-500],["100 BCE",-100],["1",1],["100",100],["500",500],["1000",1E3],["1500",1500],["1600",1600],["1700",1700],["1800",1800],["1900",1900],["1910",1910],["1920",1920],["1930",1930],["1940",1940],["1950",1950],["1960",1960],["1970",1970],["1980",1980],["1990",1990],["1991",1991],["1992",1992],["1993",1993],["1994",1994],["1995",1995],["1996",
1996],["1997",1997],["1998",1998],["1999",1999],["2000",2E3],["2001",2001],["2002",2002],["2003",2003],["2004",2004],["2005",2005],["2006",2006],["2007",2007],["2008",2008],["2009",2009],["2010",2010],["2011",2011],["2012",2012],["2013",2013],["2014",2014],["2015",2015],["2016",2016],["2017",2017],["2018",2018],["2019",2019],["2020",2020],["2050",2050],["2100",2100],["Future","*"]];
GeoNode.TimeSlider=Ext.extend(Ext.slider.MultiSlider,{increment:1,minValue:0,maxValue:60,values:[0,60],getDateValues:function(){var a=this.valuesToDates(),b=a[0],a=a[1];"*"!==b&&(b+="-01-01T00:00:00.0Z");"*"!==a&&(a+="-01-01T00:00:00.0Z");return"["+b+" TO "+a+"]"},valuesToTime:function(){var a=this.getValues();return[time_periods[a[0]][0],time_periods[a[1]][0]]},valuesToDates:function(){var a=this.getValues();return[time_periods[a[0]][1],time_periods[a[1]][1]]},cleanupInput:function(a){if(-1<a.indexOf("BCE")){var b=
"";-1<a.indexOf("M")&&(b="000000");-1<a.indexOf("K")&&(b="000");a="-"+a.replace(/\D+/,"")+b}return a},valuesFromInput:function(a,b){for(var c=parseInt(this.cleanupInput(b)),d=0;d<time_periods.length;d++)if(c>=time_periods[d][1]&&c<=time_periods[d+1][1]){this.setValue(a,d+1);break}}});Ext.namespace("GeoNode");
GeoNode.Solr=function(){this.getServerName=function(){var a=GeoNode.solrBackend.split(",")[0];0==a.indexOf("http://")||0==a.indexOf("https://")||(a="http://"+a);!1==("select"==a.substring(a.length-6))&&(a+="select");return a};this.getShardServerNames=function(){var a=GeoNode.solrBackend.split(","),b="";if(1==a.length)return b;for(var c=0;c<a.length;c++)0==a[c].indexOf("http://")&&(a[c]=a[c].substr(7)),!0==("select"==a[c].substring(a[c].length-6))&&(a[c]=a[c].substring(0,a[c].length-6)),0<b.length&&
(b+=","),b+=a[c];return"shards="+b};this.enableHeatmap=function(){this.heatmap=!0};this.ignoreSpatial=!1;this.setIgnoreSpatial=function(a){this.ignoreSpatial=a};this.getSearchParams=function(){this.textParams=this.getOgpTextSearchParams();this.spatialParams={};if(!this.ignoreSpatial)this.spatialParams=this.getOgpSpatialQueryParams(this.bounds);this.baseParams={wt:"json",defType:"edismax",fl:this.getReturnedColumns(this.SearchRequest),sort:this.getSortClause()};if(this.heatmap)this.baseParams=this.combineParams(this.baseParams,
{facet:"true","facet.heatmap":"bbox_rpt","facet.heatmap.format":"ints2D"});return this.combineParams(this.baseParams,this.spatialParams,this.textParams)};this.combineParams=function(){var a={},b;for(b in arguments){var c=arguments[b],d;for(d in c)if("undefined"===typeof a[d]||0===a[d].length)a[d]=c[d];else if(jQuery.isArray(a[d]))if(jQuery.isArray(c[d]))for(var e in c[d])a[d].push(c[d][e]);else a[d].push(c[d]);else a[d]=c[d]}return a};this.SortAscending="asc";this.SortOrder=this.SortDescending="desc";
this.SortColumn="score";this.setSort=function(a,b){if("asc"!==b&&"desc"!==b)b=this.SortOrder;null===a?a=this.SortColumn:!a.includes("score")&&!a.includes("Access")&&!a.includes("ContentDate")&&(a+="Sort");this.SortColumn=a;this.SortOrder=b};this.getSortClause=function(){return this.SortColumn+" "+this.SortOrder};this.SearchRequest="Search";this.MetadataRequest="FgdcText";this.CountRequest="CountOnly";this.SearchRequestColumns="Name,Institution,Access,DataType,LayerTitle,Publisher,GeoReferenced,Originator,Location,min_x,max_x,min_y,max_y,ContentDate,LayerId,score,WorkspaceName,CollectionId,ServiceType,Availability".split(",");
this.getReturnedColumns=function(a){var b="";return b=a==this.MetadataRequest?"LayerId,FgdcText":a==this.CountRequest?"":a==this.SearchRequest?this.SearchRequestColumns.join():"error in this.getReturnedColumnsClause did not understand passed requestType "+a};this.getURL=function(){var a=jQuery.param(this.getSearchParams(),!0);return this.getServerName()+"?"+a};this.getOgpTextSearchParams=function(){var a=this.getTerms();return{qf:a.fields.join(" "),q:a.userTerms||"*",fq:this.filters}};this.SearchType=
"basic";this.setSearchType=function(a){this.SearchType=a};this.getTerms=function(){var a=this.SearchType,b={};if("advanced"===a)b.userTerms=this.getAdvancedKeywords(),b.fields=this.getAdvancedKeywordTermsArr();else if("basic"===a)b.userTerms=this.what,b.fields=this.getBasicKeywordTermsArr();else throw Error("Search type '"+a+"' is unsupported.");return b};this.setWhat=function(a){this.what=a};this.setWhere=function(a){this.where=a};this.AdvancedKeywordString=null;this.setAdvancedKeywords=function(a){this.AdvancedKeywordString=
a};this.getAdvancedKeywords=function(){return this.AdvancedKeywordString};this.LayerDisplayNameTerm={basic:{term:"LayerTitleSynonyms",boost:0.2},advanced:{term:"LayerTitleSynonyms",boost:0.2}};this.ThemeKeywordsTerm={term:"ThemeKeywordsSynonymsLcsh",boost:0.1};this.PlaceKeywordsTerm={term:"PlaceKeywordsSynonyms",boost:0.1};this.PublisherTerm={term:"Publisher",boost:0.1};this.OriginatorTerm={term:"Originator",boost:0.1};this.IsoTopicTerm={term:"ThemeKeywordsSynonymsIso",boost:0.1};this.BasicKeywordTerms=
[this.LayerDisplayNameTerm,this.IsoTopicTerm,this.ThemeKeywordsTerm,this.PlaceKeywordsTerm,this.PublisherTerm,this.OriginatorTerm];this.AdvancedKeywordTerms=[this.LayerDisplayNameTerm,this.ThemeKeywordsTerm,this.PlaceKeywordsTerm];this.getKeywordTerms=function(a,b){for(var c=[],d=0;d<a.length;d++){var e=a[d];e.hasOwnProperty(b)&&(e=e[b]);c.push(e.term+"^"+e.boost)}return c};this.getBasicKeywordTermsArr=function(){return this.getKeywordTerms(this.BasicKeywordTerms,"basic")};this.getAdvancedKeywordTermsArr=
function(){return this.getKeywordTerms(this.AdvancedKeywordTerms,"advanced")};this.filters=[];this.createFilter=function(a,b,c,d){if("undefined"===typeof b||0===b.length)return"";jQuery.isArray(b)||(b=[b]);for(var e=[],c=0;c<b.length;c++)e.push(a+":"+b[c]);if("undefined"===typeof d)d="OR";else if("OR"!=d&&"AND"!=d)throw Error("clause must be joined with 'AND' or 'OR'.");return e.join(" "+d+" ")};this.createRangeFilter=function(a,b,c,d){"undefined"===typeof d&&(d="");return d+(a+":["+b+" TO "+c+"]")};
this.addFilter=function(a){0<a.length&&this.filters.push(a)};this.createAccessFilter=function(a){a=this.createFilter("Institution",a);0<a.length&&(a+=" OR Access:Public");console.log("in solr.createAccessFilter, accessFilter = "+a);return a};this.filterDateValue=function(a){if(null==a||""==a)return"";if(!jQuery.isNumeric(a))throw Error("Year must be numeric");var b=a.length;if(4<b)throw Error("Year cannot be more than 4 digits.");return 4==b?a:3==b?"0"+a:2==b?"00"+a:1==b?"000"+a:""};this.createDateRangeFilter=
function(a,b,c){b=this.filterDateValue(b);c=this.filterDateValue(c);return(null==b||""==b)&&(null==c||""==c)?"":this.createRangeFilter(a,(b||"0001")+"-01-01T01:01:01Z",(c||"2100")+"-01-01T01:01:01Z")};this.createNonGlobalAreaFilter=function(){return this.createFilter("area","[0 TO 400]")};this.createOriginFilter=function(){return"!(Area:1 AND MaxX:0 AND MaxY:0)"};this.LayerWithinMap={term:"LayerWithinMap",boost:80};this.LayerMatchesScale={term:"LayerMatchesScale",boost:70};this.LayerMatchesCenter=
{term:"LayerMatchesCenter",boost:15};this.LayerAreaIntersection={term:"LayerAreaIntersection",boost:30};this.getOgpSpatialQueryParams=function(a){var b={bf:[this.classicLayerMatchesArea(a)+"^"+this.LayerMatchesScale.boost,this.classicLayerAreaIntersectionScore(a)+"^"+this.LayerAreaIntersection.boost,this.classicCenterRelevancyClause()+"^"+this.LayerMatchesCenter.boost,this.classicLayerWithinMap(a)+"^"+this.LayerWithinMap.boost],fq:[this.getIntersectionFilter()],intx:this.getIntersectionFunction(a)};
this.heatmap&&(b=this.combineParams(b,{"facet.heatmap.geom":'["'+a.minX+" "+a.minY+'" TO "'+a.maxX+" "+a.maxY+'"]'}));return b};this.getIntersectionFilter=function(){return"{!frange l=0 incl=false cache=false}$intx"};this.getIntersectionFunction=function(a){var b=function(a,b,c,d){return"max(0,sub(min("+c+","+d+"),max("+a+","+b+")))"},c;if(a.minX>a.maxX){c=b(a.minX,"min_x",180,"max_x");var d=b(-180,"min_x",a.maxX,"max_x");c="sum("+c+","+d+")"}else c=b(a.minX,"min_x",a.maxX,"max_x");a=b(a.minY,"min_y",
a.maxY,"max_y");return"product("+c+","+a+")"};this.layerNearCenterClause=function(a,b,c){return"recip(abs(sub(product(sum("+b+","+c+"),.5),"+a+")),1,1000,1000)"};this.classicCenterRelevancyClause=function(){var a=this.getCenter(),b="sum("+this.layerNearCenterClause(a.centerX,"min_x","max_x")+",";return b+=this.layerNearCenterClause(a.centerY,"min_y","max_y")+")"};this.classicLayerMatchesArea=function(a){var b=Math.abs(a.maxX-a.minX),a=Math.abs(a.maxY-a.minY);return"recip(sum(abs(sub(area,"+b*a+")),.01),1,1000,1000)"};
this.classicLayerAreaIntersectionScore=function(a){for(var b=a.minX,c=a.minY,d=a.maxY,a=Math.abs(a.maxX-b)/4,d=Math.abs(d-c)/4,e="sum(",f=0;3>f;f++)for(var g=0;3>g;g++){var h=b+(f+1)*a,j=c+(g+1)*d,i="map(sum(map(sub("+h+",min_x),0,400,1,0),",i=i+("map(sub("+h+",max_x),-400,0,1,0),"),i=i+("map(sub("+j+",min_y),0,400,1,0),"),i=i+("map(sub("+j+",max_y),-400,0,1,0)),"),i=i+"4,4,1,0)";if(0<f||0<g)e+=",";e+=i}return"product("+(e+")")+","+1/9+")"};this.classicLayerWithinMap=function(a){var b=a.minX,c=a.maxX,
d=a.minY,a=a.maxY;return"if(and(exists(min_x),exists(max_x),exists(min_y),exists(max_y)),map(sum("+("map(min_x,"+b+","+c+",1,0),")+("map(max_x,"+b+","+c+",1,0),")+("map(min_y,"+d+","+a+",1,0),")+("map(max_y,"+d+","+a+",1,0))")+",4,4,1,0),0)"};this.setBoundingBox=function(a){this.bounds={minX:Math.max(a.minX,-180),minY:Math.max(a.minY,-90),maxX:Math.min(a.maxX,180),maxY:Math.min(a.maxY,90)}};this.clearBoundingBox=function(){this.bounds={}};this.center={};this.setCenter=function(a){this.center=a};this.getCenter=
function(){return this.center};this.getBoundsArea=function(a){var b=Math.abs(a.maxX-a.minX);return Math.abs(a.maxY-a.minY)*b};this.sendToSolr=function(a,b,c){console.log("in Solr.sendToSolr");var d={type:"GET",url:a,dataType:"jsonp",jsonp:"json.wrf",timeout:5E3,crossDomain:!0,success:function(a){console.log("data from solr");foo=a;b(a)},error:function(a){c(a)}};if(3<arguments.length){var e=arguments[3];d.context=e;d.success=function(a){b.apply(e,arguments)}}jQuery.ajax(d)};this.getArbitraryParams=
function(a,b){return{q:this.createFilter("LayerId",a),fl:this.getReturnedColumns(b),wt:"json"}};this.getMetadataParams=function(a){return this.getArbitraryParams(a,this.MetadataRequest)};this.getTermParams=function(a,b){return{"terms.fl":a,"terms.regex":".*"+b+".*","terms.regex.flag":"case_insensitive","terms.limit":-1,omitHeader:!0,wt:"json"}};this.getInfoFromLayerIdParams=function(a){return{q:this.createFilter("LayerId",a),wt:"json",fl:this.getReturnedColumns(this.SearchRequest),rows:1E4}};this.getLayerInfoFromSolr=
function(a,b,c){var d=this.getServerName(),a=jQuery.param(this.getInfoFromLayerIdParams(a),!0);this.sendToSolr(d+"?"+a,b,c)};this.termQuery=function(a,b,c,d){var e=this.getServerName().substring(0,this.getServerName().indexOf("select"))+"terms",a=jQuery.param(this.getTermParams(a,b),!0);this.sendToSolr(e+"?"+a,c,d)};this.getNewOgpSpatialQueryParams=function(a){var b=this.getCenter(a.minX,a.maxX),c=this.getCenter(a.minY,a.maxY);console.log(b);console.log(c);var d=this.getBoundsArea(a);return{bf:[this.getBoundsAreaRelevancyClause()+
"^"+this.LayerMatchesScale.boost,this.getCenterRelevancyClause(c,b)+"^"+this.LayerMatchesCenter.boost],boost:this.getLayerWithinMapClause(),fq:[this.getIntersectionFilter()],intx:this.getIntersectionFunction(a),union:d,debug:!0}};this.getCenterRelevancyClause=function(a,b){var c;return"if(and(exists(CenterX),exists(CenterY)),"+("recip(dist(2,CenterX,CenterY,"+b+","+a+"),1,1000,1000),0)")};this.getBoundsAreaRelevancyClause=function(){return"if(exists(area),recip(abs(sub(Area,$union)),1,1000,1000),0)"};
this.getIntersectionAreaRelevancyClause=function(){return"if(not(sub($union,$intx)),div($intx,$union),0)"};this.getLayerWithinMapClause=function(){return"{!frange u=15 l=0 incu=false incl=false cache=false} product(15,div($intx,$union))"}};
$(document).ready(function(){Ext.namespace("GeoNode");Ext.onReady(function(){GeoNode.queryTerms={intx:"product(max(0,sub(min(180,max_x),max(-180,min_x))),max(0,sub(min(90,max_y),max(-90,min_y))))",sort:"score desc",fl:"id, uuid, name, title, abstract, min_x, min_y, max_x, max_y, layer_originator, is_public, url, service_type, bbox, location, layer_datetype, srs",qf:"title_txt^1 abstract_txt^0.2 originator_txt layer_username",wt:"json",defType:"edismax",q:"*",fq:["{!frange l=0 incl=false cache=false}$intx"]};
GeoNode.solrBackend=app.solrUrl;var a=new GeoNode.Solr;a.enableHeatmap();GeoNode.solr=a})});Ext.namespace("GeoNode");var heatmapParams={facet:"true","facet.heatmap":"bbox","facet.heatmap.format":"ints2D","facet.heatmap.distErrPct":"0.05",fq:["area:[0 TO 400]","!(area:1 AND max_x:0 AND max_y:0)"],"facet.heatmap.geom":"",rows:0};
GeoNode.HeatmapModel=Ext.extend(Ext.util.Observable,{radiusAdjust:1.1,global_layers:0,constructor:function(a){var b=this;Ext.apply(this,a);this.addEvents({fireSearch:!0});this.addListener("fireSearch",function(a){this.handleHeatmap();a&&this.searchTable.doSearch()});var c=this.bbox_widget.viewer.mapPanel.map;this.bbox_widget.viewer.mapPanel.map.events.register("moveend","",function(){2<c.layers.length&&b.fireEvent("fireSearch",!0)});this.bbox_widget.viewer.mapPanel.map.events.register("addlayer",
"",function(){2===c.layers.length&&b.fireEvent("fireSearch",!0)});this.bbox_widget.viewer.mapPanel.map.events.register("mousemove",this.bbox_widget.viewer.mapPanel.map,function(a){b.processEvent(a)},!0);this.WGS84ToMercator=this.bbox_widget.WGS84ToMercator;Ext.QuickTips.init();this.tooltip=new Ext.ToolTip({html:"test",cls:"ogp-tooltip",hideDelay:0,showDelay:0,width:80})},handleHeatmap:function(){this.deleteHeatmapLayer();this.makeHeatmapLayer()},setQueryParameters:function(){var a=this.bbox_widget.viewer.mapPanel.map.getExtent(),
b=a.getCenterLonLat().transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));if(a)a=a.transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326")),a={minX:a.left,maxX:a.right,minY:a.bottom,maxY:a.top},GeoNode.solr.center={centerX:b.lat,centerY:b.lon},b=GeoNode.solr.getOgpSpatialQueryParams(a),GeoNode.queryTerms.intx=b.intx,GeoNode.queryTerms.bf=b.bf,heatmapParams["facet.heatmap.geom"]=b["facet.heatmap.geom"]},initHeatmapLayer:function(){return new Heatmap.Layer("Heatmap")},
makeHeatmapLayer:function(){var a=this;this.setQueryParameters();var b=$.extend({},GeoNode.queryTerms,heatmapParams);b.fq=$.merge([],GeoNode.queryTerms.fq);$.merge(b.fq,heatmapParams.fq);$.ajax({url:GeoNode.solrBackend,jsonp:"json.wrf",dataType:"jsonp",data:$.param(b,!0),success:function(b){b=b.facet_counts;if(null!=b)b=b.facet_heatmaps.bbox,a.heatmapObject=b,a.drawHeatmapOpenLayers(b)}})},drawHeatmapOpenLayers:function(a){var b=this.bbox_widget.viewer.mapPanel.map;if(!this.heatmapLayer)this.heatmapLayer=
this.initHeatmapLayer();this.heatmapLayer.points=[];var c=a[15];if(null!=c){var d=a[5],e=a[3],f=this.heatmapMinMax(c,d,e)[1];if(-1!=f){var g=a[11],h=a[7],j=(a[13]-g)/d,a=(a[9]-h)/e,i=this.getClassifications(c);this.heatmapLayer.setGradientStops(this.getColorGradient(i,f));for(var k=0;k<d;k++)for(var l=0;l<e;l++)try{var m=c[c.length-k-1][l],n=h+l*a+0.5*a,o=g+k*j+0.5*j,p=this.computeRadius(o,n,j,a),q=this.WGS84ToMercator(n,o),r=this.rescaleHeatmapValue(m,i[1],f),s=this.getRadiusFactor();0<m&&this.heatmapLayer.addSource(new Heatmap.Source(q,
p*s*this.radiusAdjust,r))}catch(t){console.log("error making heatmap: "+t)}this.heatmapLayer.setOpacity(0.5);0===b.getLayersByName("Heatmap").length?(b.addLayer(this.heatmapLayer),b.setLayerIndex(this.heatmapLayer,2)):this.heatmapLayer.redraw()}}},getRadiusFactor:function(){var a=[1.6,1.5,2.6,2.4,2.2,1.8,2,2,2],b=this.bbox_widget.viewer.mapPanel.map.getZoom();if(1>b)return 1;b-=1;return b>a.length-1?a[a.length-1]:a[b]},heatmapMinMax:function(a,b,c){for(var d=-1,e=Number.MAX_VALUE,f=0;f<b;f++){var g=
a[f];null==g&&(a[f]=g=[]);for(var h=0;h<c;h++)null==g[h]&&(g[h]=-1),g[h]>d&&(d=g[h]),g[h]<e&&-1<g[h]&&(e=g[h])}return[e,d]},deleteHeatmapLayer:function(){var a=this.bbox_widget.viewer.mapPanel.map,b=a.getLayersByName("Heatmap");if(0<b.length)for(var c=0;c<b.length;c++)a.removeLayer(b[c])},flattenValues:function(a){for(var b=[],c=0;c<a.length;c++)b.push.apply(b,a[c]);return b},getClassifications:function(a){for(var a=this.flattenValues(a),a=(new geostats(a)).getClassJenks(this.getColors().length),
b=0;b<a.length;b++)0>a[b]&&(a[b]=0);return this.cleanupClassifications(a)},cleanupClassifications:function(a){var b=a.lastIndexOf(0);return-1==b?a:a=a.slice(b,a.length)},getColors:function(){return[0,57343,15728383,16728831,4276891903,4284416255,4278190335]},getColorGradient:function(a,b){var c=this.getColors(),d={},e=a.length;8==a.length&&(e-=1);for(var f=0;f<e;f++){var g=this.rescaleHeatmapValue(a[f],a[0],b);0>g&&(g=0);d[g]=c[f]}return d},rescaleHeatmapValue:function(a,b,c){return null==a?0:-1==
a?-1:0==a?0:1*a/c},computeRadius:function(a,b,c,d){var e=this.bbox_widget.viewer.mapPanel.map.getPixelFromLonLat(this.WGS84ToMercator(b,a)),b=this.bbox_widget.viewer.mapPanel.map.getPixelFromLonLat(this.WGS84ToMercator(b+d,a+c)),a=Math.abs(e.x-b.x),e=Math.abs(e.y-b.y),e=Math.max(a,e);return Math.ceil(e/2)},getCountGeodetic:function(a,b,c){if(a&&a[15]){var d=a[15],e=a[11],f=a[7],b=Math.floor((b-e)/((a[13]-e)/d.length)),a=Math.floor((c-f)/((a[9]-f)/d[0].length));0>b&&(b=0);0>a&&(a=0);try{return d[d.length-
b-1][a]}catch(g){return d[0][0]}}},processEvent:function(a){var a=this.bbox_widget.viewer.mapPanel.map.getLonLatFromViewPortPx(a.xy),b=new OpenLayers.Projection("EPSG:4326"),c=new OpenLayers.Projection("EPSG:900913"),a=a.transform(c,b),a=this.getCountGeodetic(this.heatmapObject,a.lat,a.lon)+this.global_layers;0>a&&(a=0);a+=" layers";this.tooltip.initTarget("ge_searchWindow");this.tooltip.show();this.tooltip.body.dom.innerHTML=a}});Ext.namespace("GeoNode");
GeoNode.SearchTable=Ext.extend(Ext.util.Observable,{selectHeaderText:"UT: Select",nameHeaderText:"UT: Name",titleHeaderText:"UT: Title",selectText:"UT: Select:",selectAllText:"UT: All",selectNoneText:"UT: None",previousText:"UT: Prev",nextText:"UT: Next",ofText:"UT: of",noResultsText:"UT: Your search did not match any items.",searchLabelText:"UT: Search Data",searchButtonText:"UT: Search",showingText:"UT: Showing",loadingText:"UT: Loading",permalinkText:"UT: permalink",unviewableTooltip:"UT: Unviewable Data",
remoteTooltip:"UT: Remote Data",invalidQueryText:"Invalid Query",searchTermRequired:"You need to specify a search term",searchOnLoad:!1,linkableTitle:!0,constructor:function(a){this.addEvents("load");Ext.apply(this,a);this.initFromQuery();this.loadData()},loadData:function(){this.searchStore=new Ext.data.JsonStore({url:this.searchURL,root:"rows",idProperty:"uuid",remoteSort:!0,totalProperty:"total",fields:[{name:"name",type:"string"},{name:"title",type:"string"},{name:"uuid",type:"string"},{name:"abstract",
type:"string"},{name:"keywords"},{name:"detail",type:"string"},{name:"attribution"},{name:"download_links"},{name:"metadata_links"},{name:"bbox"},{name:"_local"},{name:"_permissions"}]});this.searchStore.on("load",function(){this.updateControls();this.dataCart&&this.dataCart.reselect();this.fireEvent("load",this)},this);this.doLayout();this.searchOnLoad&&this.doSearch()},initFromQuery:function(){if(!this.searchParams)this.searchParams={};if(!this.searchParams.start)this.searchParams.start=0;if(!this.searchParams.limit)this.searchParams.limit=
25;if(this.constraints)for(var a=0;a<this.constraints.length;a++)this.constraints[a].initFromQuery(this,this.searchParams)},doSearch:function(){if(this.queryInput.getValue()){this.searchParams.start=0;if(this.constraints)for(var a=0;a<this.constraints.length;a++)this.constraints[a].applyConstraint(this.searchParams);this._search(this.searchParams)}else Ext.Msg.alert(this.invalidQueryText,this.searchTermRequired)},_search:function(a){this.disableControls();this.pagerLabel.setText(this.loadingText);
this.searchStore.load({params:a});this.updatePermalink(a)},loadNextBatch:function(){this.searchParams.start+=this.searchParams.limit;this._search(this.searchParams)},loadPrevBatch:function(){this.searchParams.start-=this.searchParams.limit;if(0>this.searchParams.start)this.searchParams.start=0;this._search(this.searchParams)},disableControls:function(){this.nextButton.setDisabled(!0);this.prevButton.setDisabled(!0)},updateControls:function(){var a=this.searchStore.getTotalCount();0<this.searchParams.start?
this.prevButton.setDisabled(!1):this.prevButton.setDisabled(!0);this.searchParams.start+this.searchParams.limit<a?this.nextButton.setDisabled(!1):this.nextButton.setDisabled(!0);var b=this.searchParams.start+1,c=b+this.searchParams.limit-1;b>a&&(b=a);c>a&&(c=a);this.pagerLabel.setText(this.showingText+" "+b+"-"+c+" "+this.ofText+" "+a)},updatePermalink:function(){if(this.permalink)this.permalink.href=Ext.urlAppend(this.permalinkURL,Ext.urlEncode(this.searchParams))},updateQuery:function(){this.searchParams.q=
this.queryInput.getValue();this.doSearch()},hookupSearchButtons:function(a){for(var a=Ext.get(a).query(".search-button"),b=0;b<a.length;b++){var c=a[b].innerHTML||this.searchButtonText;Ext.get(a[b]).update("");(new Ext.Button({text:c,renderTo:a[b]})).on("click",this.doSearch,this)}},doLayout:function(){var a=Ext.get(this.renderTo);a.update('<div class="search-input"></div><div class="search-carajo"<div class="search-table" ></div><div class="search-controls"></div></div>');var b=a.query(".search-input")[0],
c=a.query(".search-table")[0],a=a.query(".search-controls")[0],d=new GeoNode.SearchTableRowExpander({fetchURL:this.layerDetailURL});tableCfg={store:this.searchStore,plugins:[d],autoExpandColumn:"title",viewConfig:{autoFill:!0,forceFit:!0,emptyText:this.noResultsText},autoHeight:!0,renderTo:c};var e=this.unviewableTooltip,f=this.remoteTooltip,c=[d,{header:this.titleHeaderText,dataIndex:"title",id:"title",sortable:!0,renderer:function(a,b,c){var b=c.get("_local"),d=c.get("detail");b&&!0!=c.get("_permissions").view&&
(d="");return d?'<a href="'+d+'">'+a+"</a>":a}},{dataIndex:"_local",id:"layer_info",width:6,resizable:!1,renderer:function(a,b,c){b=a="";c.get("_local")?!0!=c.get("_permissions").view?(detail="",a="unviewable-layer",b=e):a="info-layer":(a="remote-layer",b=f);return info='<span class="'+a+'" title="'+b+'"></span>'}}];if(!0==this.trackSelection)sm=new Ext.grid.CheckboxSelectionModel({checkOnly:!0,renderer:function(a,b,c){return!0!=c.get("_permissions").view?"<div>&#160;</div>":'<div class="x-grid3-row-checker">&#160;</div>'},
listeners:{beforerowselect:function(a,b,c,d){if(!0!=d.get("_permissions").view)return!1}}}),this.dataCart=new GeoNode.DataCartStore({selModel:sm}),c.push(sm),tableCfg.selModel=sm;c=new Ext.grid.ColumnModel({defaults:{sortable:!1,menuDisabled:!0},columns:c});tableCfg.colModel=c;this.table=new Ext.grid.GridPanel(tableCfg);this.queryInput=new Ext.form.TextField({fieldLabel:this.searchLabelText,name:"search",allowBlank:!1,width:350});this.queryInput.on("specialkey",function(a,b){b.getKey()==b.ENTER&&
this.updateQuery()},this);c=new Ext.Button({text:this.searchButtonText});c.on("click",this.updateQuery,this);(new Ext.Panel({frame:!0,border:!0,width:"100%",layout:new Ext.layout.HBoxLayout({defaultMargins:{top:10,bottom:10,left:0,right:10}}),items:[this.queryInput,c]})).render(b);this.prevButton=new Ext.Button({text:this.previousText});this.prevButton.on("click",this.loadPrevBatch,this);this.nextButton=new Ext.Button({text:this.nextText});this.nextButton.on("click",this.loadNextBatch,this);this.pagerLabel=
new Ext.form.Label({text:""});(new Ext.Panel({frame:!1,border:!1,layout:new Ext.layout.HBoxLayout({defaultMargins:{top:10,bottom:10,left:0,right:10}}),items:[this.prevButton,this.nextButton,this.pagerLabel]})).render(a);this.permalink=Ext.query("a.permalink")[0];this.disableControls();this.searchParams.q&&this.queryInput.setValue(this.searchParams.q);this.updatePermalink()}});Ext.namespace("GeoNode");
GeoNode.MapSearchTable=Ext.extend(Ext.util.Observable,{autoExpandColumn:"title",titleHeaderText:"UT: Title",contactHeaderText:"UT: Contact",lastModifiedHeaderText:"UT: Last Modified",mapAbstractLabelText:"UT: Abstract",mapLinkLabelText:"UT:View this Map",previousText:"UT: Prev",nextText:"UT: Next",ofText:"UT: of",noResultsText:"UT: Your search did not match any items.",searchLabelText:"UT: Search Maps",searchButtonText:"UT: Search",showingText:"UT: Showing",loadingText:"UT: Loading",permalinkText:"UT: permalink",
constructor:function(a){this.addEvents("load");Ext.apply(this,a);this.initFromQuery();this.loadData()},loadData:function(){this.searchStore=new Ext.data.JsonStore({url:this.searchURL,root:"rows",idProperty:"name",remoteSort:!0,totalProperty:"total",fields:[{name:"id",mapping:"id"},{name:"title",type:"string"},{name:"abstract",type:"string"},{name:"detail",type:"string"},{name:"owner",type:"string"},{name:"owner_detail",type:"string"},{name:"last_modified",type:"string"}]});this.searchStore.on("load",
function(){this.updateControls();this.fireEvent("load",this)},this);this.doLayout();this.doSearch()},initFromQuery:function(){if(!this.searchParams)this.searchParams={};if(!this.searchParams.start)this.searchParams.start=0;if(!this.searchParams.limit)this.searchParams.limit=25;if(this.constraints)for(var a=0;a<this.constraints.length;a++)this.constraints[a].initFromQuery(this,this.searchParams)},doSearch:function(){this.searchParams.start=0;if(this.constraints)for(var a=0;a<this.constraints.length;a++)this.constraints[a].applyConstraint(this.searchParams);
this._search(this.searchParams)},_search:function(a){this.disableControls();this.searchStore.load({params:a});this.updatePermalink(a)},loadNextBatch:function(){this.searchParams.start+=this.searchParams.limit;this._search(this.searchParams)},loadPrevBatch:function(){this.searchParams.start-=this.searchParams.limit;if(0>this.searchParams.start)this.searchParams.start=0;this._search(this.searchParams)},disableControls:function(){this.nextButton.setDisabled(!0);this.prevButton.setDisabled(!0);this.pagerLabel.setText(this.loadingText)},
updateControls:function(){var a=this.searchStore.getTotalCount();0<this.searchParams.start?this.prevButton.setDisabled(!1):this.prevButton.setDisabled(!0);this.searchParams.start+this.searchParams.limit<a?this.nextButton.setDisabled(!1):this.nextButton.setDisabled(!0);var b=this.searchParams.start+1,c=b+this.searchParams.limit-1;c>a&&(c=a);this.pagerLabel.setText(this.showingText+" "+b+"-"+c+" "+this.ofText+" "+a)},updatePermalink:function(){if(this.permalink)this.permalink.href=Ext.urlAppend(this.permalinkURL,
Ext.urlEncode(this.searchParams))},updateQuery:function(){this.searchParams.q=this.queryInput.getValue();this.doSearch()},hookupSearchButtons:function(a){for(var a=Ext.get(a).query(".search-button"),b=0;b<a.length;b++){var c=a[b].innerHTML||this.searchButtonText;Ext.get(a[b]).update("");(new Ext.Button({text:c,renderTo:a[b]})).on("click",this.doSearch,this)}},doLayout:function(){var a=Ext.get(this.renderTo);a.update('<div class="search-results"><div class="search-input"></div><div class="search-table"></div><div class="search-controls"></div></div>');
var b=a.query(".search-input")[0],c=a.query(".search-table")[0],a=a.query(".search-controls")[0],d=new GeoNode.MapSearchTableRowExpander({fetchURL:this.mapDetailURL});tableCfg={store:this.searchStore,plugins:[d],autoExpandColumn:"title",viewConfig:{autoFill:!0,forceFit:!0,emptyText:this.noResultsText,listeners:{refresh:function(a){Ext.select("a",Ext.get(a.mainBody)).on("click",function(a){a.stopPropagation()})},rowsinserted:function(a,b,c){for(;b<c;b++)Ext.select("a",Ext.get(a.getRow(b))).on("click",
function(a){a.stopPropagation()})},rowupdated:function(a,b){Ext.select("a",Ext.get(a.getRow(b))).on("click",function(a){a.stopPropagation()})}}},autoHeight:!0,renderTo:c,listeners:{rowdblclick:function(a,b){var c=a.store.getAt(b);if(null!=c)location.href=c.get("detail")},rowclick:function(a,b){d.toggleRow(b)},beforerender:function(a){a.on("render",function(){a.getView().mainBody.un("mousedown",d.onMouseDown,d)})}}};c=new Ext.grid.ColumnModel({defaults:{menuDisabled:!0,sortable:!0},columns:[d,{header:this.titleHeaderText,
dataIndex:"title",id:"title",renderer:function(a,b,c){return(b=c.get("detail"))?'<a href="'+b+'">'+a+"</a>":a}},{header:this.contactHeaderText,dataIndex:"owner",id:"owner",renderer:function(a,b,c){return(b=c.get("owner_detail"))?'<a href="'+b+'">'+a+"</a>":a}},{header:this.lastModifiedHeaderText,dataIndex:"last_modified",id:"last_modified",renderer:function(a){dt=Date.parseDate(a,"c");return dt.format("F j, Y")}}]});tableCfg.colModel=c;this.table=new Ext.grid.GridPanel(tableCfg);this.queryInput=new Ext.form.TextField({fieldLabel:this.searchLabelText,
name:"search",allowBlank:!0,width:350});this.queryInput.on("specialkey",function(a,b){b.getKey()==b.ENTER&&this.updateQuery()},this);c=new Ext.Button({text:this.searchButtonText});c.on("click",this.updateQuery,this);(new Ext.Panel({frame:!1,border:!1,layout:new Ext.layout.HBoxLayout({defaultMargins:{top:10,bottom:10,left:0,right:10}}),items:[this.queryInput,c]})).render(b);this.prevButton=new Ext.Button({text:this.previousText});this.prevButton.on("click",this.loadPrevBatch,this);this.nextButton=
new Ext.Button({text:this.nextText});this.nextButton.on("click",this.loadNextBatch,this);this.pagerLabel=new Ext.form.Label({text:""});(new Ext.Panel({frame:!1,border:!1,layout:new Ext.layout.HBoxLayout({defaultMargins:{top:10,bottom:10,left:0,right:10}}),items:[this.prevButton,this.nextButton,this.pagerLabel]})).render(a);this.permalink=Ext.query("a.permalink")[0];this.disableControls();this.searchParams.q&&this.queryInput.setValue(this.searchParams.q);this.updatePermalink()}});Ext.namespace("GeoNode");
GeoNode.UserEmailSelector=Ext.extend(Ext.util.Observable,{constructor:function(a){Ext.apply(this,a);this.initUserStore();this.panel=this.doLayout()},initUserStore:function(){if(!this.userstore){var a={proxy:new Ext.data.HttpProxy({url:this.userLookup,method:"POST"}),reader:new Ext.data.JsonReader({root:"users",totalProperty:"count",fields:[{name:"email"},{name:"user"}]})};Ext.apply(a,this.availableUserConfig||{});this.userstore=new Ext.data.Store(a);this.userstore.load({params:{query:""}})}if(!this.store)this.store=
new Ext.data.ArrayStore({idIndex:0,fields:["email","user"],data:[]})},doLayout:function(){function a(){var a=this.availableUsers.getValue(),b=this.availableUsers.getValue(),c=this.userstore.findExact("email",a);-1<c&&(b=this.userstore.getAt(c).get("user"));-1==this.selectedUsers.store.findExact("email",a)&&this.selectedUsers.store.add(new (Ext.data.Record.create(["email","user"]))({email:a,user:b}))}var b=this.owner,c=function(){function a(){f.getEl().on("mousedown",c,this,{delegate:"button"})}function c(a,
d){var e=f.findItemFromChild(d),i=f.indexOf(e);f.store.getAt(i).get("email")!==b&&f.store.removeAt(f.indexOf(e))}var f;return{init:function(b){f=b;f.on("render",a)}}}();this.selectedUsers=new Ext.DataView({store:this.store,itemSelector:"div.user_item",tpl:new Ext.XTemplate('<div><tpl for="."> <div class="x-btn user_item"><button class="icon-removeuser remove-button">&nbsp;</button>{user}</div></tpl></div>'),plugins:[c],autoHeight:!0,multiSelect:!0});this.addButton=new Ext.Button({iconCls:"icon-adduser",
handler:a,scope:this});this.availableUsers=new Ext.form.ComboBox({width:180,store:this.userstore,typeAhead:!0,minChars:0,align:"right",border:"false",displayField:"user",valueField:"email",emptyText:gettext("Add user..."),listeners:{scope:this,select:a}});return new Ext.Panel({border:!1,renderTo:this.renderTo,items:[this.selectedUsers,{layout:"hbox",border:!1,items:[this.addButton,this.availableUsers]}]})},setDisabled:function(a){this.selectedUsers.setDisabled(a);this.availableUsers.setDisabled(a);
this.addButton.setDisabled(a)}});Ext.namespace("GeoNode");
GeoNode.WorldMapPermissionsEditor=Ext.extend(Ext.util.Observable,{viewMode:"EDITORS",customGroup:"",editMode:"LIST",editors:null,editorChooser:null,managers:null,managerChooser:null,levels:{admin:"layer_admin",readwrite:"layer_readwrite",readonly:"layer_readonly",none:"_none"},constructor:function(a){Ext.apply(this,a);this.addEvents({updated:!0});GeoNode.WorldMapPermissionsEditor.superclass.constructor.call(this,a);this.initStores();this.readPermissions(a.permissions);this.doLayout()},initStores:function(){var a=
function(a){return function(){return a.fireEvent("updated",a)}}(this);this.editors=new Ext.data.Store({reader:new Ext.data.JsonReader({root:"users",totalProperty:"count",fields:[{name:"email"},{name:"user"}]}),listeners:{add:a,remove:a,update:a}});this.managers=new Ext.data.Store({reader:new Ext.data.JsonReader({root:"users",totalProperty:"count",fields:[{name:"email"},{name:"user"}]}),listeners:{add:a,remove:a,update:a}})},buildUserChooser:function(a){var b={owner:this.permissions.owner_email,userLookup:this.userLookup};
Ext.apply(b,a);return new GeoNode.UserEmailSelector(b)},buildViewPermissionChooser:function(){var a=[{xtype:"radio",name:"viewmode",inputValue:"ANYONE",boxLabel:gettext("Anyone")},{xtype:"radio",name:"viewmode",inputValue:"REGISTERED",boxLabel:gettext("Any registered user")}];this.customGroup&&a.push({xtype:"radio",name:"viewmode",inputValue:"CUSTOM",boxLabel:this.customGroup});a.push({xtype:"radio",name:"viewmode",inputValue:"EDITORS",boxLabel:gettext("Only users who can edit")});return new Ext.Panel({border:!1,
items:[{html:"<strong>"+gettext("Who can view or download this?")+"</strong>",flex:1,border:!1},{xtype:"radiogroup",columns:1,value:this.viewMode,items:a,listeners:{change:function(a,c){if(null!=c)this.viewMode=c.inputValue,this.fireEvent("updated",this)},scope:this}}]})},buildEditPermissionChooser:function(){this.editorChooser=this.buildUserChooser({store:this.editors,availableUserConfig:{listeners:{load:function(a){a.filterBy(function(a){return-1==this.editors.findExact("email",a.get("email"))&&
-1==this.managers.findExact("email",a.get("email"))},this)},scope:this}}});this.editorChooser.setDisabled("LIST"!==this.editMode);var a=[{xtype:"radio",name:"editmode",inputValue:"REGISTERED",boxLabel:gettext("Any registered user")}];this.customGroup&&a.push({xtype:"radio",name:"editmode",inputValue:"CUSTOM",boxLabel:this.customGroup});a.push({xtype:"radio",name:"editmode",inputValue:"LIST",boxLabel:gettext("Only users who can edit")});return new Ext.Panel({border:!1,items:[{html:"<strong>"+gettext("Who can edit this?")+
"</strong>",flex:1,border:!1},{xtype:"radiogroup",columns:1,value:this.editMode,items:a,listeners:{change:function(a,c){if(null!=c)this.editMode=c.inputValue,this.editorChooser.setDisabled("LIST"!==this.editMode),this.fireEvent("updated",this)},scope:this}},this.editorChooser.panel]})},buildManagePermissionChooser:function(){this.managerChooser=this.buildUserChooser({store:this.managers,availableUserConfig:{listeners:{load:function(a){a.filterBy(function(a){return-1==this.editors.findExact("email",
a.get("email"))&&-1==this.managers.findExact("email",a.get("email"))},this)},scope:this}}});return new Ext.Panel({border:!1,items:[{html:"<strong>"+gettext("Who can manage and edit this?")+"</strong>",flex:1,border:!1},this.managerChooser.panel]})},readPermissions:function(a){this.editors.suspendEvents();this.managers.suspendEvents();this.editMode=a.authenticated==this.levels.readwrite?"REGISTERED":a.customgroup==this.levels.readwrite?"CUSTOM":"LIST";if(a.anonymous==this.levels.readonly)this.viewMode=
"ANYONE";else if(a.authenticated==this.levels.readonly)this.viewMode="REGISTERED";else if(a.customgroup==this.levels.readonly)this.viewMode="CUSTOM";for(var b=0;b<a.users.length;b++)a.users[b][1]===this.levels.readwrite?this.editors.add(new this.editors.recordType({email:a.users[b][0],user:a.names[b][1]},b+500)):a.users[b][1]===this.levels.admin&&this.managers.add(new this.managers.recordType({email:a.users[b][0],user:a.names[b][1]},b+500));this.editors.resumeEvents();this.managers.resumeEvents()},
writePermissions:function(){var a,b,c,d;a="ANYONE"===this.viewMode?this.levels.readonly:this.levels.none;"CUSTOM"===this.editMode?(c=this.levels.readwrite,b="CUSTOM"===this.viewMode?this.levels.none:"REGISTERED"===this.viewMode?this.levels.readonly:this.levels.none):"CUSTOM"===this.viewMode?(c=this.levels.readonly,b=this.levels.none):c="REGISTERED"===this.editMode?b=this.levels.readwrite:"REGISTERED"===this.viewMode?b=this.levels.readonly:b=this.levels.none;d=[];"LIST"===this.editMode&&this.editors.each(function(a){d.push([a.get("email"),
this.levels.readwrite])},this);this.managers.each(function(a){d.push([a.get("email"),this.levels.admin])},this);return{anonymous:a,authenticated:b,customgroup:c,users:d}},doLayout:function(){this.container=new Ext.Panel({renderTo:this.renderTo,border:!1,items:[this.buildViewPermissionChooser(),this.buildEditPermissionChooser(),this.buildManagePermissionChooser()]})}});
Lang={registerLinks:function(){var a={"#spanish":"es","#english":"en"},b;for(b in a){var c=Ext.DomQuery.selectNode(b);if(c)c.onclick=function(a){return function(){(new Ext.state.CookieProvider).set("locale",a);window.location.reload();return!1}}(a[b])}}};Ext.onReady(Lang.registerLinks);Ext.namespace("GeoNode");
GeoNode.BatchDownloadWidget=Ext.extend(Ext.util.Observable,{downloadingText:"UT: Downloading...",cancelText:"UT: Cancel",windowMessageText:"UT: Please wait",constructor:function(a){Ext.apply(this,a);this.beginDownload()},beginDownload:function(){var a=this;Ext.Ajax.request({url:this.begin_download_url,method:"POST",params:{layer:this.layers,format:this.format},success:function(b){b=Ext.util.JSON.decode(b.responseText);a.monitorDownload(b.id)}})},monitorDownload:function(a){var b,c=this,d=new Ext.ProgressBar({text:this.downloadingText}),
e=function(){Ext.Ajax.request({url:c.stop_download_url+a,method:"GET",success:function(){clearInterval(b)},failure:function(){clearInterval(b)}})},f=new Ext.Window({width:250,height:100,plain:!0,modal:!0,closable:!1,hideBorders:!0,items:[d],buttons:[{text:this.cancelText,handler:function(){e();f.hide()}}]});b=setInterval(function(){Ext.Ajax.request({url:c.begin_download_url+"?id="+a,method:"GET",success:function(e){e=Ext.util.JSON.decode(e.responseText);"FINISHED"===e.process.status?(clearInterval(b),
d.updateProgress(1,"Done....",!0),f.close(),location.href=c.download_url+a):d.updateProgress(e.process.progress/100,c.downloadingText,!0)},failure:function(){clearInterval(b);f.close()}})},1E3);f.show()}});Ext.namespace("GeoNode");
GeoNode.BoundingBoxWidget=Ext.extend(Ext.util.Observable,{viewerConfig:null,height:300,isEnabled:!1,useGxpViewer:!1,gwcBackend:this.hypermapRegistryUrl+"/registry/hypermap/layer/",layers:{},constructor:function(a){Ext.apply(this,a);this.doLayout()},doLayout:function(){var a=this,b={proxy:this.proxy,useCapabilities:!1,useBackgroundCapabilities:!1,useToolbar:!1,useMapOverlay:!1,portalConfig:{collapsed:!1,border:!1,height:this.height,renderTo:Ext.get(this.renderTo).query(".bbox-expand")[0]},listeners:{ready:function(){this._ready=
!0},scope:this,showBBox:function(b){a.showLayerBBox(b)},hideBBox:function(){a.hideLayerBBox()},showPreviewLayer:function(b,d){a.showPreviewLayer(b,d)},hidePreviewLayer:function(){a.hidePreviewLayer()},showLayer:function(b,d,e){a.showLayer(b,d,e)},hideLayer:function(b){a.hideLayer(b)},zoomToRecord:function(b){a.zoomToRecord(b)}}},b=Ext.apply(b,this.viewerConfig);this.useGxpViewer?(b.mapItems=[{xtype:"gx_zoomslider",vertical:!0,height:100}],this.viewer=new gxp.Viewer(b)):this.viewer=new GeoExplorer.Viewer(b)},
updateBBox:function(a){a&&null!=a&&this.viewer.mapPanel.map.zoomToExtent(a)},isActive:function(){return!0},hasConstraint:function(){return this.isActive()},applyConstraint:function(a){if(this.hasConstraint()){var b=this.viewer.mapPanel.map.getExtent();b.transform(new OpenLayers.Projection(this.viewerConfig.map.projection),new OpenLayers.Projection("EPSG:4326"));a.bbox=b.toBBOX()}else this._ready&&delete a.bbox},initFromQuery:function(a,b){if(b.bbox){var c=OpenLayers.Bounds.fromString(b.bbox);if(c){c.transform(new OpenLayers.Projection("EPSG:4326"),
new OpenLayers.Projection(this.viewerConfig.map.projection));var d=function(){var a=this.viewer.mapPanel.map;a.events.register("moveend",this,function(){a.events.unregister("moveend",this,arguments.callee);a.zoomToExtent(c,!0)})};if(this._ready)d.call(this);else this.viewer.on("ready",d,this)}}},createBBoxLayer:function(){var a=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);a.strokeColor="#1D6EEF";a.fillColor="#DAEDFF";a.fillOpacity=0.25;a.pointRadius=10;a.strokeWidth=4;a.strokeLinecap=
"butt";a.zIndex=999;return new OpenLayers.Layer.Vector("layerBBox",{style:a,displayOutsideMaxExtent:!0})},showLayerBBox:function(a){var b=this.viewer.mapPanel.map,c=b.getLayersByName("layerBBox");0<c.length?(c=c[0],this.hideLayerBBox()):(c=this.createBBoxLayer(),b.addLayer(c));var d=this.WGS84ToMercator(a.west,a.south),a=this.WGS84ToMercator(a.east,a.north),e=b.getPixelFromLonLat(d),f=b.getPixelFromLonLat(a),b=!1;10>=e.distanceTo(f)&&(b=!0);e=[];if(d.lon>a.lon){var g=this.WGS84ToMercator(180,0).lon,
f=(new OpenLayers.Bounds(d.lon,d.lat,g,a.lat)).toGeometry(),d=(new OpenLayers.Bounds(a.lon,a.lat,-1*g,d.lat)).toGeometry();e.push(new OpenLayers.Feature.Vector(f));e.push(new OpenLayers.Feature.Vector(d));b&&e.push(new OpenLayers.Feature.Vector(f.getCentroid()))}else d=(new OpenLayers.Bounds(d.lon,d.lat,a.lon,a.lat)).toGeometry(),a=new OpenLayers.Feature.Vector(d),e.push(a),b&&e.push(new OpenLayers.Feature.Vector(d.getCentroid()));c.addFeatures(e);c=this.getVisibleExtent();this.getGeodeticExtent();
b=c.left;b=c.right;if(this.hasMultipleWorlds())c.left=-20037510,c.Right=20037510},hideLayerBBox:function(){var a=this.viewer.mapPanel.map;0<a.getLayersByName("layerBBox").length&&a.getLayersByName("layerBBox")[0].removeAllFeatures()},WGS84ToMercator:function(a,b){var c=parseFloat(b),d=parseFloat(a);90<=c&&(c=89.99);-90>=c&&(c=-89.99);180<=d&&(d=179.99);-180>=d&&(d=-179.99);return OpenLayers.Layer.SphericalMercator.forwardMercator(d,c)},getVisibleExtent:function(){var a=this.viewer.mapPanel.map,b=
a.getLonLatFromViewPortPx(this.getMapOffset()),a=a.getExtent();a.top=b.lat;4.007501568E7<=a.getWidth()?(a.left=-2.003750834E7,a.right=2.003750834E7):a.left=b.lon;return a},getGeodeticExtent:function(){var a=this.getVisibleExtent(),b=new OpenLayers.Projection("EPSG:3857"),c=new OpenLayers.Projection("EPSG:4326");return a.transform(b,c)},getMapOffset:function(){var a=this.viewer.mapPanel.getId(),a=jQuery("#"+a).offset().top;return new OpenLayers.Pixel(0,a)},hasMultipleWorlds:function(){var a=this.viewer.mapPanel.map,
b=a.getZoom()+8,b=Math.pow(2,b);return a.getSize().w-this.getMapOffset().x>b?!0:!1},showPreviewLayer:function(a,b){if(b){var c=this.viewer.mapPanel.map,d=this.createPreviewLayer(a,b);c.addLayer(d)}},hidePreviewLayer:function(){for(var a=this.viewer.mapPanel.map,b=0;b<a.layers.length;b++)a.layers[b].preview&&a.removeLayer(a.layers[b])},createPreviewLayer:function(a,b){var c=new OpenLayers.Layer.OSM(a,this.viewer.hypermapRegistryUrl+"/registry/hypermap/layer/"+b+"/map/wmts/"+a.replace("geonode:","")+
"/default_grid/${z}/${x}/${y}.png",{isBaseLayer:!1});c.preview=!0;return c},getOrCreateLayer:function(a,b,c){this.layers.hasOwnProperty(a)||(b=new OpenLayers.Layer.OSM(a,this.viewer.hypermapRegistryUrl+"/registry/hypermap/layer/"+c+"/map/wmts/"+a.replace("geonode:","")+"/default_grid/${z}/${x}/${y}.png",{isBaseLayer:!1}),this.layers[a]=b);return this.layers[a]},showLayer:function(a,b,c){var d=this.viewer.mapPanel.map,a=this.getOrCreateLayer(a,b,c);d.addLayer(a)},hideLayer:function(a){var b=this.viewer.mapPanel.map,
a=this.getOrCreateLayer(a);b.removeLayer(a)},zoomToRecord:function(a){var b=this.viewer.mapPanel.map,a=new OpenLayers.Bounds([a.get("MinX"),a.get("MinY"),a.get("MaxX"),a.get("MaxY")]);a.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection(this.viewerConfig.map.projection));b.zoomToExtent(a,!0)}});Ext.namespace("GeoNode");
GeoNode.DataCart=Ext.extend(Ext.util.Observable,{selectedLayersText:"UT: Selected Layers",emptySelectionText:"UT: No Layers Selected",titleText:"UT: Title",clearSelectedButtonText:"UT: Clear Selected",clearAllButtonText:"UT: Clear All",addLayersButtonText:"UT: Add Layers",addToMapButtonFunction:null,addToMapButtonTarget:null,constructor:function(a){Ext.apply(this,a);this.doLayout()},getSelectedLayerIds:function(){var a=[];this.grid.selModel.each(function(b){a.push(b.get("name"))});return a},doLayout:function(){var a=
Ext.get(this.renderTo);a.update('<div class="selection-table"></div><div class="selection-controls"></div><div class="selection-ops></div>"');var b=a.query(".selection-controls")[0],c=a.query(".selection-table")[0];a.query(".selection-ops");var d=this,e=new Ext.grid.RowSelectionModel({listeners:{rowdeselect:function(a,b){d.store.removeAt(b);d.store.reselect()}}});e.handleMouseDown=function(a,b){var c=this.grid.getView();this.isSelected(b)?this.deselectRow(b):(this.selectRow(b,!0),c.focusRow(b))};
this.grid=new Ext.grid.GridPanel({store:this.store,viewConfig:{autoFill:!0,forceFit:!0,emptyText:this.emptySelectionText,deferEmptyText:!1},height:100,renderTo:c,selModel:e,hideHeaders:!0,colModel:new Ext.grid.ColumnModel({defaults:{sortable:!1,menuDisabled:!0},columns:[{dataIndex:"title"}]})});this.store.on("add",function(a,b,c){e.selectRow(c,!0)});var a=new Ext.Button({text:this.addLayersButtonText,iconCls:"prominent-btn",cls:"x-btn-link-medium x-btn-text"}),f=function(){this.store.removeAll();
this.store.reselect()};if(this.addToMapButtonFunction){var g=this.addToMapButtonFunction,h=this.addToMapButtonTarget,j=this.grid,i=this;a.on("click",function(){var a=j.getSelectionModel().getSelections();g.call(h,a);f.call(i)})}c=new Ext.Button({text:this.clearSelectedButtonText,iconCls:"not-prominent-btn"});c.on("click",function(){e.each(function(a){a=this.store.indexOfId(a.id);0<=a&&this.store.removeAt(a)},this);this.store.reselect()},this);(new Ext.Button({text:this.clearAllButtonText})).on("click",
f,this);new Ext.Spacer({width:20});c=new Ext.Panel({frame:!1,border:!1,layout:new Ext.layout.HBoxLayout({defaultMargins:{top:10,bottom:10,left:0,right:0}}),items:[c]});this.addToMapButtonFunction&&c.items.insert(1,a);c.render(b)}});Ext.namespace("GeoNode");
GeoNode.DataCartOps=Ext.extend(Ext.util.Observable,{failureText:"UT: Operation Failed",noLayersText:"UT: No layers are currently selected.",constructor:function(a){Ext.apply(this,a);this.doLayout()},doLayout:function(){var a=Ext.get(this.renderTo),b=Ext.get(a.query("a.create-map")[0]);this.createMapForm=Ext.get(a.query("#create_map_form")[0]);b.on("click",function(a){a.preventDefault();(a=this.cart.getSelectedLayerIds())&&a.length?this.createNewMap(a):Ext.MessageBox.alert(this.failureText,this.noLayersText)},
this);batch_links=a.query("a.batch-download");for(a=0;a<batch_links.length;a++)Ext.get(batch_links[a]).on("click",function(a,b){a.preventDefault();var e=this.cart.getSelectedLayerIds();if(e&&e.length){var f=Ext.get(b).getAttribute("href").substr(1);this.batchDownload(e,f)}else Ext.MessageBox.alert(this.failureText,this.noLayersText)},this)},createNewMap:function(a){for(var b=[],c=0;c<a.length;c++)b.push({tag:"input",type:"hidden",name:"layer",value:a[c]});b.push({tag:"input",type:"hidden",name:"csrfmiddlewaretoken",
value:Ext.util.Cookies.get("csrftoken")});Ext.DomHelper.overwrite(this.createMapForm,{tag:"div",cn:b});this.createMapForm.dom.submit()},batchDownload:function(a,b){new GeoNode.BatchDownloadWidget({layers:a,format:b,begin_download_url:this.begin_download_url,stop_download_url:this.stop_download_url,download_url:this.download_url})}});Ext.namespace("GeoNode");
GeoNode.DataCartStore=Ext.extend(Ext.data.Store,{constructor:function(a){this.selModel=a.selModel;this.reselecting=!1;this.selModel.on("rowselect",function(a,c,d){!0!=this.reselecting&&-1==this.indexOfId(d.id)&&this.add([d])},this);this.selModel.on("rowdeselect",function(a,c,d){!0!=this.reselecting&&(c=this.indexOfId(d.id),-1!=c&&this.removeAt(c))},this);GeoNode.DataCartStore.superclass.constructor.call(this,a)},reselect:function(){this.reselecting=!0;this.selModel.clearSelections();var a=this.selModel.grid.store;
this.each(function(b){b=a.indexOfId(b.id);-1!=b&&this.selModel.selectRow(b,!0);return!0},this);this.reselecting=!1}});Ext.namespace("GeoNode");
GeoNode.MapSearchTableRowExpander=Ext.extend(Ext.grid.RowExpander,{errorText:"UT: Unable to fetch map details.",loadingText:"UT: Loading...",constructor:function(a){this.fetchURL=a.fetchURL;GeoNode.SearchTableRowExpander.superclass.constructor.call(this,a)},getRowClass:function(a,b,c){c.cols-=1;return this.state[a.id]?"x-grid3-row-expanded":"x-grid3-row-collapsed"},fetchBodyContent:function(a,b,c){this.enableCaching||this._fetchBodyContent(a,b,c);var d=this.bodyContent[b.id];d?a.innerHTML=d:this._fetchBodyContent(a,
b,c)},_fetchBodyContent:function(a,b){a.innerHTML=this.loadingText;var c=this.fetchURL+"?mapid="+b.get("id"),d=this;Ext.Ajax.request({url:c,method:"GET",success:function(c){c=c.responseText;a.innerHTML=c;d.bodyContent[b.id]=c},failure:function(){a.innerHTML=d.errorText}})},beforeExpand:function(a,b,c){return!1!==this.fireEvent("beforeexpand",this,a,b,c)?(this.fetchBodyContent(b,a,c),!0):!1}});Ext.namespace("GeoNode");
GeoNode.PermissionsEditor=Ext.extend(Ext.util.Observable,{viewMode:"EDITORS",editMode:"LIST",editors:null,editorChooser:null,managers:null,managerChooser:null,levels:{admin:"layer_admin",readwrite:"layer_readwrite",readonly:"layer_readonly",none:"_none"},constructor:function(a){Ext.apply(this,a);this.addEvents({updated:!0});GeoNode.PermissionsEditor.superclass.constructor.call(this,a);this.initStores();this.readPermissions(a.permissions);this.doLayout()},initStores:function(){var a=function(a){return function(){return a.fireEvent("updated",
a)}}(this);this.editors=new Ext.data.Store({reader:new Ext.data.JsonReader({root:"users",totalProperty:"count",fields:[{name:"username"}]}),listeners:{add:a,remove:a,update:a}});this.managers=new Ext.data.Store({reader:new Ext.data.JsonReader({root:"users",totalProperty:"count",fields:[{name:"username"}]}),listeners:{add:a,remove:a,update:a}})},buildUserChooser:function(a){var b={owner:this.permissions.owner,userLookup:this.userLookup};Ext.apply(b,a);return new GeoNode.UserSelector(b)},buildViewPermissionChooser:function(){return new Ext.Panel({border:!1,
items:[{html:"<strong>"+gettext("Who can view and download this data?")+"</strong>",flex:1,border:!1},{xtype:"radiogroup",columns:1,value:this.viewMode,items:[{xtype:"radio",name:"viewmode",inputValue:"ANYONE",boxLabel:gettext("Anyone")},{xtype:"radio",name:"viewmode",inputValue:"REGISTERED",boxLabel:gettext("Any registered user")},{xtype:"radio",name:"viewmode",inputValue:"EDITORS",boxLabel:gettext("Only users who can edit")}],listeners:{change:function(a,b){this.viewMode=b.inputValue;this.fireEvent("updated",
this)},scope:this}}]})},buildEditPermissionChooser:function(){this.editorChooser=this.buildUserChooser({store:this.editors,availableUserConfig:{listeners:{load:function(a){a.filterBy(function(a){return-1==this.editors.findExact("username",a.get("username"))&&-1==this.managers.findExact("username",a.get("username"))},this)},scope:this}}});this.editorChooser.setDisabled("LIST"!==this.editMode);return new Ext.Panel({border:!1,items:[{html:"<strong>"+gettext("Who can edit this data?")+"</strong>",flex:1,
border:!1},{xtype:"radiogroup",columns:1,value:this.editMode,items:[{xtype:"radio",name:"editmode",inputValue:"REGISTERED",boxLabel:gettext("Any registered user")},{xtype:"radio",name:"editmode",inputValue:"LIST",boxLabel:gettext("Only the following users or groups:")}],listeners:{change:function(a,b){this.editMode=b.inputValue;this.editorChooser.setDisabled("LIST"!==this.editMode);this.fireEvent("updated",this)},scope:this}},this.editorChooser.panel]})},buildManagePermissionChooser:function(){this.managerChooser=
this.buildUserChooser({store:this.managers,availableUserConfig:{listeners:{load:function(a){a.filterBy(function(a){return-1==this.editors.findExact("username",a.get("username"))&&-1==this.managers.findExact("username",a.get("username"))},this)},scope:this}}});return new Ext.Panel({border:!1,items:[{html:"<strong>"+gettext("Who can manage and edit this data?")+"</strong>",flex:1,border:!1},this.managerChooser.panel]})},readPermissions:function(a){this.editors.suspendEvents();this.managers.suspendEvents();
if(a.authenticated==this.levels.readwrite)this.editMode="REGISTERED";else if(a.authenticated==this.levels.readonly)this.viewMode="REGISTERED";if(a.anonymous==this.levels.readonly)this.viewMode="ANYONE";for(var b=0;b<a.users.length;b++)a.users[b][1]===this.levels.readwrite?this.editors.add(new this.editors.recordType({username:a.users[b][0]},b+500)):a.users[b][1]===this.levels.admin&&this.managers.add(new this.managers.recordType({username:a.users[b][0]},b+500));this.editors.resumeEvents();this.managers.resumeEvents()},
writePermissions:function(){var a,b,c;a="ANYONE"===this.viewMode?this.levels.readonly:this.levels._none;b="REGISTERED"===this.editMode?this.levels.readwrite:"REGISTERED"===this.viewMode?this.levels.readonly:this.levels._none;c=[];"LIST"===this.editMode&&this.editors.each(function(a){c.push([a.get("username"),this.levels.readwrite])},this);this.managers.each(function(a){c.push([a.get("username"),this.levels.admin])},this);return{anonymous:a,authenticated:b,users:c}},doLayout:function(){this.container=
new Ext.Panel({renderTo:this.renderTo,border:!1,items:[this.buildViewPermissionChooser(),this.buildEditPermissionChooser(),this.buildManagePermissionChooser()]})}});Ext.namespace("GeoNode");
GeoNode.SearchTableRowExpander=Ext.extend(Ext.grid.RowExpander,{errorText:"UT: Unable to fetch layer details.",loadingText:"UT: Loading...",constructor:function(a){this.fetchURL=a.fetchURL;GeoNode.SearchTableRowExpander.superclass.constructor.call(this,a)},getRowClass:function(a,b,c){c.cols-=1;return this.state[a.id]?"x-grid3-row-expanded":"x-grid3-row-collapsed"},fetchBodyContent:function(a,b,c){this.enableCaching||this._fetchBodyContent(a,b,c);var d=this.bodyContent[b.id];d?a.innerHTML=d:this._fetchBodyContent(a,
b,c)},_fetchBodyContent:function(a,b){a.innerHTML=this.loadingText;var c=this.fetchURL+"?uuid="+b.get("uuid"),d=this;Ext.Ajax.request({url:c,method:"GET",success:function(c){c=c.responseText;a.innerHTML=c;d.bodyContent[b.id]=c},failure:function(){a.innerHTML=d.errorText}})},beforeExpand:function(a,b,c){return!1!==this.fireEvent("beforeexpand",this,a,b,c)?(this.fetchBodyContent(b,a,c),!0):!1}});Ext.namespace("GeoNode");
GeoNode.UserSelector=Ext.extend(Ext.util.Observable,{constructor:function(a){Ext.apply(this,a);this.initUserStore();this.panel=this.doLayout()},initUserStore:function(){if(!this.userstore){var a={proxy:new Ext.data.HttpProxy({url:this.userLookup,method:"POST"}),reader:new Ext.data.JsonReader({root:"users",totalProperty:"count",fields:[{name:"username"}]})};Ext.apply(a,this.availableUserConfig||{});this.userstore=new Ext.data.Store(a);this.userstore.load({params:{query:""}})}if(!this.store)this.store=
new Ext.data.ArrayStore({idIndex:0,fields:["username"],data:[]})},doLayout:function(){function a(){var a=this.availableUsers.getValue(),b=this.availableUsers.store.findExact("username",a);-1!=b&&-1==this.selectedUsers.store.findExact("username",a)&&(this.selectedUsers.store.add([this.availableUsers.store.getAt(b)]),this.availableUsers.reset())}var b=this.owner,c=function(){function a(){f.getEl().on("mousedown",c,this,{delegate:"button"})}function c(a,d){var e=f.findItemFromChild(d),i=f.indexOf(e);
f.store.getAt(i).get("username")!==b&&f.store.removeAt(f.indexOf(e))}var f;return{init:function(b){f=b;f.on("render",a)}}}();this.selectedUsers=new Ext.DataView({store:this.store,itemSelector:"div.user_item",tpl:new Ext.XTemplate('<div><tpl for="."> <div class="x-btn user_item"><button class="icon-removeuser remove-button">&nbsp;</button>{username}</div></tpl></div>'),plugins:[c],autoHeight:!0,multiSelect:!0});this.addButton=new Ext.Button({iconCls:"icon-adduser",handler:a,scope:this});this.availableUsers=
new Ext.form.ComboBox({width:180,store:this.userstore,typeAhead:!0,minChars:0,align:"right",border:"false",displayField:"username",emptyText:gettext("Add user..."),listeners:{scope:this,select:a}});return new Ext.Panel({border:!1,renderTo:this.renderTo,items:[this.selectedUsers,{layout:"hbox",border:!1,items:[this.addButton,this.availableUsers]}]})},setDisabled:function(a){this.selectedUsers.setDisabled(a);this.availableUsers.setDisabled(a);this.addButton.setDisabled(a)}});Ext.namespace("GeoNode");
GeoNode.SearchTable=Ext.extend(Ext.util.Observable,{selectHeaderText:"UT: Select",nameHeaderText:"UT: Name",titleHeaderText:"UT: Title",selectText:"UT: Select:",selectAllText:"UT: All",selectNoneText:"UT: None",previousText:"UT: Prev",nextText:"UT: Next",ofText:"UT: of",noResultsText:"UT: Your search did not match any items.",searchLabelText:"Keyword",searchButtonText:"UT: Search",showingText:"UT: Showing",loadingText:"UT: Loading",permalinkText:"UT: permalink",unviewableTooltip:"UT: Unviewable Data",
remoteTooltip:"UT: Remote Data",invalidQueryText:"Invalid Query",searchTermRequired:"You need to specify a search term",originatorSearchLabelText:"Source",dataTypeSearchLableText:"UT: Data Type",originatorText:"Source",dateHeaderText:"Date",fromyearHeaderText:"from year",toyearHeaderText:"to year",resetButtonText:"Reset",searchOnLoad:!1,linkableTitle:!0,constructor:function(a){this.addEvents("load");Ext.apply(this,a);this.initFromQuery();this.loadData();this.heatmap.searchTable=this},loadData:function(){var a=
this;this.searchStore=new Ext.data.JsonStore({url:this.searchURL,root:"response.docs",idProperty:"id",remoteSort:!0,totalProperty:"response.numFound",fields:[{name:"id",type:"string"},{name:"uuid",type:"string"},{name:"name",type:"string"},{name:"title",type:"string"},{name:"abstract",type:"string"},{name:"min_x",type:"string"},{name:"min_y",type:"string"},{name:"max_x",type:"string"},{name:"max_y",type:"string"},{name:"layer_originator",type:"string"},{name:"is_public",type:"string"},{name:"url",
type:"string"},{name:"service_type",type:"string"},{name:"bbox",type:"string"},{name:"location",type:"string"},{name:"layer_date",type:"string"},{name:"layer_datetype",type:"string"},{name:"srs",type:"string"},{name:"Availability",type:"string"},{name:"LayerUsername",type:"string"}]});this.searchStore.on("load",function(){this.updateControls();this.dataCart&&this.dataCart.reselect();this.fireEvent("load",this);var b=this.table.getView().getRows();$.each(b,function(b,d){var e=null;$(d).on("mouseover",
function(){e=setTimeout(function(){a.doMouseoverOn(b)},20)});$(d).on("mouseout",function(){(e|=0)&&a.doMouseoverOff(b);clearTimeout(e)})});$(".x-grid3-row").mouseleave(function(){$(".x-tip").hide();$(".x-shadow").hide()})},this);this.searchStore.on("beforeload",function(a,c){if(a.sortInfo)c.params.sort=c.params.sort+" "+a.sortInfo.direction});this.doLayout();this.searchOnLoad&&this.doSearch()},initFromQuery:function(){if(!GeoNode.queryTerms)GeoNode.queryTerms={};if(!GeoNode.queryTerms.start)GeoNode.queryTerms.start=
0;if(!GeoNode.queryTerms.rows)GeoNode.queryTerms.rows=200;if(this.constraints)for(var a=0;a<this.constraints.length;a++)this.constraints[a].initFromQuery(this,GeoNode.queryTerms)},doSearch:function(){this._search(GeoNode.queryTerms)},_search:function(a){this.disableControls();this.pagerLabel.setText(this.loadingText);this.searchStore.load({params:a});this.updatePermalink(a)},loadNextBatch:function(){GeoNode.queryTerms.start+=GeoNode.queryTerms.rows;this._search(GeoNode.queryTerms)},loadPrevBatch:function(){GeoNode.queryTerms.start-=
GeoNode.queryTerms.rows;if(0>GeoNode.queryTerms.start)GeoNode.queryTerms.start=0;this._search(GeoNode.queryTerms)},disableControls:function(){this.nextButton.setDisabled(!0);this.prevButton.setDisabled(!0)},updateControls:function(){var a=this.searchStore.getTotalCount();0<GeoNode.queryTerms.start?this.prevButton.setDisabled(!1):this.prevButton.setDisabled(!0);GeoNode.queryTerms.start+GeoNode.queryTerms.rows<a?this.nextButton.setDisabled(!1):this.nextButton.setDisabled(!0);var b=GeoNode.queryTerms.start+
1,c=b+GeoNode.queryTerms.rows-1;b>a&&(b=a);c>a&&(c=a);this.pagerLabel.setText(this.showingText+" "+b+"-"+c+" "+this.ofText+" "+a)},updatePermalink:function(){if(this.permalink)this.permalink.href=Ext.urlAppend(this.permalinkURL,Ext.urlEncode(GeoNode.queryTerms))},updateQuery:function(){GeoNode.queryTerms.q=this.queryInput.getValue();for(var a=0;a<GeoNode.queryTerms.fq.length;a++)-1<GeoNode.queryTerms.fq[a].indexOf("layer_originator")&&GeoNode.queryTerms.fq.splice(a,1);""!==this.originatorInput.getValue()&&
GeoNode.queryTerms.fq.push("layer_originator:*"+this.originatorInput.getValue()+"*");for(a=0;a<GeoNode.queryTerms.fq.length;a++)-1<GeoNode.queryTerms.fq[a].indexOf("service_type")&&GeoNode.queryTerms.fq.splice(a,1);a=this.dataTypeInput.getValue();""!==a&&GeoNode.queryTerms.fq.push(a);for(a=0;a<GeoNode.queryTerms.fq.length;a++)-1<GeoNode.queryTerms.fq[a].indexOf("layer_date")&&GeoNode.queryTerms.fq.splice(a,1);"[* TO *]"!=this.dateInput.getDateValues()&&GeoNode.queryTerms.fq.push("layer_date:"+this.dateInput.getDateValues());
if(""===this.queryInput.getValue())GeoNode.queryTerms.q="*";GeoNode.queryTerms.start=0;this.heatmap.fireEvent("fireSearch",!1);this.doSearch()},hookupSearchButtons:function(a){for(var a=Ext.get(a).query(".search-button"),b=0;b<a.length;b++){var c=a[b].innerHTML||this.searchButtonText;Ext.get(a[b]).update("");(new Ext.Button({text:c,renderTo:a[b]})).on("click",this.doSearch,this)}},doLayout:function(){function a(){var a=b.dateInput.valuesToTime();f.setValue(a[0]);g.setValue(a[1])}var b=this,c=Ext.get(this.renderTo);
c.update('<div class="search-results"><div class="search-input"></div><div class="search-table"></div><div class="search-controls"></div></div>');var d=c.query(".search-input")[0];c.query(".search-table");var c=Ext.get("search_controls"),e=new Ext.grid.RowSelectionModel({listeners:{rowselect:function(a,c,d){d.get("is_public")&&b.heatmap.bbox_widget.viewer.fireEvent("showLayer",b.getlayerTypename(d),b.getLayerID(d),b.getuuid(d))},rowdeselect:function(a,c,d){b.heatmap.bbox_widget.viewer.fireEvent("hideLayer",
b.getlayerTypename(d))}}});e.handleMouseDown=function(a,b){var c=this.grid.getView();this.isSelected(b)?this.deselectRow(b):(this.selectRow(b,!0),c.focusRow(b))};this.dataCart=new GeoNode.DataCartStore({selModel:e});tableCfg={store:this.searchStore,viewConfig:{autoFill:!0,forceFit:!0,emptyText:this.noResultsText},renderTo:"search_results",height:310,sm:e};e=new Ext.grid.ColumnModel({defaults:{sortable:!0,menuDisabled:!0},columns:[{header:this.titleHeaderText,dataIndex:"title",id:"title",sortable:!0,
width:200,sortBy:"LayerTitle",renderer:function(a,b,c){var d=app.layerTree.replaceURLWithHTMLLinks(c.get("abstract"));b.attr='ext:qtip="<strong>Title: '+c.get("title")+"</strong><br/><strong>Source: "+c.get("layer_originator")+"</strong><br/><strong>Abstract</strong>: "+d.substring(0,250)+"<br/><strong>Date</strong>: "+c.get("layer_datetype")+'"';return $.parseJSON(c.get("is_public"))?a:'<span class="unviewable-layer"></span>  '+a}},{header:this.originatorText,dataIndex:"layer_originator",id:"layer_originator",
width:100,sortable:!0},{header:this.dateHeaderText,id:"date",width:50,sortable:!0,dataIndex:"layer_date",sortBy:"layer_date",renderer:function(a,b,c){a=c.get("layer_date").split("-");return 1==a.length?"None":""==a[0]?"-"+parseInt(a[1],10):parseInt(a[0],10)}}]});tableCfg.colModel=e;this.table=new Ext.grid.GridPanel(tableCfg);this.queryInput=new Ext.form.TextField({emptyText:this.searchLabelText,name:"search",allowBlank:!0,width:90,height:25,cls:"search-bar"});this.queryInput.on("specialkey",function(a,
b){b.getKey()==b.ENTER&&this.updateQuery()},this);this.originatorInput=new Ext.form.TextField({emptyText:this.originatorSearchLabelText,name:"search_originator",allowBlank:!0,width:90,height:25,cls:"search-bar"});this.originatorInput.on("specialkey",function(a,b){b.getKey()==b.ENTER&&this.updateQuery()},this);layers_data=[["","All Layers"],['service_type:"Hypermap:WorldMap"',"WorldMap Layers"],['service_type:"OGC:WMS"',"WMS"],['service_type:"ESRI:ArcGIS:ImageServer"',"ESRI Image"],['service_type:"ESRI:ArcGIS:MapServer"',
"ESRI Map"]];0<app.username.length&&layers_data.splice(1,0,['layer_username:"'+app.username+'"',"My Layers"]);this.dataTypeInput=new Ext.form.ComboBox({id:"dataTypes",mode:"local",width:110,height:25,cls:"data-type layer-selection",store:new Ext.data.ArrayStore({id:0,fields:["value","Label"],data:layers_data}),valueField:"value",displayField:"Label",triggerAction:"all",editable:!1,forceSelection:!0,value:""});this.dataTypeInput.on("specialkey",function(a,b){b.getKey()==b.ENTER&&this.updateQuery()},
this);var f=new Ext.form.TextField({name:"startDate",width:160,height:25,listeners:{change:function(a,c){b.dateInput.valuesFromInput(0,c);b.updateQuery()},keypress:function(a,b){b.getKey()==b.ENTER&&(b.stopPropagation(),a.fireEvent("change",a,a.getValue()))}},enableKeyEvents:!0}),g=new Ext.form.TextField({name:"endDate",width:160,height:25,listeners:{change:function(a,c){b.dateInput.valuesFromInput(1,c);b.updateQuery()},keypress:function(a,b){b.getKey()==b.ENTER&&(b.stopPropagation(),a.fireEvent("change",
a,a.getValue()))}},enableKeyEvents:!0});this.dateLabelPanel=new Ext.Panel({items:[new Ext.form.Label({text:this.fromyearHeaderText}),f,new Ext.form.Label({text:this.toyearHeaderText}),g],cls:"search-bar date-form"});this.dateInput=new GeoNode.TimeSlider;a();this.dateInput.addListener("change",function(){a()});this.dateInput.addListener("changecomplete",function(){b.updateQuery()});e=new Ext.Button({text:this.searchButtonText,iconCls:"prominent-btn",cls:"search-bar search-button"});e.on("click",this.updateQuery,
this);var h=new Ext.Button({text:this.resetButtonText,iconCls:"not-prominent-btn",cls:"search-bar clear-search-button",listeners:{click:function(){b.clearSearch()}}});(new Ext.Panel({frame:!1,border:!1,layout:"table",layoutConfig:{columns:4,tableAttrs:{style:{width:"100%"}}},defaults:{bodyStyle:"border: 0px; padding: 0 10px 10px 10px;"},items:[{items:[this.queryInput,this.originatorInput,this.dataTypeInput,e,h],colspan:4},{items:[this.dateLabelPanel],colspan:4},{items:[this.dateInput],colspan:4}]})).render(d);
this.prevButton=new Ext.Button({text:this.previousText,iconCls:"prominent-btn small-btn"});this.prevButton.on("click",this.loadPrevBatch,this);this.nextButton=new Ext.Button({text:this.nextText,iconCls:"prominent-btn small-btn"});this.nextButton.on("click",this.loadNextBatch,this);this.pagerLabel=new Ext.form.Label({text:"",cls:"pager-label"});(new Ext.Panel({frame:!1,border:!1,layout:new Ext.layout.HBoxLayout({defaultMargins:{top:10,bottom:10,left:0,right:5}}),items:[this.prevButton,this.nextButton,
this.pagerLabel]})).render(c);this.permalink=Ext.query("a.permalink")[0];this.disableControls();this.updatePermalink()},doMouseoverOn:function(a){a=this.table.getStore().getAt(a);this.showBounds(a);this.showPreviewLayer(a)},doMouseoverOff:function(){this.hideBounds();this.hidePreviewLayer()},showBounds:function(a){this.heatmap.bbox_widget.viewer.fireEvent("showBBox",this.getLayerBounds(a))},getLayerBounds:function(a){var b={};b.south=a.data.min_y;b.north=a.data.max_y;b.west=a.data.min_x;b.east=a.data.max_x;
return b},hideBounds:function(){this.heatmap.bbox_widget.viewer.fireEvent("hideBBox")},showPreviewLayer:function(a){if($.parseJSON(a.get("is_public"))){var b=this.getlayerTypename(a),a=this.getuuid(a);this.heatmap.bbox_widget.viewer.fireEvent("showPreviewLayer",b,a)}},hidePreviewLayer:function(){this.heatmap.bbox_widget.viewer.fireEvent("hidePreviewLayer")},getlayerTypename:function(a){return a.get("name")},getuuid:function(a){return a.get("uuid")},getLayerID:function(a){return a.get("id")},clearSearch:function(){this.originatorInput.setValue("");
this.dataTypeInput.setValue("");this.dateInput.setValue(0,this.dateInput.values[0]);this.dateInput.setValue(1,this.dateInput.values[1]);this.queryInput.setValue("");delete this.table.store.sortInfo;this.updateQuery()}});