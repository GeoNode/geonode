{% include "geonode/ext_header.html" %}
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}geoext/css/popup.css">
<link rel="stylesheet" type="text/css" href="{{STATIC_URL}}geonode/css/georef.css">
<script type="text/javascript" src="{{STATIC_URL}}lib/js/OpenLayers.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}lib/js/GeoExt.js"></script>
<script type="text/javascript" src="{{ STATIC_URL}}geonode/js/utils/thumbnail.js"></script>
<script type="text/javascript" src="{{ STATIC_URL}}geonode/js/utils/proj4js-compressed.js"></script>
<script type="text/javascript" src="{{ STATIC_URL}}geonode/js/utils/proj4js-EPSG32651.js"></script>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.js"></script>
<script type="text/javascript" >
    function formatBytes(bytes, decimals) {
        if(bytes == 0) 
            return '0 Bytes';
        var k = 1024;
        var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        var i = Math.floor(Math.log(bytes) / Math.log(k));
        return (bytes / Math.pow(k, i)).toPrecision(decimals + 1) + ' ' + sizes[i];
    }
    
    function sleep(milliseconds) {
      var start = new Date().getTime();
      for (var i = 0; i < 1e7; i++) {
        if ((new Date().getTime() - start) > milliseconds){
          break;
        }
      }
    }
    
    
</script>
<script type="text/javascript" >

OpenLayers.ImgPath = "{{ STATIC_URL }}geoexplorer/externals/openlayers/theme/default/img";
OpenLayers.Request.DEFAULT_CONFIG.headers = {
    'X-CSRFToken': '{{ csrf_token|escapejs }}'
};

var curr_location =  window.location.protocol+"//"+window.location.hostname+":"+window.location.port;
OpenLayers.ProxyHost = curr_location+"/proxy/?url=";
var geoserver = "";
if ("{{test_mode}}"=="True"){
    geoserver = window.location.protocol+"//"+window.location.hostname+":8080/geoserver/";
}else{
    curr_location =  window.location.protocol+"//"+window.location.hostname;
    geoserver = curr_location+"/geoserver/" ;
}

{% autoescape off %}

var options = {{ viewer| safe }};
var app, map;
var tile_list = [];
var highlight_layer;
var jurisdiction_geoms = [];
var interest_bounds; 
//var geoserver = "{{geoserver}}";
//var geoserver = curr_location+"/geoserver/";


// added stuff

var _TILE_SIZE = 1000;

$(document).ready(function(){
       $("#georef_form").submit(function(e) {
           e.preventDefault();
           var self = this;
           var json_parser = new OpenLayers.Format.JSON()
           var georef_string = document.getElementById("georef_area").getAttribute("value");
           $.post('/maptiles/validate/', 
                {"georefs" : georef_string}).done(function(result){
                   if (result.response) 
                        self.submit();
                   else {
                        alert("The total file size of this request is "+formatBytes(result.total_size, 2)+
                                " . You also have a total of "+formatBytes(result.cart_size, 2)+
                                " in the data cart and FTP requests with a total of "+formatBytes(result.recent_requests_size, 2)+
                                ". Your request exceeds the 200MB download limit. Please reduce number of selected tiles.");
                    }
                })
       });
       
       $("#bbox_form").submit(function(e){
           e.preventDefault();
           var self= this;
           var highlight_layer = map.getLayersByName("Highlight Layer")[0];
           selection_bounds(
                new OpenLayers.Bounds(
                    $('#leftlimit').val(),
                    $('#lowerlimit').val(),
                    $('#rightlimit').val(),
                    $('#upperlimit').val()
                ),
                highlight_layer
            );
        });
        
        $("#selection-message-close").click(function(e){
            $("#selection-message").hide();
        });
       
});

function floor_tile_size(x){
    return  (Math.floor(x/_TILE_SIZE) * _TILE_SIZE);
}

function ceil_tile_size(x) {
    return (Math.ceil(x/_TILE_SIZE) * _TILE_SIZE);
}

function get_corners( x, y ){
    return { ul_x: floor_tile_size(x), ul_y: ceil_tile_size(y),
         ur_x: ceil_tile_size(x), ur_y: ceil_tile_size(y),
         ll_x: floor_tile_size(x), ll_y: floor_tile_size(y),
         lr_x: ceil_tile_size(x), lr_y: floor_tile_size(y)
        };
}

function createTile(computed_corners){
    return {
                    georef: "E"+(computed_corners["ul_x"]/1000)+"N"+(computed_corners["ul_y"]/1000),
                    corners: computed_corners,
                    feature: null
                };
}

function display_points(div_id, vec_layer){
    var container = document.getElementById(div_id);
    container.removeChild(container.firstElementChild||container.firstChild);
    var table_element = document.createElement("table");
    table_element.className += "georef_table";
    container.appendChild(table_element);
    
    var georef_string = "";
    //console.log(tile_list);
    for (var i=0; i< tile_list.length/5; i++){
        var row_element = document.createElement("tr");
        row_element.className += "georef_tr";
        table_element.appendChild(row_element);
        for (var j = 0; j< Math.min(5, tile_list.length - i*5 ); j++){
            var georef_column = document.createElement("td");
            georef_column.setAttribute("id",tile_list[i*5+j].georef);
            georef_column.className += "georef_td"
            georef_column.innerHTML = tile_list[i*5+j].georef
            row_element.appendChild(georef_column);
            
            if(i*5+j == 0){
                georef_string+=tile_list[i*5+j].georef;
            }else{
                georef_string+=","+tile_list[i*5+j].georef;
            }
        }
    }
    document.getElementById("georef_area").setAttribute("value",georef_string);
}

function display_message(div_id, text_container_id, message){
    var container=document.getElementById(div_id);
    var text = document.getElementById(text_container_id);
    //console.log(text);
    text.innerHTML = message;
    //container.setAttribute("hidden","false");
    container.style.visibility="visible";
    //container.setAttribute("visibility", "visible");
}

function createHighlightBox(feature_attribs){
    var pt1 = new OpenLayers.Geometry.Point(feature_attribs["ul_x"], feature_attribs["ul_y"]).transform(new OpenLayers.Projection("EPSG:32651"), new OpenLayers.Projection("EPSG:900913"));
    var pt2 = new OpenLayers.Geometry.Point(feature_attribs["ur_x"], feature_attribs["ur_y"]).transform(new OpenLayers.Projection("EPSG:32651"), new OpenLayers.Projection("EPSG:900913"));
    var pt3 = new OpenLayers.Geometry.Point(feature_attribs["lr_x"], feature_attribs["lr_y"]).transform(new OpenLayers.Projection("EPSG:32651"), new OpenLayers.Projection("EPSG:900913"));
    var pt4 = new OpenLayers.Geometry.Point(feature_attribs["ll_x"], feature_attribs["ll_y"]).transform(new OpenLayers.Projection("EPSG:32651"), new OpenLayers.Projection("EPSG:900913"));
    
    var pts = [pt1, pt2, pt3, pt4];
    var lr = new OpenLayers.Geometry.LinearRing(pts);
    var polygon  = new OpenLayers.Geometry.Polygon([lr]);
    var polygon_feature = new  OpenLayers.Feature.Vector(polygon);
    
    return polygon_feature;
}

function find_georef(tile_list, georef){
     var tile_indeces= tile_list.map(function (x) { return x.georef });
     var index = tile_indeces.indexOf(georef);
     return index;
}

function wfs_proto_creator(layer_request, srs, outformat){
    return new OpenLayers.Protocol.WFS({
        version: "1.0.0",
        url: geoserver+"geonode/wfs",
        featurePrefix: "geonode",
        featureType: layer_request,
        featureNS: "http://www.geonode.org/",
        srsName: srs,
        outputFormat: outformat,
        async: false
    });
}

function jurisdictionFilter(geoms, feature_list){
    console.log("feature_list.length="+feature_list.length);
    var tile_list = [];
    var inJurisdiction = false;
    for (var i=0;i<feature_list.length;i++){
         for ( var j=0; j<geoms.length;j++){
            if(feature_list[i].geometry.components[0].intersects(geoms[j].geometry)){
                tile_list.push(feature_list[i]);
                break;
            }
        }
    }
    return tile_list;
}

function hasData( f_list){
   var data_filter = new OpenLayers.Filter.Logical({
        type: "||",
        filters: [
            new OpenLayers.Filter.Comparison({
                type: "==",
                property: "DSM",
                value: "1"
            }),
            new OpenLayers.Filter.Comparison({
                type: "==",
                property: "DTM",
                value: "1"
            }),
            new OpenLayers.Filter.Comparison({
                type: "==",
                property: "ORTHO",
                value: "1"
            }),
        ]
    });
    var tile_list = [];
    for (var i=0;i<f_list.length;i++){
        if(data_filter.evaluate(f_list[i])){
            tile_list.push(f_list[i]);
        }
    }
    return tile_list;
}

function filterSelectedTiles(tile_filter, single_click, send_notice){
     var wfs_proto = wfs_proto_creator("{{feature_tiled}}", "EPSG:32651","json"); 
     var arg_obj = {
         filter: tile_filter,
         single_click: single_click,
         send_notice: send_notice,
         callback: function(response){
             if(response.priv.responseText){
                 json_parser = new OpenLayers.Format.GeoJSON();
                 feature_out = json_parser.read(response.priv.responseText);
                 var tiles;
                  if (jurisdiction_geoms.length > 0){
                      tiles = hasData(jurisdictionFilter(jurisdiction_geoms, feature_out));
                  }else{
                      tiles = hasData(feature_out);
                  }
                  
                  for (var i=0; i<tiles.length; i++){
                    var f = tiles[i];
                    var corners = {
                        "ur_x": f.data.MAXX, "ur_y": f.data.MAXY,
                        "ul_x": f.data.MINX, "ul_y": f.data.MAXY,
                        "ll_x": f.data.MINX, "ll_y": f.data.MINY,
                        "lr_x": f.data.MAXX,"lr_y": f.data.MINY
                    }
                    var tile = createTile(corners);

                    if (find_georef(tile_list, tile.georef)<0){
                        tile_list.push(tile);
                        tile.feature = createHighlightBox(tile.corners);
                        highlight_layer.addFeatures([tile.feature]);
                    }else{
                        removeHighlight(tile.georef, highlight_layer);
                    }
                    display_points("point_display", highlight_layer);
                  }
                  
                  if (tiles.length < feature_out.length){
                      if (feature_out.length==1){
                            //alert("Selected tile either lacks data or is out of bounds. ");
                            display_message("selection-message","selection-message-text","Selected tile either lacks data or is out of bounds." );
                      }else{
                            //alert("Some selected tiles have not been included in the list due to lack of data or being outside the jurisdiction boundaries");
                            display_message("selection-message","selection-message-text","Some selected tiles have not been included in the list due to lack of data or being outside the jurisdiction boundaries");
                      }
                  }else{
                      /*document.getElementById("warning").style.visibilty =  "visible";
                      document.getElementById("warning").style.display =  "inline";*/
                      //container.setAttribute("hidden","hidden");
                  }
             }
         }
     };
     var wfs_resp = wfs_proto.read(arg_obj);
}

function selection_bounds(map_bounds, highlight_layer) {
    
    var transformed_bounds = map_bounds.clone().transform(new OpenLayers.Projection("EPSG:900913"), new OpenLayers.Projection("EPSG:32651"));
    
    var box_filter = new OpenLayers.Filter.Spatial({
        type: OpenLayers.Filter.Spatial.INTERSECTS,
        property: "the_geom",
        value: transformed_bounds.toGeometry()
    });
    
    filterSelectedTiles(box_filter, false, true);
}

function getJurisdictionGeom(jurisdiction, juris_vec_layer){
    var juris_wfs = wfs_proto_creator("{{feature_juris}}", "EPSG:32651", "json");
    var response = juris_wfs.read({
      callback: function(response){
            if (response.priv.responseText){
                var parser = new OpenLayers.Format.GeoJSON();
                var feature_out =parser.read(response.priv.responseText);
                juris_vec_layer.addFeatures(feature_out);
                jurisdiction_geoms = juris_vec_layer.features;
            }
        }
    });
}

function removeHighlight(georef, vec_layer){
    var index= find_georef(tile_list, georef);
    vec_layer.removeFeatures([tile_list[index].feature]);
    tile_list.splice(index,1);
}

var vector_style = new OpenLayers.Style({
    'fillColor': '#0000ff',
    'strokeColor': '#0000ff',
    'strokeWidth': 1
});

var vector_style_map = new OpenLayers.StyleMap({
    'default': vector_style
});

Ext.onReady(function (){
    var jurisdiction = "{{jurisdiction}}";
   
    var juris_vec_layer = new OpenLayers.Layer.Vector();
    var layer_name = "{{  layer }}";
    var map_options = options["map"];
    
    map = new OpenLayers.Map({
        units: map_options["units"],
        maxResolution: map_options["maxResolution"],
        projection: map_options["projection"]
    });
    
    var mq_layer = new OpenLayers.Layer.XYZ(
        "OpenStreetMap",
        [
            "http://otile1.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png",
            "http://otile2.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png",
            "http://otile3.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png",
            "http://otile4.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png"
        ],
        {
            attribution: "Data, imagery and map information provided by <a href='http://www.mapquest.com/'  target='_blank'>MapQuest</a>, <a href='http://www.openstreetmap.org/' target='_blank'>Open Street Map</a> and contributors, <a href='http://creativecommons.org/licenses/by-sa/2.0/' target='_blank'>CC-BY-SA</a>  <img src='http://developer.mapquest.com/content/osm/mq_logo.png' border='0'>",
            transitionEffect: "resize"
        },
        {
            isBaseLayer: true,
            wrapDateLine: true
        }
    );
    
    map.addLayer(mq_layer);

    var stored_layer = map_options["layers"].filter(function(l){ return l["name"] == layer_name })[0];
    var source_index = stored_layer["source"];
    
    map.addLayer(juris_vec_layer);
    
    var tile_layer = new OpenLayers.Layer.WMS(
        layer_name + "- Tiled", geoserver+"geonode/wms",
        {
            LAYERS: stored_layer["name"],
            format:  'image/png',
            bbox: stored_layer["bbox"],
            transparent: true,
            opacity: 0.3
        },
        {
            buffer: 0,
            displayOutsideMaxExtent: true,
            isBaseLayer: false,
            projection: "EPSG:900913",
            maxExtent: new OpenLayers.Bounds(stored_layer["bbox"])
        } 
    );
    
    map.addLayer(tile_layer);
    
    var jurisdiction_view_layer;
    if(jurisdiction){
        jurisdiction_view_layer = new OpenLayers.Layer.WMS(
            jurisdiction, geoserver+"geonode/wms",
            {
                LAYERS: jurisdiction,
                format: "image/png",
                bbox: new OpenLayers.Bounds({{j_bbox}}),
                transparent: true,
                opacity: 0.3
            },
            {
                buffer: 0,
                displayOutsideMaxExtent: true,
                isBaseLayer: false,
                projection: "EPSG:32651",
                maxExtent: new OpenLayers.Bounds({{j_bbox}})
            } 
        );
        
        map.addLayer(jurisdiction_view_layer);
    }

    highlight_layer = new OpenLayers.Layer.Vector(
        "Highlight Layer",
        {
            isBaseLayer: false ,
            //styleMap: new OpenLayers.Style(OpenLayers.Feature.Vector.style["select"])
            styleMap: vector_style_map,
            visibility: true,
            transparent: true
        }
    );
    map.addLayer(highlight_layer);
    //map.addLayers([mq_layer,tile_layer,highlight_layer, jurisdiction_layer]);
    
    var items = [];
    var config = {
        renderTo: "preview_map",
        height: 480,
        width: "100%",
        map: map,
        title: "Tile Selection",
        items: items,
        center: [13652590.86,1366919.96],
        zoom: 7
    };

    var drawControl = new OpenLayers.Control();
    OpenLayers.Util.extend(drawControl, {
        draw: function () {
            this.box = new OpenLayers.Handler.Box( drawControl,
                {"done": this.notice},
                {keyMask: OpenLayers.Handler.MOD_SHIFT});
            this.box.activate();
        },
        highlight_layer: highlight_layer,
        jurisdiction: jurisdiction,
        notice: function (bounds){ 
            var ll = map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.left, bounds.bottom)); 
            var ur = map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.right, bounds.top)); 
            var map_bounds = new OpenLayers.Bounds();
            map_bounds.extend(ll);
            map_bounds.extend(ur);
            selection_bounds(map_bounds, this.highlight_layer);
        }
    });

    OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {
        defaultHandlerOptions: {
            "single": true,
            "double": false,
            "pixelTolerance": 0,
            "stopSingle": false,
            "stopDouble": false
        },
        
        initialize: function(options) {
            this.handlerOptions = OpenLayers.Util.extend(
                {}, this.defaultHandlerOptions);
            OpenLayers.Control.prototype.initialize.apply(this, arguments);
            
            this.handler = new OpenLayers.Handler.Click(
            this, {
                'click': this.trigger
            }, this.handlerOptions);
        },
        
        trigger: function(e) {
            var lonlat = map.getLonLatFromPixel(e.xy);
            var click_pt = new OpenLayers.Geometry.Point(lonlat.lon, lonlat.lat);
            var transformed_pt = click_pt.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:32651"));
            var computed_corners = get_corners(click_pt.x, click_pt.y);
            
            //var tile = createTile(computed_corners);// this is a pointless piece of code

            var filter = new OpenLayers. Filter.Comparison({
                    type: "==",
                    property: "GRIDREF",
                    matchCase: true,
                    value: createTile(computed_corners).georef//tile.georef
            });
            
            filterSelectedTiles(filter, true, true);
        }
    });

   click_select = new OpenLayers.Control.Click()
    map.addControl(click_select);
    click_select.activate();
    map.addControl(drawControl);
    drawControl.activate();

    app = new GeoExt.MapPanel(config);
    if(jurisdiction != "" ){
        map.zoomToExtent(new OpenLayers.Bounds({{j_bbox}}));
        getJurisdictionGeom(jurisdiction, juris_vec_layer);
    }else{
        map.zoomToExtent(tile_layer.getExtent());
    }
});
{% endautoescape %}
</script>
