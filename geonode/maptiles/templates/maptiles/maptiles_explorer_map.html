{% include "geonode/ext_header.html" %}
{% include "geonode/app_header.html" %}
{% include "geonode/geo_header.html" %}
<script type="text/javascript" src="{{ STATIC_URL}}geonode/js/utils/thumbnail.js"></script>
<script type="text/javascript">
{% autoescape off %}
        var _TILE_SIZE = 1000;
        function floor_tile_size(x){
            return  (Math.floor(x/_TILE_SIZE) * _TILE_SIZE);
        }
        
        function ceil_tile_size(x) {
            return (Math.ceil(x/_TILE_SIZE) * _TILE_SIZE);
        }
        
        function get_corners( x, y ){
            return { ul_x: floor_tile_size(x), ul_y: ceil_tile_size(y),
                 ur_x: ceil_tile_size(x), ur_y: ceil_tile_size(y),
                 ll_x: floor_tile_size(x), ll_y: floor_tile_size(y),
                 lr_x: ceil_tile_size(x), lr_y: floor_tile_size(y)
                };
        }

        var app;
        Ext.onReady(function() {
            GeoExt.Lang.set("{{ LANGUAGE_CODE }}");
            var config = {
                tools: [{
                    ptype: "gxp_wmsgetfeatureinfo",
                    format: "grid",
                    actionTarget: "main.tbar",
                    outputConfig: {width: 400, height: 200, panIn: false}
                }],
                {% if PROXY_URL %}
                proxy: '{{ PROXY_URL }}',
                {% endif %}
                localGeoServerBaseUrl: "{{GEOSERVER_BASE_URL}}",
                authorizedRoles: "{{ user.is_authenticated|yesno:"ROLE_ADMINISTRATOR,ROLE_ANONYMOUS" }}",

                /* The URL to a REST map configuration service.  This service 
                 * provides listing and, with an authenticated user, saving of 
                 * maps on the server for sharing and editing.
                 */
                rest: "/maps/",
                {% if MAPFISH_PRINT_ENABLED %}
                printService: "{{GEOSERVER_BASE_URL}}pdf/",
                {% else %}
                printService: "",
                {% endif %}
                
                portalConfig: {
                    renderTo: "preview_map",
                    height: 400 
                },

                listeners: {
                    "ready": function() {
                        var map = app.mapPanel.map;
                        var layer = app.map.layers.slice(-1)[0];

                        // FIXME(Ariel): Zoom to extent until #1795 is fixed.
                        //map.zoomToExtent(layer.maxExtent, false)
                        
                        OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {
                            defaultHandlerOptions: {
                                "single": true,
                                "double": false,
                                "pixelTolerance": 0,
                                "stopSingle": false,
                                "stopDouble": false
                            },
        
                            initialize: function(options) {
                                this.handlerOptions = OpenLayers.Util.extend(
                                    {}, this.defaultHandlerOptions
                                );
                                OpenLayers.Control.prototype.initialize.apply(this, arguments); 
                                    this.handler = new OpenLayers.Handler.Click(
                                        this, {
                                            'click': this.trigger
                                        }, this.handlerOptions
                                    );
                            },
        
                            trigger: function(e) {
                                var lonlat = map.getLonLatFromPixel(e.xy);
                                
                                var corners = get_corners(lonlat.lat, lonlat.lon);
                                var corner_pts = [
                                    new OpenLayers.Geometry.Point(corners.ul_x, corners.ul_y),
                                    new OpenLayers.Geometry.Point(corners.ur_x, corners.ur_y),
                                    new OpenLayers.Geometry.Point(corners.lr_x, corners.lr_y),
                                    new OpenLayers.Geometry.Point(corners.ll_x, corners.ll_y)
                                    ];
                                
                                var ln = new OpenLayers.Geometry.LinearRing(corner_pts);
                                var rectFeat = new OpenLayers.Feature.Vector(ln);
                                alert("clicked!");
                                var vector_layer = map.getLayersByName("selection_layer")[0];
                                vector_layer.addFeatures([rectFeat]);
                            }
                                
                        });
            
                        click_select = new OpenLayers.Control.Click()
                        map.addControl(click_select);   
                        click_select.activate();
                        
                        var bbox = layer.bbox;
                        if (bbox != undefined)
                        {
                           if (!Array.isArray(bbox) && Object.keys(layer.srs) in bbox) {
                            bbox = bbox[Object.keys(layer.srs)].bbox;
                           }

                           var extent = OpenLayers.Bounds.fromArray(bbox);
                           var zoomToData = function()
                           {
                               map.zoomToExtent(extent, false);
                               app.mapPanel.center = map.center;
                               app.mapPanel.zoom = map.zoom;
                               map.events.unregister('changebaselayer', null, zoomToData);
                           };
                           map.events.register('changebaselayer',null,zoomToData);
                
                           if(map.baseLayer){
                            map.zoomToExtent(extent, false);
                           }
                           
                           var tile_select_layer = new OpenLayers.Layer.Vector("selection_layer",{
                               renderer: new OpenLayers.Renderer()
                               });
                           tile_select_layer.renderer.setExtent(extent);
                           map.addLayer(tile_select_layer);
                            
                        }
                        
                    },
                    "beforeunload": function() {
                        if (modified) {
                            styleEditor.show();
                            return false;
                        }
                    }
                }
            };

            config = Ext.apply(config, {{ viewer|safe }});
            app = new GeoExplorer.Viewer(config);

            for (var key in app.tools) {
                var tool = app.tools[key];
                if (tool.ptype == 'gxp_styler') {
                    tool.rasterStyling = true;
                };
            };

            // change style displayed in map
            Ext.get(Ext.DomQuery.select("input[@name='style']")).on("click", function(evt, elem) {
                app.selectedLayer.getLayer().mergeNewParams({
                    "STYLES": elem.id,
                    "_dc": Math.random()
                }); 
            });
            
            Ext.get(Ext.DomQuery.select(".style-edit")).on("click", function(evt, elem) {
                for (var key in app.tools) {
                    var tool = app.tools[key];
                    if (tool.ptype == 'gxp_styler') {
                        tool.actions[0].execute();
                    };
                }
            });
            Ext.Ajax.on('requestcomplete', function(req, cippa, opts){
                if(opts.method == 'PUT'){
                    $('#legend_icon').attr('src', $('#legend_icon').attr('src')+'&'+Math.random());
                }   
            }, this);
        
        });
        
    
{% endautoescape %}
</script>
