{% include "geonode/ext_header.html" %}
{# {% include "geonode/app_header.html" %} #}
{#  {% include "maptiles/maptiles_header.html" %} #}
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}geoext/css/popup.css">
<script type="text/javascript" src="{{STATIC_URL}}lib/js/OpenLayers.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}lib/js/GeoExt.js"></script>
<script type="text/javascript" src="{{ STATIC_URL}}geonode/js/utils/thumbnail.js"></script>
<script type="text/javascript" src="http://svn.osgeo.org/metacrs/proj4js/trunk/lib/proj4js-compressed.js"></script>
<script type="text/javascript" src="http://spatialreference.org/ref/epsg/wgs-84-utm-zone-51n/proj4js/"></script>
<script type="text/javascript" >

OpenLayers.ImgPath = "{{ STATIC_URL }}geoexplorer/externals/openlayers/theme/default/img";
OpenLayers.Request.DEFAULT_CONFIG.headers = {
    'X-CSRFToken': '{{ csrf_token|escapejs }}'
};

OpenLayers.ProxyHost = "/proxy?url=";

{% autoescape off %}

var options = {{ viewer|safe }};
var app;

function display_points(tile_list,div_id){
    var container = document.getElementById(div_id);
    container.removeChild(container.firstElementChild||container.firstChild);
    var list_element = document.createElement("ul");
    container.appendChild(list_element);
    
    var georef_string = "";
    
    for (var i=0; i< tile_list.length; i++){
        var tile = tile_list[i];
        var item_element = document.createElement("li");
        item_element.setAttribute("id",tile.georef);
        item_element.innerHTML = tile.georef;
        item_element.onclick = function(){
            tile_list.splice(i,1);
            this.parentNode.removeChild(this);
        };
        list_element.appendChild(item_element);
        georef_string+=tile.georef+",";
    }
    
   document.getElementById("georef_area").setAttribute("value",georef_string);
   
}

Ext.onReady(function (){
        var map_options = options["map"];
        var map = new OpenLayers.Map({
            units: map_options["units"],
            maxResolution: map_options["maxResolution"],
            projection: map_options["projection"]
        
        });
        
        var mq_layer = new OpenLayers.Layer.XYZ(
            "OpenStreetMap",
            [
                "http://otile1.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png",
                "http://otile2.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png",
                "http://otile3.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png",
                "http://otile4.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png"
            ],
            {
                attribution: "Data, imagery and map information provided by <a href='http://www.mapquest.com/'  target='_blank'>MapQuest</a>, <a href='http://www.openstreetmap.org/' target='_blank'>Open Street Map</a> and contributors, <a href='http://creativecommons.org/licenses/by-sa/2.0/' target='_blank'>CC-BY-SA</a>  <img src='http://developer.mapquest.com/content/osm/mq_logo.png' border='0'>",
                transitionEffect: "resize"
            },
            {
                isBaseLayer: true,
                wrapDateLine: true
            }
        );
        
        var format = 'image/png';
        var tile_layer = new OpenLayers.Layer.WMS(
            //"geonode:index - Tiled", "http://cephgeo.lan.dream.upd.edu.ph:8080/geoserver/geonode/wms",
            "geonode:index - Tiled", "http://192.168.56.100:8080/geoserver/geonode/wms",
            {
                LAYERS: 'geonode:index',
                STYLES: '',
                format: format,
                bbox: [13825393.814371249, 807566.643619642, 13852644.846474735, 817795.469341697],
                transparent: true,
                opacity: 0.3
            },
            {
                buffer: 0,
                displayOutsideMaxExtent: true,
                isBaseLayer: false,
                projection: "EPSG:900913",
                maxExtent: new OpenLayers.Bounds(13825393.814371249, 807566.643619642, 13852644.846474735, 817795.469341697)
            } 
        );
        map.addLayers([mq_layer,tile_layer]);
        
        var tile_list=[];
        
        /*var info = new OpenLayers.Control.WMSGetFeatureInfo(
            autoActivate: true,
            maxFeature: 3,
            eventListeners: {
                "getfeatureinfo": function(e){
                }
            }
        );*/ 
        
        var items = [{
            xtype: "gx_zoomslider",
            aggressive: false,
            vertical: true,
            height: 100,
            x: 10,
            y: 20
        }];
        
        var config = {
            renderTo: "preview_map",
            height: 400,
            map: map,
            title: "Tile Selection",
            items: items,
            center: [13652590.86,1366919.96],
            zoom: 5
        };
        
        var getInfoCtrl = new OpenLayers.Control.WMSGetFeatureInfo({
            autoActivate: true,
            infoFormat: "application/vnd.ogc.gml",
            maxFeatures: 3,
            url: "http://192.168.56.100:8080/geoserver/geonode/wms",
            layers: [tile_layer],
            eventListeners: {
                "getfeatureinfo": function (e){
                    var items = [];
                    Ext.each (e.features, function(feature) {
                        delete feature.attributes["File_Path"];
                        delete feature.attributes["GRID_REF"];
                        delete feature.attributes["Tilename"];
                        
                        items.push({
                            xtype: "propertygrid",
                            title: feature.fid,
                            source: feature.attributes
                        });
                    });
                    //console.log(items);
                    var georef = "E"+
                        items[0].source.MINX/1000+"N"+
                        items[0].source.MAXY/1000;
                    console.log(georef);
                    
                    items.push({
                        xtype: "button",
                        text: "Add"
                    });
                    
                    new GeoExt.Popup({
                        title: georef,
                        width: 200,
                        height: 200,
                        layout: "accordion",
                        map: map,
                        location: e.xy,
                        items: items
                    }).show();
                },
                "nogetfeatureinfo": function(e){
                    console.log("No queryable layer found");
                }
            }
        });
        
        map.addControl(getInfoCtrl);
        app = new GeoExt.MapPanel(config);
        map.zoomToExtent(tile_layer.maxExtent, false);
        
});
{% endautoescape %}
</script>
