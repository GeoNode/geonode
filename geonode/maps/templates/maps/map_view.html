{% extends "base.html" %}

{% load i18n %}

{% block title %} {% trans "Map Viewer" %} - {{ block.super }} {% endblock %}

{% block head %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}geoexplorer/externals/ext/resources/css/ext-all.css" />
<script type="text/javascript" src="{{ STATIC_URL }}geoexplorer/externals/ext/adapter/ext/ext-base.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}geoexplorer/externals/ext/ext-all.js"></script>
<script type="text/javascript">
  Ext.Ajax.defaultHeaders = { 'X-CSRFToken': '{{ csrf_token|escapejs }}' };
  Ext.BLANK_IMAGE_URL = "{{ STATIC_URL }}geoexplorer/externals/ext/resources/images/default/s.gif";
</script>
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}geoexplorer/externals/geoext/resources/css/gxtheme-gray.css">
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}geoexplorer/theme/ux/colorpicker/color-picker.ux.css" />
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}geoexplorer/externals/PrintPreview/resources/css/printpreview.css" />
<link rel="stylesheet" type="texr/css" href="{{ STATIC_URL }}geoexplorer/externals/gxp/src/theme/all.css" />
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}geoexplorer/externals/openlayers/theme/default/style.css" />
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}geoexplorer/theme/app/geoexplorer.css " />
<!--[if IE]><link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}geoexplorer/theme/app/ie.css"/><![endif]-->
<script src="{{STATIC_URL}}/geoexplorer/script/GeoExplorer.js" type="text/javascript"></script>
<style type="text/css">
html, body {
  height: 100%;
}
button.logout {
    display: none;
}
button.login {
    display:none;
}
</style>
<script type="text/javascript">
OpenLayers.Request.DEFAULT_CONFIG.headers = {
    'X-CSRFToken': '{{ csrf_token|escapejs }}'
};
var app;

Ext.ns("GeoNode");
GeoNode.Composer = Ext.extend(GeoExplorer.Composer, {

    cookieParamName: 'geonode-user',
    /** begin i18n */
    metadataFormCancelText : "UT:Cancel",
    metadataFormSaveAsCopyText : "UT:Save as Copy",
    metadataFormSaveText : "UT:Save",
    metaDataHeader: 'UT:About this Map',
    metaDataMapAbstract: 'UT:Abstract',
    metaDataMapTitle: 'UT:Title',
    connErrorTitleText: "UT:Connection Error",
    connErrorText: "UT:The server returned an error",
    connErrorDetailsText: "UT:Details...",
    /** end i18n */
    constructor: function(config) {
        // global request proxy and error handling
        OpenLayers.Request.events.on({
            "failure": function(evt) {
                this.displayXHRTrouble(evt.request);
            },
            scope: this
        });
        Ext.util.Observable.observeClass(Ext.data.Connection);
        Ext.data.Connection.on({
            "requestexception": function(conn, response, options) {
                if(options.failure) {
                    // exceptions are handled elsewhere
                } else {
                    this.mapPlugins[0].busyMask && this.mapPlugins[0].busyMask.hide();
                    var url = options.url;
                    if (response.status == 401 && url.indexOf("http" != 0) &&
                                            url.indexOf(this.proxy) === -1) {
                        this.authenticate(options);
                    } else if (response.status != 405 && url != "/geoserver/rest/styles") {
                        // 405 from /rest/styles is ok because we use it to
                        // test whether we're authenticated or not
                        this.displayXHRTrouble(response);
                    }
                }
            },
            scope: this
        });
        GeoNode.Composer.superclass.constructor.apply(this, [config]);
    },
    displayXHRTrouble: function(response) {
        response.status && Ext.Msg.show({
            title: this.connErrorTitleText,
            msg: this.connErrorText +
                ": " + response.status + " " + response.statusText,
            icon: Ext.MessageBox.ERROR,
            buttons: {ok: this.connErrorDetailsText, cancel: true},
            fn: function(result) {
                if(result == "ok") {
                    var details = new Ext.Window({
                        title: response.status + " " + response.statusText,
                        width: 400,
                        height: 300,
                        items: {
                            xtype: "container",
                            cls: "error-details",
                            html: response.responseText
                        },
                        autoScroll: true,
                        buttons: [{
                            text: "OK",
                            handler: function() { details.close(); }
                        }]
                    });
                    details.show();
                }
            }
        });
    },
    authenticate: function(options) {
        var submit = function() {
            form.getForm().submit({
                  waitMsg: "Logging in...",
                  success: function(form, action) {
                      this.setAuthorizedRoles(["ROLE_ADMINISTRATOR"]);
                      win.close();
                      document.cookie = action.response.getResponseHeader("Set-Cookie");
                      // resend the original request
                      if (options) {
                          Ext.Ajax.request(options);
                      }
                  },
                  failure: function(form, action) {
                      var username = form.items.get(0);
                      var password = form.items.get(1);
                      username.markInvalid();
                      password.markInvalid();
                      username.focus(true);
                  },
                  scope: this
              });
          }.createDelegate(this);
          var csrfToken, csrfMatch = document.cookie.match(/csrftoken=(\w+);/);
          if (csrfMatch && csrfMatch.length > 0) {
              csrfToken = csrfMatch[1];
          }
          var win = new Ext.Window({
              title: "GeoNode Login",
              modal: true,
              width: 230,
              autoHeight: true,
              layout: "fit",
              items: [{
                  xtype: "form",
                  autoHeight: true,
                  labelWidth: 55,
                  border: false,
                  bodyStyle: "padding: 10px;",
                  url: "{% url account_ajax_login %}",
                  waitMsgTarget: true,
                  errorReader: {
                      // teach ExtJS a bit of RESTfulness
                      read: function(response) {
                          return {
                              success: response.status == 200,
                              records: []
                          };
                      }
                  },
                  defaults: {
                      anchor: "100%"
                  },
                  items: [{
                      xtype: "textfield",
                      name: "username",
                      fieldLabel: "Username"
                  }, {
                      xtype: "textfield",
                      name: "password",
                      fieldLabel: "Password",
                      inputType: "password"
                  }, {
                      xtype: "hidden",
                      name: "csrfmiddlewaretoken",
                      value: csrfToken
                  }, {
                      xtype: "button",
                      text: "Login",
                      inputType: "submit",
                      handler: submit
                  }]
              }],
              keys: {
                  "key": Ext.EventObject.ENTER,
                  "fn": submit
              }
          });
          win.show();
          var form = win.items.get(0);
          form.items.get(0).focus(false, 100);
    },
    initPortal: function() {
        this.on("beforesave", function(requestConfig) {
            if (this._doSave === true) {
                delete this._doSave;
                if (this.id) {
                    requestConfig.url = "{% url maps_browse %}" + this.id + "/data";
                } else {
                    requestConfig.url = "{% url maps_browse %}new/data";
                }
                return true;
            } else {
                this.showMetadataForm();
                return false;
            }
        }, this);
        this.on("beforehashchange", function(hash) {
            return false;
        });
        GeoNode.Composer.superclass.initPortal.apply(this, arguments);
    },
    /** private: method[initMetadataForm]
     *
     * Initialize metadata entry form.
     */
    initMetadataForm: function(){

        var titleField = new Ext.form.TextField({
            width: '95%',
            fieldLabel: this.metaDataMapTitle,
            value: this.about.title,
            allowBlank: false,
            enableKeyEvents: true,
            listeners: {
                "valid": function() {
                    saveAsButton.enable();
                    saveButton.enable();
                },
                "invalid": function() {
                    saveAsButton.disable();
                    saveButton.disable();
                }
            }
        });

        var abstractField = new Ext.form.TextArea({
            width: '95%',
            height: 200,
            fieldLabel: this.metaDataMapAbstract,
            value: this.about["abstract"]
        });

        var metaDataPanel = new Ext.FormPanel({
            bodyStyle: {padding: "5px"},
            labelAlign: "top",
            items: [
                titleField,
                abstractField
            ]
        });
        metaDataPanel.enable();

        var saveAsButton = new Ext.Button({
            text: this.metadataFormSaveAsCopyText,
            disabled: !this.about.title,
            handler: function(e){
                delete this.id;
                this.about.title = titleField.getValue();
                this.about["abstract"] = abstractField.getValue();
                this.metadataForm.hide();
                this._doSave = true;
                this.save();
            },
            scope: this
        });
        var saveButton = new Ext.Button({
            text: this.metadataFormSaveText,
            disabled: !this.about.title,
            handler: function(e){
                this.about.title = titleField.getValue();
                this.about["abstract"] = abstractField.getValue();
                this.metadataForm.hide();
                this._doSave = true;
                this.save();
            },
            scope: this
        });

        this.metadataForm = new Ext.Window({
            title: this.metaDataHeader,
            closeAction: 'hide',
            items: metaDataPanel,
            modal: true,
            width: 400,
            autoHeight: true,
            bbar: [
                "->",
                saveAsButton,
                saveButton,
                new Ext.Button({
                    text: this.metadataFormCancelText,
                    handler: function() {
                        titleField.setValue(this.about.title);
                        abstractField.setValue(this.about["abstract"]);
                        this.metadataForm.hide();
                    },
                    scope: this
                })
            ]
        });
    },

    /** private: method[showMetadataForm]
     *  Shows the window with a metadata form
     */
    showMetadataForm: function() {
        if(!this.metadataForm) {
            this.initMetadataForm();
        }

        this.metadataForm.show();
    },


});

Ext.onReady(function() {
{% autoescape off %}
    var config = Ext.apply({
        portalConfig: {
            renderTo: 'composer',
            height: 400
        },
        authStatus: {% if user.is_authenticated %} 200{% else %} 401{% endif %},
        tools: [{
            ptype: "gxp_wmsgetfeatureinfo",
            // uncomment the line below if you want feature info in a grid
            format: "grid",
            actionTarget: "map.tbar",
            outputConfig: {width: 400, height: 300}
        }{% if user.is_authenticated and DB_DATASTORE  %},
        {
            ptype: "gxp_featuremanager",
            id: "feature_manager",
            paging: false,
            autoSetLayer: true,
            autoLoadFeatures: true,
            listeners: {
                'layerchange': function(mgr, layer, schema) {
                    checkLayerPermissions(layer);
                }
            }
        },
        {
            ptype: "gxp_featureeditor",
            id: "gn_layer_editor",
            featureManager: "feature_manager",
            autoLoadFeature: true
        },
        { ptype: "gxp_measure" }{% endif %}
        ],
        proxy: "/proxy/?url=",
        printService: "{{GEOSERVER_BASE_URL}}pdf/",
        /* The URL to a REST map configuration service.  This service 
         * provides listing and, with an authenticated user, saving of 
         * maps on the server for sharing and editing.
         */
        rest: "{% url maps_browse %}",
        homeUrl: "{% url home %}",
        localGeoServerBaseUrl: "{{ GEOSERVER_BASE_URL }}",
        localCSWBaseUrl: "{{ CATALOGUE_BASE_URL }}",
        csrfToken: "{{ csrf_token }}"
    }, {{ config }});


    app = new GeoNode.Composer(config);

    {% if user.is_authenticated and DB_DATASTORE  %}
    //Check permissions for selected layer and enable/disable feature edit buttons accordingly
    var checkLayerPermissions = function (layerRecord) {

        var buttons = app.tools["gn_layer_editor"].actions;

        var toggleButtons = function(enabled) {
            for (var i = 0; i < buttons.length; i++) {
                enabled ? buttons[i].enable() : buttons[i].disable();
            }
        }

        //Disable if layer is null or selected layer in tree doesn't match input layer
        var tree_node =  Ext.getCmp("treecontent").getSelectionModel().getSelectedNode();
        if (layerRecord == null) {
            toggleButtons(false);
        }
        else {
            //Proceed if this is a local queryable WMS layer
            var layer = layerRecord.getLayer();
            if (layer instanceof OpenLayers.Layer.WMS && (layer.url == "/geoserver/wms" ||
                    layer.url.indexOf(app.localGeoServerBaseUrl.replace(app.urlPortRegEx, "$1/")) == 0)) {
                Ext.Ajax.request({
                    url:"/layers/" + layer.params.LAYERS + "/edit-check",
                    method:"POST",
                    success:function (result, request) {
                        if (result.status != 200) {
                            toggleButtons(false);
                        } else {
                            layer.displayOutsideMaxExtent = true;
                            toggleButtons(true);
                        }
                    },
                    failure:function (result, request) {
                        toggleButtons(false);
                    }
                });
            } else {
                toggleButtons(false);
            }
        }
    };

    //Activate the editing if a map is created with a layer already in the config
    app.on('ready',function(){
        app.tools["gn_layer_editor"].getFeatureManager().setLayer(app.selectedLayer);
     });
    {% endif %}

    var permalinkTemplate = new Ext.Template("{protocol}//{host}/geonode/maps/{id}");
    var permalink = function(id) {
            return permalinkTemplate.apply({
                protocol: window.location.protocol,
                host: window.location.host,
                id: id
            }) 
        };

/*    var moreInfoTemplate = new Ext.Template(decodeURIComponent(Ext.get("more-info-tpl").dom.innerHTML));
    var mapInfoHtml = config.id ? moreInfoTemplate.apply({permalink : permalink(app.id)}) : "This map is currently unsaved";
    Ext.DomHelper.overwrite(Ext.get("more-info"), mapInfoHtml)

    var titleTemplate = new Ext.Template(Ext.get("title-tpl").dom.innerHTML);
    Ext.DomHelper.overwrite(Ext.get("map-title-header"), titleTemplate.apply({title: config.about.title}));
*/
//    app.on("save", function(id) {
        //reset title header
//        Ext.DomHelper.overwrite(Ext.get("map-title-header"), titleTemplate.apply({title: config.about.title}))

        //reset more info link
//        Ext.DomHelper.overwrite(Ext.get("more-info"), moreInfoTemplate.apply({permalink : permalink(app.id)}))
//    }, this);
{% endautoescape %}
});
</script>

{% endblock %}

{% block body %}
<div id="header-wrapper">
  {{ block.super }}
  <div id="topPanel">
    <div id="more-info"></div>
    <span id="map-title-header"></span>
  </div>
</div>
<div id="templates">
  <div id="more-info-tpl"><a class='link' href='{permalink}'>{% trans "View info" %}</a></div>
  <div id="title-tpl"><a class='maplist' href='{% url maps_search %}'>{% trans "Maps" %}</a> / <strong>{title}</strong></div>
</div>
{% endblock %}
{% block middle %}
<div id="composer" style="width:100%;height:100%;position:absolute;top: 70px"></div>
{% endblock %}
{% block footer %}{% endblock %}
