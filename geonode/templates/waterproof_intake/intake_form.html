{% extends "base.html" %}
{% load i18n %}
{% load static from staticfiles %}
{% load bootstrap_tags %}
{% block extra_head %}
<link href="https://unpkg.com/smartwizard@5/dist/css/smart_wizard_all.min.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
  crossorigin="" />
<link rel="stylesheet" href="http://xguaita.github.io/Leaflet.MapCenterCoord/dist/L.Control.MapCenterCoord.min.css" />
<link rel="stylesheet" href="{{ STATIC_URL }}geonode/css/leaflet/Control.Coordinates.css" %}" />
<link rel="stylesheet" href="{{ STATIC_URL }}geonode/css/leaflet/Control.Loader.css" %}" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<style>
  #mainActions>button {
    display: inline-block;
    padding: 6px 12px;
    margin-bottom: 0;
    font-size: 14px;
    font-weight: 400;
    line-height: 1.42857143;
    text-align: center;
    white-space: nowrap;
    vertical-align: middle;
    -ms-touch-action: manipulation;
    touch-action: manipulation;
    cursor: pointer;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    background-image: none;
    border: 1px solid transparent;
    border-radius: 4px;
    color: #fff;
    background-color: #337ab7;
    border-color: #2e6da4;
    margin-right: 4px;
  }

  .vertical-align {
    display: flex;
    align-items: center;
  }

  .text-danger-wp {
    color: rgb(255, 0, 0) !important;
  }

  .table>tbody>tr>td {
    vertical-align: middle;
  }

  .table>tbody>tr>th {
    vertical-align: middle;
  }
</style>
{% endblock %}
{% block body_outer %}
<div class="page-header">
  <h1>Create Water Intake</h1>
</div>

<div id="smartwizard">
  <ul class="nav">
    <li>
      <a class="nav-link" href="#step-1">
        Define
      </a>
    </li>
    <li>
      <a class="nav-link" href="#step-2">
        Configure Parameters
      </a>
    </li>
    <li>
      <a class="nav-link" href="#step-3">
        Water Extraction and External
      </a>
    </li>
    <li>
      <a class="nav-link" href="#step-4">
        Sub-area
      </a>
    </li>
  </ul>

  <div class="tab-content" id="autoAdjustHeightF">
    <div id="step-1" class="tab-pane" role="tabpanel">
      <form id="form" method="POST" action="">
        {% csrf_token %}
        <div id="water_intake">
          <div id="div_id_name" class="form-group  ">
            <label for="id_name" class="control-label required-field ">
              Nombre
            </label>
            <div class="">
              <input type="text" name="name" maxlength="100" class=" form-control" required="" id="id_name">
            </div>
          </div>

        </div>
        <div id="div_id_description" class="form-group  ">
          <label for="id_description" class="control-label required-field ">
            Descripción
          </label>
          <div class="">
            <input type="text" name="description" maxlength="1024" class=" form-control" required=""
              id="id_description">
          </div>
        </div>
        <div id="div_id_city" class="form-group  ">
          <label for="id_description" class="control-label required-field ">
            Ciudad
          </label>
          <div class="">{{form.city}}</div>
        </div>
          <button type="submit" id="submit" class="btn btn-primary">Submit</button>
     

      <div id="map">
        <div id="analysisOptions">
          <button id="validateBtn">Validate</button>
        </div>
      </div>
    </div>
    <div id="step-2" class="tab-pane" role="tabpanel">
      <div class="row">
        <div class="col-md-8">
          <div class="panel panel-default">
            <div class="panel-body" id="toolbar">
              Basic panel example
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-body" id="graph" tabindex="-1"
              style="height:790px;width:100%;overflow:hidden;cursor:default;">
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="panel panel-default">
            <div class="panel-body">
              <div class="alert alert-info" role="alert">
                <h1 class="text-center">R1</h1>
              </div>
             
                <div class="form-group">
                  <label for="exampleInputEmail1">Name:</label>
                  <input type="text" class="form-control">
                </div>
                <div class="form-group">
                  <label for="exampleInputEmail1">Parameter 1:</label>
                  <input type="text" class="form-control">
                </div>
                <div class="form-group">
                  <label for="exampleInputEmail1">Parameter 2:</label>
                  <input type="text" class="form-control">
                </div>
                <div class="form-group">
                  <label for="exampleInputEmail1">Costo 1:</label>
                  <input type="text" class="form-control">
                </div>
                <div class="form-group">
                  <label for="exampleInputEmail1">Costo 2:</label>
                  <input type="text" class="form-control">
                </div>
                <div class="form-group">
                  <label for="exampleInputEmail1">Costo 3:</label>
                  <input type="text" class="form-control">
                </div>
                <div class="form-group">
                  <label for="exampleInputEmail1">Costo 4:</label>
                  <input type="text" class="form-control">
                </div>
                <div class="form-group">
                  <label for="exampleInputEmail1">Costo 5:</label>
                  <input type="text" class="form-control">
                </div>
            </div>
          </div>
        </div>
      </form>
      </div>
      <div id="page">
        <div id="header">
          <div id="headerimg" style="overflow:hidden;">
            <h1 id="title">Draw</h1>
          </div>
        </div>
        <div id="mainActions" style="width:100%;padding-top:8px;padding-left:24px;padding-bottom:8px;">
        </div>
        <div id="selectActions" style="width:100%;padding-left:54px;padding-bottom:4px;">
        </div>
        <table border="0" width="730px">
          <tr>
            <!--<td id="toolbar" style="width:16px;padding-left:20px;" valign="top">
                      <!-- Toolbar Here -->
            </td>
            <td valign="top" style="border-width:1px;border-style:solid;border-color:black;">

              <!-- Graph Here -->
              <center id="splash" style="padding-top:230px;">
                <img src="{{ STATIC_URL }}geonode/js/mxgraph/examples/images/loading.gif">
              </center>
      </div>
      <textarea id="xml" style="height:480px;width:684px;display:none;border-style:none;"></textarea>
      </td>
      </tr>
      </table>
      <span style="float:right;padding-right:36px;">
        <input id="source" type="checkbox" />Source
      </span>
      <div id="zoomActions" style="width:100%;padding-left:54px;padding-top:4px;">
      </div>
      <div id="footer">
        <p id="status" style="display:none;">
          <!-- Status Here -->Loading...
        </p>
        <br />
      </div>
    </div>
  </div>
  <div id="step-3" class="tab-pane" role="tabpanel">
    <div class="page-header">
      <h3>Water Extraction</h3>
      <p>Please enter the annual water extraction (l/s) associated with the Extraction Connection element x defined in
        the Water Intake system diagram</p>
    </div>

    <h4 class="text-primary">Type data</h4>
    <ul class="nav nav-tabs">
      <li data-toggle="tab" data-target="#automatic" class="active"><a href="#">Automatic</a></li>
      <li data-toggle="tab" data-target="#manual"><a href="#">Manual</a></li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade in active" id="automatic">
        <br>
        <div class="form-group">
          <div class="row">
            <div class="col-md-6">
              <h5 class="text-primary">Data Analysis</h5>
              <div class="form-group">
                <div class="row">
                  <div class="col-md-6">
                    <label>Type process <span class="text-danger-wp">(*)</span> </label>
                    <select class="form-control" id="typeProcessInterpolation">
                      <option value="1">Linear interpolation</option>
                      <option value="2">Potential interpolation</option>
                      <option Value="3">Exponential interpolation</option>
                      <option Value="4">Logistics interpolation</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label>Number Year <span class="text-danger-wp">(*)</span> </label>
                    <input type="text" class="form-control" id="numberYearsInterpolationValue" required>
                  </div>
                </div>
              </div>
              <h5 class="text-primary">Data for Extraction</h5>
              <div class="form-group">
                <div class="row">
                  <div class="col-md-6">
                    <label>Initial <span class="text-danger-wp">(*)</span> </label>
                    <input type="text" class="form-control" id="initialDataExtractionInterpolationValue" required>
                  </div>
                  <div class="col-md-6">
                    <label>Final <span class="text-danger-wp">(*)</span> </label>
                    <input type="text" class="form-control" id="finalDataExtractionInterpolationValue" required>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-primary" id="intakeWECB">Generate</button>
            </div>
            <div class="col-md-6">
              <h5 class="text-primary">Results</h5>
              <div style="max-height: 400px; overflow-y: auto;">
                <table class="table">
                  <thead>
                    <tr>
                      <th class="text-center" scope="col">#</th>
                      <th class="text-center" scope="col">Extraction Value</th>
                    </tr>
                  </thead>
                  <tbody id="intakeECTAG">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="manual">
        <br>
        <div class="form-group">
          <div class="row">
            <div class="col-md-6">
              <h5 class="text-primary">Year number for analysis</h5>
              <div class="form-group">
                <label>Number Years <span class="text-danger-wp">(*)</span> </label>
                <input type="text" class="form-control" required>
              </div>
              <button type="button" class="btn btn-primary">Generate</button>
              <button type="button" class="btn btn-danger">Save asignation</button>

            </div>
            <div class="col-md-6">
              <h5 class="text-primary">Results</h5>
              <div class="panel panel-primary">
                <div class="panel-body">
                  <div class="form-horizontal">
                    <div class="form-group">
                      <label class="col-sm-1 control-label">1</label>
                      <div class="col-sm-11">
                        <input type="text" class="form-control" required>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-sm-1 control-label">2</label>
                      <div class="col-sm-11">
                        <input type="text" class="form-control" required>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-sm-1 control-label">3</label>
                      <div class="col-sm-11">
                        <input type="text" class="form-control" required>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="page-header">
      <h3>External Inputs</h3>
      <p>You define 2 external inputs. For Each of these external inputs you have to define Annual Water Volume (m3),
        Annual Sediment Load (Ton), Annual Nitrogen Load(kg), Annual Phosphorus Load (kg).</p>
    </div>
    <h4 class="text-primary">Asignation</h4>
    <div class="form-horizontal">
      <div class="form-group">
        <label class="col-sm-3 control-label">Type element for asignation</label>
        <div class="col-sm-9">
          <select class="form-control">
            <option value="2">External Input 1</option>
            <option Value="2">External Input 2</option>
          </select>
        </div>
      </div>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th class="text-center" scope="col">Year</th>
          <th class="text-center" scope="col">Water Volume (m3)</th>
          <th class="text-center" scope="col">Sediment (Ton)</th>
          <th class="text-center" scope="col">Nitrogen (kg)</th>
          <th class="text-center" scope="col">Phosphorus (kG)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th class="text-center" scope="col">1</th>
          <td class="text-center" scope="col"><input type="text" class="form-control" required></td>
          <td class="text-center" scope="col"><input type="text" class="form-control" required></td>
          <td class="text-center" scope="col"><input type="text" class="form-control" required></td>
          <td class="text-center" scope="col"><input type="text" class="form-control" required></td>
        </tr>
        <tr>
          <th class="text-center" scope="col">2</th>
          <td class="text-center" scope="col"><input type="text" class="form-control" required></td>
          <td class="text-center" scope="col"><input type="text" class="form-control" required></td>
          <td class="text-center" scope="col"><input type="text" class="form-control" required></td>
          <td class="text-center" scope="col"><input type="text" class="form-control" required></td>
        </tr>
        <tr>
          <th class="text-center" scope="col">3</th>
          <td class="text-center" scope="col"><input type="text" class="form-control" required></td>
          <td class="text-center" scope="col"><input type="text" class="form-control" required></td>
          <td class="text-center" scope="col"><input type="text" class="form-control" required></td>
          <td class="text-center" scope="col"><input type="text" class="form-control" required></td>
        </tr>
      </tbody>
    </table>
  </div>
  <div id="step-4" class="tab-pane" role="tabpanel">
    <div class="row">
      <div class="col-md-8">
        <div class="panel panel-default">
          <div id="mapid" style="width: 100%; height: 400px;"></div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="panel panel-default">
          <div class="panel-body">
            <div class="alert alert-info" role="alert">
              <h1 class="text-center">Tools</h1>
            </div>
          </div>
          <div class="form-group">
            <div class="row">
              <div class="col-md-4">
                <label>Upload area</span></label>
                <input id="intakeArea" type="file" data-error="This field is required" required>
                <div class="help-block with-errors"></div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_script %}
<script src="https://unpkg.com/smartwizard@5/dist/js/jquery.smartWizard.min.js" type="text/javascript"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
  integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
  crossorigin=""></script>
<script src="{{ STATIC_URL }}geonode/js/leaflet/coordinates/Control.Coordinates.js" %}"></script>
<script src="{{ STATIC_URL }}geonode/js/leaflet/coordinates/util/NumberFormatter.js" %}"></script>
<script src="{{ STATIC_URL }}geonode/js/leaflet/Control.Loader.js" %}"></script>
<script src="{{ STATIC_URL }}geonode/js/waterproof/waterIntake.js" %}"></script>
<script src="http://xguaita.github.io/Leaflet.MapCenterCoord/dist/L.Control.MapCenterCoord.min.js"></script>
<!--ZIP reader library-->
<script src="{{ STATIC_URL }}waterproof_nbs_ca/js/jszip.min.js"></script>
<!--Shapefile reader library -->
<script src="{{ STATIC_URL }}waterproof_nbs_ca/js/shp.min.js"></script>
<script type="text/javascript">

  var mxBasePath = '{{ STATIC_URL }}geonode/js/mxgraph/src';
  var mxImageBasePath = '{{ STATIC_URL }}geonode/js/mxgraph/examples/images';
  var serverApi = '{{serverApi}}';
  var urlParams = (function (url) {
    var result = new Object();
    var params = window.location.search.slice(1).split('&');

    for (var i = 0; i < params.length; i++) {
      idx = params[i].indexOf('=');
      if (idx > 0) {
        result[params[i].substring(0, idx)] = params[i].substring(idx + 1);
      }
    }

    return result;
  })(window.location.href);

  var mxLanguage = urlParams['lang'];
  var map;
  var mapDelimit;
  var snapMarker;
  var snapMarkerMapDelimit;
  var catchmentPoly;
  var catchmentPolyDelimit;

  var mapLoader;

  $(document).ready(function () {

    $("#intakeWECB").click(function () {
      $('#intakeECTAG tr').remove();
      typeProcessInterpolation = Number($("#typeProcessInterpolation").val());
      numberYearsInterpolationValue = Number($("#numberYearsInterpolationValue").val());
      initialDataExtractionInterpolationValue = Number($("#initialDataExtractionInterpolationValue").val());
      finalDataExtractionInterpolationValue = Number($("#finalDataExtractionInterpolationValue").val());

      $('#autoAdjustHeightF').css("height", "auto");
      // Linear interpolation
      if (typeProcessInterpolation == 1) {
        m = (finalDataExtractionInterpolationValue - initialDataExtractionInterpolationValue) / (numberYearsInterpolationValue - 0)
        b = (-1 * m * 0) + initialDataExtractionInterpolationValue;

        for (let index = 0; index <= numberYearsInterpolationValue; index++) {
          $('#intakeECTAG').append(`<tr>
                <th class="text-center" scope="row">${index}</th>
                <td class="text-center">${((m * index) + b).toFixed(2)}</td>
              </tr>`);
        }
      }

      // Potencial interpolation
      if (typeProcessInterpolation == 2) {

      }
    });

    $('#smartwizard').smartWizard("next").click(function () {
      $('#autoAdjustHeightF').css("height", "auto");
      mapDelimit.invalidateSize();
      map.invalidateSize();
    });

    $('#smartwizard').smartWizard({
      selected: 0,
      theme: 'dots',
      enableURLhash: false,
      autoAdjustHeight: true,
      transition: {
        animation: 'slide-horizontal', // Effect on navigation, none/fade/slide-horizontal/slide-vertical/slide-swing
      },
      toolbarSettings: {
        toolbarPosition: 'bottom', // both bottom
        toolbarButtonPosition: 'center', // both bottom
      }
    });

    $("#smartwizard").on("showStep", function (e, anchorObject, stepIndex, stepDirection) {
      if (stepIndex == 3) {
        if (catchmentPoly)
          mapDelimit.fitBounds(catchmentPoly.getBounds());
        changeFileEvent();
      }
    });
    map = L.map('map', {}).setView([4.1, -74.1], 5);
    mapDelimit = L.map('mapid').setView([4.1, -74.1], 5);
    var osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
    });
    var osmid = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
    });
    map.addLayer(osm);
    mapDelimit.addLayer(osmid);

    L.control.mapCenterCoord().addTo(map);

    L.control.coordinates({
      position: "bottomleft", //optional default "bootomright"
      decimals: 2, //optional default 4
      decimalSeperator: ".", //optional default "."
      labelTemplateLat: "Latitude: {y}", //optional default "Lat: {y}"
      labelTemplateLng: "Longitude: {x}", //optional default "Lng: {x}"
      enableUserInput: true, //optional default true
      useDMS: false, //optional default false
      useLatLngOrder: true, //ordering of labels, default false-> lng-lat
      markerType: L.marker, //optional default L.marker
      markerProps: {}, //optional default {},
      centerUserCoordinates: true,
      labelFormatterLng: function (lng) { return lng + " lng" }, //optional default none,
      labelFormatterLat: function (lat) { return lat + " lat" }, //optional default none      
    }).addTo(map);

    $("#validateBtn").on("click", validateCoordinateWithApi);

    if (!mapLoader) {
      mapLoader = L.control.loader().addTo(map);
    }

    mapLoader.hide();

    createEditor('{{ STATIC_URL }}geonode/js/mxgraph/examples/editors/config/diagrameditor.xml');

    var menu1Tab = document.getElementById('mapid');
    var observer2 = new MutationObserver(function () {
      if (menu1Tab.style.display != 'none') {
        mapDelimit.invalidateSize();
      }
    });
    observer2.observe(menu1Tab, { attributes: true });
  });



  // Program starts here. The document.onLoad executes the
  // createEditor function with a given configuration.
  // In the config file, the mxEditor.onInit method is
  // overridden to invoke this global function as the
  // last step in the editor constructor.
  function onInit(editor) {
    // Enables rotation handle
    mxVertexHandler.prototype.rotationEnabled = true;

    // Enables guides
    mxGraphHandler.prototype.guidesEnabled = true;

    // Alt disables guides
    mxGuide.prototype.isEnabledForEvent = function (evt) {
      return !mxEvent.isAltDown(evt);
    };

    // Enables snapping waypoints to terminals
    mxEdgeHandler.prototype.snapToTerminals = true;

    // Defines an icon for creating new connections in the connection handler.
    // This will automatically disable the highlighting of the source vertex.
    mxConnectionHandler.prototype.connectImage = new mxImage('{{ STATIC_URL }}geonode/js/mxgraph/examples/images/connector.gif', 16, 16);

    // Enables connections in the graph and disables
    // reset of zoom and translate on root change
    // (ie. switch between XML and graphical mode).
    editor.graph.setConnectable(true);

    // Clones the source if new connection has no target
    editor.graph.connectionHandler.setCreateTarget(true);

    // Updates the title if the root changes
    var title = document.getElementById('title');

    if (title != null) {
      var f = function (sender) {
        title.innerHTML = sender.getTitle();
      };

      editor.addListener(mxEvent.ROOT, f);
      f(editor);
    }

    // Changes the zoom on mouseWheel events
    mxEvent.addMouseWheelListener(function (evt, up) {
      if (!mxEvent.isConsumed(evt)) {
        if (up) {
          editor.execute('zoomIn');
        }
        else {
          editor.execute('zoomOut');
        }

        mxEvent.consume(evt);
      }
    });

    // Defines a new action to switch between
    // XML and graphical display
    var textNode = document.getElementById('xml');
    var graphNode = editor.graph.container;

    var sourceInput = document.getElementById('source');
    sourceInput.checked = false;

    var funct = function (editor) {
      if (sourceInput.checked) {
        graphNode.style.display = 'none';
        textNode.style.display = 'inline';

        var enc = new mxCodec();
        var node = enc.encode(editor.graph.getModel());

        textNode.value = mxUtils.getPrettyXml(node);
        textNode.originalValue = textNode.value;
        textNode.focus();
      }
      else {
        graphNode.style.display = '';

        if (textNode.value != textNode.originalValue) {
          var doc = mxUtils.parseXml(textNode.value);
          var dec = new mxCodec(doc);
          dec.decode(doc.documentElement, editor.graph.getModel());
        }

        textNode.originalValue = null;

        // Makes sure nothing is selected in IE
        if (mxClient.IS_IE) {
          mxUtils.clearSelection();
        }

        textNode.style.display = 'none';

        // Moves the focus back to the graph
        editor.graph.container.focus();
      }
    };

    editor.addAction('switchView', funct);

    // Defines a new action to switch between
    // XML and graphical display
    mxEvent.addListener(sourceInput, 'click', function () {
      editor.execute('switchView');
    });

    // Create select actions in page
    var node = document.getElementById('mainActions');
    var buttons = ['group', 'ungroup', 'cut', 'copy', 'paste', 'delete', 'undo', 'redo', 'print', 'show'];

    // Only adds image and SVG export if backend is available
    // NOTE: The old image export in mxEditor is not used, the urlImage is used for the new export.
    if (editor.urlImage != null) {
      // Client-side code for image export
      var exportImage = function (editor) {
        var graph = editor.graph;
        var scale = graph.view.scale;
        var bounds = graph.getGraphBounds();

        // New image export
        var xmlDoc = mxUtils.createXmlDocument();
        var root = xmlDoc.createElement('output');
        xmlDoc.appendChild(root);

        // Renders graph. Offset will be multiplied with state's scale when painting state.
        var xmlCanvas = new mxXmlCanvas2D(root);
        xmlCanvas.translate(Math.floor(1 / scale - bounds.x), Math.floor(1 / scale - bounds.y));
        xmlCanvas.scale(scale);

        var imgExport = new mxImageExport();
        imgExport.drawState(graph.getView().getState(graph.model.root), xmlCanvas);

        // Puts request data together
        var w = Math.ceil(bounds.width * scale + 2);
        var h = Math.ceil(bounds.height * scale + 2);
        var xml = mxUtils.getXml(root);

        // Requests image if request is valid
        if (w > 0 && h > 0) {
          var name = 'export.png';
          var format = 'png';
          var bg = '&bg=#FFFFFF';

          new mxXmlRequest(editor.urlImage, 'filename=' + name + '&format=' + format +
            bg + '&w=' + w + '&h=' + h + '&xml=' + encodeURIComponent(xml)).
            simulate(document, '_blank');
        }
      };

      editor.addAction('exportImage', exportImage);

      // Client-side code for SVG export
      var exportSvg = function (editor) {
        var graph = editor.graph;
        var scale = graph.view.scale;
        var bounds = graph.getGraphBounds();

        // Prepares SVG document that holds the output
        var svgDoc = mxUtils.createXmlDocument();
        var root = (svgDoc.createElementNS != null) ?
          svgDoc.createElementNS(mxConstants.NS_SVG, 'svg') : svgDoc.createElement('svg');

        if (root.style != null) {
          root.style.backgroundColor = '#FFFFFF';
        }
        else {
          root.setAttribute('style', 'background-color:#FFFFFF');
        }

        if (svgDoc.createElementNS == null) {
          root.setAttribute('xmlns', mxConstants.NS_SVG);
        }

        root.setAttribute('width', Math.ceil(bounds.width * scale + 2) + 'px');
        root.setAttribute('height', Math.ceil(bounds.height * scale + 2) + 'px');
        root.setAttribute('xmlns:xlink', mxConstants.NS_XLINK);
        root.setAttribute('version', '1.1');

        // Adds group for anti-aliasing via transform
        var group = (svgDoc.createElementNS != null) ?
          svgDoc.createElementNS(mxConstants.NS_SVG, 'g') : svgDoc.createElement('g');
        group.setAttribute('transform', 'translate(0.5,0.5)');
        root.appendChild(group);
        svgDoc.appendChild(root);

        // Renders graph. Offset will be multiplied with state's scale when painting state.
        var svgCanvas = new mxSvgCanvas2D(group);
        svgCanvas.translate(Math.floor(1 / scale - bounds.x), Math.floor(1 / scale - bounds.y));
        svgCanvas.scale(scale);

        var imgExport = new mxImageExport();
        imgExport.drawState(graph.getView().getState(graph.model.root), svgCanvas);

        var name = 'export.svg';
        var xml = encodeURIComponent(mxUtils.getXml(root));

        new mxXmlRequest(editor.urlEcho, 'filename=' + name + '&format=svg' + '&xml=' + xml).simulate(document, "_blank");
      };

      editor.addAction('exportSvg', exportSvg);

      buttons.push('exportImage');
      buttons.push('exportSvg');
    };

    for (var i = 0; i < buttons.length; i++) {
      var button = document.createElement('button');
      mxUtils.write(button, mxResources.get(buttons[i]));

      var factory = function (name) {
        return function () {
          editor.execute(name);
        };
      };

      mxEvent.addListener(button, 'click', factory(buttons[i]));
      node.appendChild(button);
    }

    // Create select actions in page
    var node = document.getElementById('selectActions');
    mxUtils.write(node, 'Select: ');
    mxUtils.linkAction(node, 'All', editor, 'selectAll');
    mxUtils.write(node, ', ');
    mxUtils.linkAction(node, 'None', editor, 'selectNone');
    mxUtils.write(node, ', ');
    mxUtils.linkAction(node, 'Vertices', editor, 'selectVertices');
    mxUtils.write(node, ', ');
    mxUtils.linkAction(node, 'Edges', editor, 'selectEdges');

    // Create select actions in page
    var node = document.getElementById('zoomActions');
    mxUtils.write(node, 'Zoom: ');
    mxUtils.linkAction(node, 'In', editor, 'zoomIn');
    mxUtils.write(node, ', ');
    mxUtils.linkAction(node, 'Out', editor, 'zoomOut');
    mxUtils.write(node, ', ');
    mxUtils.linkAction(node, 'Actual', editor, 'actualSize');
    mxUtils.write(node, ', ');
    mxUtils.linkAction(node, 'Fit', editor, 'fit');
  }

  window.onbeforeunload = function () { return mxResources.get('changesLost'); };
  /** 
   * Validate input file on change
   * @param {HTML} dropdown Dropdown selected element
   */
  function changeFileEvent() {
    $('#intakeArea').change(function (evt) {
      var file = evt.currentTarget.files[0];
      var extension = validExtension(file);
      // Validate file's extension
      if (extension.valid) { //Valid
        console.log('Extension valid!');
        // Validate file's extension
        if (extension.extension == 'geojson') { //GeoJSON
          var readerGeoJson = new FileReader();
          readerGeoJson.onload = function (evt) {
            var contents = evt.target.result;
            geojson = JSON.parse(contents);
            loadFile(geojson, file.name);
          }
          readerGeoJson.readAsText(file);
        } else { //Zip
          var reader = new FileReader();
          var filename, readShp = false,
            readDbf = false,
            readShx = false,
            readPrj = false,
            prj, coord = true;
          var prjName;
          reader.onload = function (evt) {
            var contents = evt.target.result;
            JSZip.loadAsync(file).then(function (zip) {
              zip.forEach(function (relativePath, zipEntry) {
                filename = zipEntry.name.toLocaleLowerCase();
                if (filename.indexOf(".shp") != -1) {
                  readShp = true;
                }
                if (filename.indexOf(".dbf") != -1) {
                  readDbf = true;
                }
                if (filename.indexOf(".shx") != -1) {
                  readShx = true;
                }
                if (filename.indexOf(".prj") != -1) {
                  readPrj = true;
                  prjName = zipEntry.name;
                }
              });
              // Valid shapefile with minimum files req
              if (readShp && readDbf && readPrj && readShx) {
                zip.file(prjName).async("string").then(function (data) {
                  prj = data;
                  // Validar sistema de referencia
                  if (!prj) {
                    Swal.fire({
                      icon: 'error',
                      title: 'Error en shapefile',
                      text: 'Sistema de proyección incorrecto',
                    })
                  }
                  // Shapefile válido
                  else {
                    shp(contents).then(function (shpToGeojson) {
                      geojson = shpToGeojson;
                      let polygonStyle = {
                        fillColor: "#337ab7",
                        color: "#333333",
                        weight: 0.2,
                        fillOpacity: 0.3
                      };
                      var layer = L.geoJSON(geojson, { style: polygonStyle })
                      layer.addTo(mapDelimit);
                      map.fitBounds(layer.getBounds())
                      //loadShapefile(geojson, file.name);
                    }).catch(function (e) {
                      Swal.fire({
                        icon: 'error',
                        title: 'Error en shapefile',
                        text: 'Ha ocurrido un error de lectura en el shapefile',
                      })
                      console.log("Ocurrió error convirtiendo el shapefile " + e);
                    });
                  }
                });
              } else { // Missing req files
                // Miss .shp
                if (!readShp) {
                  Swal.fire({
                    icon: 'error',
                    title: 'Error en shapefile',
                    text: 'Falta el archivo .shp requerido',
                  })
                }
                // Miss .dbf
                if (!readDbf) {
                  Swal.fire({
                    icon: 'error',
                    title: 'Error en shapefile',
                    text: 'Falta el archivo .dbf requerido',
                  })
                }
                // Miss .shx
                if (!readShx) {
                  Swal.fire({
                    icon: 'error',
                    title: 'Error en shapefile',
                    text: 'Falta el archivo .shx requerido',
                  })
                }
                // Miss .prj
                if (!readPrj) {
                  Swal.fire({
                    icon: 'error',
                    title: 'Error en shapefile',
                    text: 'Falta el archivo .prj requerido',
                  })
                }
              }
            });
          };
          reader.onerror = function (event) {
            console.error("File could not be read! Code " + event.target.error.code);
            //alert("El archivo no pudo ser cargado: " + event.target.error.code);
          };
          reader.readAsArrayBuffer(file);
        }
      } else { //Invalid extension
        Swal.fire({
          icon: 'error',
          title: 'Error de extensión',
          text: 'La extensión del archivo no está soportada, debe ser GeoJSON o un shapefile .zip',
        })
      }
    });
  }
  /** 
   * Get if file has a valid shape or GeoJSON extension 
   * @param {StriFileng} file   zip or GeoJSON file
   *
   * @return {Object} extension Object contain extension and is valid
   */
  function validExtension(file) {
    var fileExtension = {};
    if (file.name.lastIndexOf(".") > 0) {
      var extension = file.name.substring(file.name.lastIndexOf(".") + 1, file.name.length);
      fileExtension.extension = extension;
    }
    if (file.type == 'application/x-zip-compressed' || file.type == 'application/zip') {
      fileExtension.valid = true;
    } else if (file.type == 'application/geo+json') {
      fileExtension.valid = true;
    } else {
      fileExtension.valid = false;
    }
    return fileExtension;
  }

</script>
<script src="{{ STATIC_URL }}geonode/js/mxgraph/mxClient.js"></script>
<script src="{{ STATIC_URL }}geonode/js/mxgraph/examples/editors/js/app.js"></script>
{% endblock %}