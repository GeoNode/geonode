{% extends "base.html" %} 
{% load i18n %} 
{% load static from staticfiles %}
{% load bootstrap_tags %} 
{% block extra_head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <link rel="stylesheet" href="{% static "geonode/css/leaflet/Control.Coordinates.css" %}"/>
    <link rel="stylesheet" href="https://photon.komoot.io/static/leaflet.photon/leaflet.photon.css"></link>
{% endblock %}

{% block body_outer %}
    <div class="row">
        <div class="col-md-4">
            <h4 class="text-center" id="countryLabel"></h4>
            <p><b>{% trans "Selected City" %} :</b> <span id="cityLabel"></span> </p>
            <p><b>{% trans "Region" %} :</b> <span id="regionLabel"></span> </p>
            <p><b>{% trans "Currency" %}:</b><span id="currencyLabel"></span></p>
        </div>
        <div class="col-md-8">
            <div id="map" style="width: 700px; height: 300px;"></div>
    
        </div>
    </div>   
    <div class="row">
        <div class="col-md-4">
        </div>
        <div class="col-md-8">
            <div id="listIntakes" style="display: none;">
                <a href="/study_cases">{% trans "List Study Cases" %}</a>
            </div> 
        </div>
    </div>
    
{% endblock %}

{% block extra_script %}
  <script src="https://vinceg.github.io/twitter-bootstrap-wizard/jquery.bootstrap.wizard.js"></script>
  <script src="https://vinceg.github.io/twitter-bootstrap-wizard/prettify.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
  <script src="{% static "geonode/js/leaflet/photon/leaflet.photon.js" %}"></script>
  <script src="{% static "geonode/js/leaflet/Leaflet.Coordinates.js" %}"></script>
  <script src="https://leaflet-extras.github.io/leaflet-providers/leaflet-providers.js"></script>
  <!-- <script src="https://unpkg.com/esri-leaflet@2.5.3/dist/esri-leaflet.js"
    integrity="sha512-K0Vddb4QdnVOAuPJBHkgrua+/A9Moyv8AQEWi0xndQ+fqbRfAFd47z4A9u1AW/spLO0gEaiE1z98PK1gl5mC5Q=="
    crossorigin=""></script> -->
  
  <script type="text/javascript">
    SEARCH_CITY_API_URL = '{{ SEARCH_CITY_API_URL }}';
    OSM_BASEMAP_URL = '{{ OSM_BASEMAP_URL }} ';
    IMG_BASEMAP_URL =  '{{ IMG_BASEMAP_URL }} ';
    HYDRO_BASEMAP_URL =  '{{ HYDRO_BASEMAP_URL }} ';
    GRAY_BASEMAP_URL = '{{ GRAY_BASEMAP_URL }} ';
    CENTER = [4.582, -74.4879];
    MAXZOOM = 11;
    COUNTRIES_API = '{{ DATABASE_URL }}';
    let waterproof = {};

    $(document).ready(function () {
        
        //var map = L.map('map').setView([4, -74],5);
        //var osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        //    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        //});
        //map.addLayer(osm);

        var gray = L.layerGroup();

        // more than one service can be grouped together and passed to the control together
        //L.esri.basemapLayer('Gray').addTo(gray);
        //L.esri.basemapLayer('GrayLabels').addTo(gray);
        
        var osm = L.tileLayer(OSM_BASEMAP_URL, {
            maxZoom: MAXZOOM, 
            attribution: 'Data \u00a9 <a href="http://www.openstreetmap.org/copyright"> OpenStreetMap Contributors </a> Tiles \u00a9 Komoot'});
        var images = L.tileLayer(IMG_BASEMAP_URL);        
        //var hydroLyr = L.tileLayer(HYDRO_BASEMAP_URL);
        var grayLyr = L.tileLayer(GRAY_BASEMAP_URL, {
                                    maxZoom: 20,
                                        attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, &copy; <a href="https://openmaptiles.org/">OpenMapTiles</a> &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
                                    });

        /* var wmsHydroNetworkLyr = L.tileLayer.wms('http://apps.skaphe.com:8080/geoserver/waterproof/wms?', {
            layers: 'waterproof:world_hydro_network',
            format: 'image/png',
            transparent: 'true',
            opacity: 0.35,
            minZoom: 6,
        }); */

        var baseLayers = {
            OpenStreetMap: osm,
            Images: images,
            Grayscale: grayLyr,
        };

        /* var overlays = {
            "Hydro (esri)": hydroLyr,
            "Hydro Network": wmsHydroNetworkLyr,
        }; */

        var map = L.map('map', {
                scrollWheelZoom: false, 
                layers: [osm],
                zoomControl: false, 
                photonControl: true, 
                photonControlOptions: {
                    resultsHandler: showSearchPoints, 
                    selectedResultHandler : selectedResultHandler,
                    placeholder: 'Search City...', 
                    position: 'topleft', url: SEARCH_CITY_API_URL}
            });        

        let initialCoords = CENTER;
        // find in localStorage if cityCoords exist
        var cityCoords = localStorage.getItem('cityCoords');
        if (cityCoords == undefined){
            cityCoords = initialCoords;
        }else{
            initialCoords = JSON.parse(cityCoords);
            try{
                $("#countryLabel").html(localStorage.getItem('country'));
                $("#cityLabel").html(localStorage.getItem('city'));
                $("#regionLabel").html(localStorage.getItem('region'));
                $("#currencyLabel").html(localStorage.getItem('currency'));
                $("#listIntakes").show();
            }catch(e){

            }
        }
        waterproof["cityCoords"] = cityCoords;

        map.setView(initialCoords,5);
        searchPoints.addTo(map);        
        
        //var c = new L.Control.Coordinates();
        //c.addTo(map);    

        L.control.layers(baseLayers,{},{position: 'topleft'}).addTo(map);
        var zoomControl = new L.Control.Zoom({position: 'topright'}).addTo(map);
        //L.control.mapCenterCoord().addTo(map); 
		
        function onMapClick(e) {
            //c.setCoordinates(e);      
        }
        map.on('click', onMapClick);  
        map.on('zoomend', function(e){
            console.log(map.getZoom());
        });      
      
    });    

    var searchPoints = L.geoJson(null, {
        onEachFeature: function (feature, layer) {
            layer.bindPopup(feature.properties.name);
        }
    });

    function showSearchPoints (geojson) {
        searchPoints.clearLayers();
        let geojsonFilter = geojson.features.filter(feature  => feature.properties.type == "city");
        searchPoints.addData(geojsonFilter);
    }

    function selectedResultHandler(feat){

        waterproof["cityCoords"] = [feat.geometry.coordinates[1], feat.geometry.coordinates[0]];
        localStorage.setItem('cityCoords', JSON.stringify(waterproof["cityCoords"]));


        searchPoints.eachLayer(function(layer){
            if (layer.feature.properties.osm_id != feat.properties.osm_id){
                layer.remove();
            }
        });
        let country = feat.properties.country;
        let cityName = feat.properties.name;
        let countryCode = feat.properties.countrycode.toLowerCase();

        $("#countryLabel").html(country);
        $("#cityLabel").html(cityName);
        localStorage.setItem('city', cityName);

        let urlAPI = '{{ SEARCH_COUNTRY_API_URL }}' + countryCode;

        $.get(urlAPI, function(data){
            //console.log(data);
            $("#regionLabel").html(data.region);
            $("#currencyLabel").html(data.currencies[0].name + " - " + data.currencies[0].symbol);
            $("#listIntakes").show();
            
            localStorage.setItem('country', country);
            localStorage.setItem('region', data.region);
            localStorage.setItem('currency', data.currencies[0].name + " - " + data.currencies[0].symbol);
        });
    }
    
  </script>  
  
{% endblock %}
