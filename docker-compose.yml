version: '2'

services:

  database:
    image: camptocamp/postgis:9.5
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=secret
    volumes:
      - postgresql_data:/var/lib/postgresql/data

  elasticsearch:
    image: elasticsearch:5.2
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data

  rabbitmq:
    image: rabbitmq:3.6
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  django:
    image: geonode/django
    build: .
    links:
      - database
      - elasticsearch
      - rabbitmq
      - geoserver
#    uncomment following line for production setup
#    command: gunicorn geonode.wsgi --forwarded-allow-ips=* --workers=3 --bind=0.0.0.0 --worker-tmp-dir=/tmp --access-logfile=- --error-logfile=-
    ports:
      - "8000:8000"
    environment:
      - DB_HOST=database
      - DB_PORT=5432
      - DB_ADMIN_USER=postgres
      - DB_ADMIN_PASSWORD=secret
      - DB_GEONODE_NAME=geonode
      - DB_GEONODE_USER=geonode
      - DB_GEONODE_PASSWORD=secret
      - DB_GEOSERVER_NAME=geoserver
      - DB_GEOSERVER_USER=geoserver
      - DB_GEOSERVER_PASSWORD=secret
    env_file:
      - ./scripts/docker/env/production/django.env
    volumes:
      - geonode_config:/mnt/geonode_config
      - geonode_data:/mnt/geonode_data

  celery:
    image: geonode/django
    links:
      - rabbitmq
      - database
      - elasticsearch
    entrypoint: celery
    command:
      - worker
      - --app=geonode.celery_app:app
      - --broker=amqp://guest:guest@rabbitmq:5672/
      - -B
      - -l
      - DEBUG
      - -E
    env_file:
      - ./scripts/docker/env/production/django.env

  consumers:
    image: geonode/django
    links:
      - rabbitmq
      - database
      - elasticsearch
    entrypoint: python
    command: manage.py runmessaging
    env_file:
      - ./scripts/docker/env/production/django.env

  geoserver:
    image: geonode/geoserver:alias
    links:
      - database
    ports:
      - "8080"
    volumes_from:
      - data_dir_conf
    env_file:
      - ./scripts/docker/env/production/geoserver.env

  geonode:
    image: geonode/nginx:geoserver
    links:
      - django
      - geoserver
    ports:
      - "80:80"

  data_dir_conf:
    image: geonode/geoserver_data:2.9.x-oauth2
    container_name: geoserver_data_dir
    command: /bin/true
    volumes:
      - /geoserver_data/data

volumes:
  rabbitmq_data:
  elasticsearch_data:
  geoserver_datadir:
  geoserver_data:
  postgresql_data:
  geonode_data:
  geonode_config:
