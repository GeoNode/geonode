==========
 myHazard
==========

Overview
========

'myHazard' provides a browser interface to provide hazard information
for a specific coordinate.  It will allow for a user to view hazard
map layers and create a report on a coordinate based on the data
within these layers.


Timeline
========

ASAP


User Stories
============

0. Use case: Planning Aid

Xavier, a hypothetical government official charged with building a
nuclear engergy plant, wants to get a rough idea about risks for some
proposed locations for construction.  He comes to the myHazard site
and investigates the proposed sites through the map interface.  He
generates several reports about different hazard scenarios and saves
them as pdfs for use in the planning process.


Goals/Non-Goals
===============

Goals
-----

0. Create a reporting application for ERN data




Feature Set
===========

View Components
---------------

0. myHazard tab 

 - entry point to application that goes on every page
 - either a tab in the current set of tabs, or another structure


0. Tab bar for application window.
   Gives access to rest of site.

0. Overall view 
   2 column layout
   * layer tree(left sidebar)
   * map viewer

0. Toolbar w/ selection tools 

  Tool types:

  - point 
  - path 
  - polygon
  
0. Map Viewer (col 2)

0. Layer Tree (col 1, see below)

0. Reports (see below)

0. Printable report (downloadable pdf)

0. Admin UI (loosely specified as the problem needs solving generally)
   Ability on upload to declare a layer's hazard, period, country,
   and mark for use in 'myHazard'


Layer Tree
~~~~~~~~~~

A ui component for determining what hazard should be included in the
generation of a report and what layers should be visible in the viewer.

Populated with layers grouped by hazard, that expand to allow
selection of the period::

      +[]- Landslide 
      |--[x] 50y
      |--[x] 100y
      |--[ ] 500y
      | 
      +[]- Earthquake
      |--[ ] 50y
      |--[x] 100y
      |--[ ] 500y
      |
      +[]- Tsunami
      +[]- Hurricane

 - CheckBox beside layer toggles both visibility and activates the
   layers for a report. Every visible layer will be active in the report.
 
 - Checkbox beside hazard is turns on/off all checkbox for the layers
   in that group.
 
 - Each period represents all layers for each country represented

 - Reordering may occur by hazard
   - but not by period

 - Base layer switcher (allows the base layer in viewer to be changed)
   uses Google Base layers (roads, hybrid, satelite). Column of
   descriptions and radio buttons located beneath layer tree.

.. note::

  Base layer switcher should eventually show up in all composer and
  reporting views throughout geonode, not just myhazard.

 - Transparency slider: allows a user to alter the transparency of
   visible hazard layers for the purpose of seeing admin and base
   layers beneath them.

.. note::

   This is a *single* slider that affects all visible layers hazard
   layers, but not the base layer or the administrative layer. Per
   hazard or per period transparency is not a goal at the moment.



Reporting Component
~~~~~~~~~~~~~~~~~~~

A user will use the selection tools to select a point, path or
area. Derived from what layers are activated in the layer tree, a
summary report will appear. Included in this report will be a link to
generate a complete PDF report.

.. note::
  
   We should estimate all three: point, path and area to offer
   options.  report would be generated from a buffered geometry.

When a user gets a report by using the selection tools, the user is
presented with a report summary including:

* A link to download the complete report as PDF (See below)

* For each of the layers that has been selected as ON in the layer
  tree (see above), include:

 - The Hazard (e.g. Landslide) and period (e.g. "100 years") for the layer.

 - The mean, median, range, and standard deviation values of the
   (scalar) values of the data in the QUERY AREA (see below)

 - Range of the whole layer.

 - "Administrative data" about the point clicked--country,
    municipality, etc.  Administrative data will be defined as
    specific vector layers related to the application.


.. note::

  for point selection: the QUERY AREA is the all the points within a radius
  around the clicked point.  This radius will vary with (1) the zoom
  level of the map, (2) the layer (or hazard?) being queried.

  Path and polygon selection should be unbuffered.

.. todo::
  
  Does radius vary by hazard or layer and is it acceptable for path
  and polygon to be unbuffered?
  

When a user follows the download link, they will download the full PDF
report, including:

* Some standard title and text provided by the client

* For each layer that has been selected as ON in the layer tree (see
  above), include:
  
  - Human-readable information about the QUERY AREA--what the radius is.
  
  - A tabular representation or histogram of the data in the QUERY
    AREA in "bins."  

.. todo::

  Not clear whether bins are layer or hazard specific. Not clear what
  "binned" table/histogram looks like


  - Any disclaimer or explanatory information about the layer

  - A map image (400x400 px), focused on the QUERY AREA.  

    Consists of admin layer, base layer, and displays the point of
    interest.  Includes a legend and scale.

  - Map images for each activated hazard period w/ base layer.
    Legend for the particular hazard layer.


.. note::

   Saving both reports and locations of reporting may be popular
   possible features in the future.


The report should return sensible error messages:

* GeoServer 404
  "GeoServer is not available"

* GeoServer 500
  - "There has been an issue generating this report"
  - traceback or any debugging info possible

* Django 500

 - "There has been an issue generating this report"
 - traceback


Flow
----

* Click my hazard tab -> open viewer

 - Map Viewer zoomed to extent of Nicuragua & Costa Rica
 - All layer are not visible or active.

.. todo::

   What should happen when nothing is selected? Dwins thinks stu said
   this should be treated as a special case as if everything were
   turned on

* Click on map with a point selection tool and sample

 - data from all available hazard layers reported
   - reporting applies any calculation or normalization needed for report 
 - Popup with report summary returned and displayed

* Click on map with a path or polygon selection tool

 - An anchor point (the starting point) is created on the map view
 - Holding down the click and dragging results in panning the map
 - Releasing and moving mouse shows preview of next path
 - Clicking a second time creates a path from the starting point to the new anchor point.

* Click on PDF link

 - PDF report is generated
 - Report downloaded by browser

* Click hazard activation checkbox for a hazard and period

 - The layer appears in map viewer
 - Select an area
 - A summary report appear derived from related layers 
 - Click PDF link ...



Sequencing of Requirements
==========================

Delivery Rounds
---------------

0. Map View + raw value reporting
   - summary report
   - maybe some raw data reporting (depending on feedback needs)

0. Full PDF generation
  


