{% extends 'site_base.html' %}
{% load bootstrap_tags %}
{% load staticfiles %}
{% block extra_head %}
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css"/>
<style type="text/css">
 html, body, #wrap {
    height: 100%;
    width: 100%;
 }
 .options-panel {
    position: fixed;
    left: 0;
    top: 50px;
    width: 70px;
    height: 100%;
    background: #333333;
    color: #757575;
    text-align: center;
    font-size: 12px;
    z-index: 200;
}
.options-panel .option {
    position: relative;
    margin: 11px 0;
}
.option > a, .search > a, .report > a {
    color: #757575;
    text-decoration: none;
    font-size: 22px;
    display: block;
    margin: 0 12px;
    height: 46px;
    width: 42px;
    position: relative;
    -moz-border-radius: 5px;
    -webkit-border-radius: 5px;
    border-radius: 5px;
}
.options-panel .option:first-child {
    margin-top:0;
}
.options-panel .option:last-child {
    margin-bottom:0;
}
.options-panel .option > a:hover,  .options-panel a.selected {
    background: #515151;
}
.options-panel svg {
    position:absolute;
    top:0;
    bottom:0;
    left: 0;
    right: 0;
    margin:auto;
}
.options-panel .section {
    padding: 18px 0;
    border-bottom: 1px solid #6d6c6c;
}
.options-panel .section-title {
    foont-size: 12px;
    line-height: 12px;
    margin: 0 0 10px;
    font-weight: normal;
    font-size: 12px;
}
a:hover .svg path, a.selected .svg path {
  fill: #fff;
}
a.set {
    border: 2px solid #82d173;
    margin-left: 10px;
    margin-top: -2px;
}
.options-panel .option > a.set:hover {
    background: none;
}
a.set .svg path {
  fill: #82d173;
}
a:hover i {
  color: #fff;
}
.options-panel .search a {
    height: auto;
}
.options-panel .search a:hover, .options-panel .option > a.inactive:hover {
    background: none;
}
.options-panel .inactive .svg path {
    fill: #181818;
}
.options-panel a.has-children:after {
    content: "";
    position: absolute;
    top: 16px;
    right: -7px;
    width: 0;
   height: 0;
   border-style: solid;
   border-width: 6.5px 0 6.5px 7px;
    border-color: transparent transparent transparent #757575;
}
.options-panel a.has-children:hover:after, .options-panel a.has-children.selected:after {
    border-color: transparent transparent transparent #515151;
}
.options-panel .list {
    display: none;
    position: absolute;
    left: 82px;
    top: 0;
    width: 160px;
    background: rgba(51,51,51,0.95);
    -moz-border-radius: 5px;
    -webkit-border-radius: 5px;
    border-radius: 5px;
    overflow: hidden;
}
.options-panel .list.show {
    display: block;
}
.options-panel .list:hover {
    display: block;
}
.list-title {
    font-size: 14px;
    margin: 0;
    line-height: 40px;
    color: #fff;
    background:  rgba(24,24,24,0.5);
    position: relative;
}
.list ul {
    padding: 0;
    line-height: 30px;
    font-size: 14px;
}
.list ul a {
    font-size: 14px;
    color: #979797;
    text-decoration: none;
}
.list ul a:hover, .list ul li.selected a, .list ul li.selected {
    color: #fff;
}
.list-title:after {
    position: absolute;
    left: -7px;
    top: 17px;
   width: 0;
height: 0;
border-style: solid;
border-width: 6.5px 7px 6.5px 0;
border-color: transparent rgba(244,244,244,0.9) transparent transparent;

}
.list ul .selected a, .list ul .selected {
    color: #82d173;
}
 </style>
{% endblock extra_head %}


{% block body_outer %}
</div><!-- close .container -->
<div class="options-panel">
    <div class="search section"> <a href="#" id="search-call"><i class="fa fa-search"></i></a> </div>
    <div class="exposure section">
        <h4 class="section-title">Exposure</h4>
        <div class="option"><a href="#" id="population"><img src="{% static "geosafe/img/population.svg" %}" alt="population" class="svg"/></a></div>
        <div class="option"><a href="#" id="roads"><img src="{% static "geosafe/img/roads.svg" %}" alt="roads" class="svg"/></a></div>
        <div class="option"><a href="#" id="buildings"><img src="{% static "geosafe/img/buildings.svg" %}" alt="buildings" class="svg"/></a></div>
    </div>
    <div class="hazard section">
        <h4 class="section-title">Hazard</h4>
        <div class="option"><a href="#" id="flood" class="has-children"><img src="{% static "geosafe/img/flood.svg" %}" alt="flood" class="svg" /></a>
            <div class="list floating-box" id="flood-list">
                <h4 class="list-title">Select the flood</h4>
                <ul>
                    <li><a href="#">Flood of 2014</a></li>
                    <li><a href="#">Flood of 2013</a></li>
                    <li><a href="#">Flood of 2008</a></li>
                    <li><a href="#">Flood of 2007</a></li>
                </ul>
            </div>
        </div>
        <div class="option"><a href="#" id="earthquake" class="inactive"><img src="{% static "geosafe/img/earthquake.svg" %}" alt="earthquake" class="svg"/></a></div>
        <div class="option"><a href="#" class="set" id="volcano"><img src="{% static "geosafe/img/volcano.svg" %}" alt="volcano" class="svg" /></a></div>
    </div>
    <div class="report section">
        <h4 class="section-title">Report<br />areas</h4>
        <div class="option"><i class="fa fa-map"></i></div>
        <button>Run</button>
    </div>
</div>
<div id="map" style="width: 100%; height: 100%; position:relative; margin-left: 70px; ">
    <div id="form-div" style="display: none;position: absolute; width: 30%; z-index: 100; top: 0; right: 0; background-color: transparent">
        <form action="" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form|as_bootstrap }}
            <button type="submit" class="btn btn-primary">Run</button>
        </form>
    </div>
</div>
{% endblock body_outer %}

{% block extra_script %} 
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script> 
<script type="text/javascript">
$(document).ready( function() {
jQuery('img.svg').each(function(){
    var $img = jQuery(this);
    var imgID = $img.attr('id');
    var imgClass = $img.attr('class');
    var imgURL = $img.attr('src');

    jQuery.get(imgURL, function(data) {
        // Get the SVG tag, ignore the rest
        var $svg = jQuery(data).find('svg');

        // Add replaced image's ID to the new SVG
        if(typeof imgID !== 'undefined') {
            $svg = $svg.attr('id', imgID);
        }
        // Add replaced image's classes to the new SVG
        if(typeof imgClass !== 'undefined') {
            $svg = $svg.attr('class', imgClass+' replaced-svg');
        }

        // Remove any invalid XML tags as per http://validator.w3.org
        $svg = $svg.removeAttr('xmlns:a');

        // Check if the viewport is set, if the viewport is not set the SVG wont't scale.
        if(!$svg.attr('viewBox') && $svg.attr('height') && $svg.attr('width')) {
            $svg.attr('viewBox', '0 0 ' + $svg.attr('height') + ' ' + $svg.attr('width'))
        }

        // Replace image with new SVG
        $img.replaceWith($svg);

    }, 'xml');

});
var w_width = $(window).width();
var map_width = w_width - 70;
$("#map").css("width", map_width);
$(".has-children").click(function() {
	$(this).toggleClass("selected");
	$(this).next().filter(".list").toggleClass("show");
});
$(".option > a").not('.has-children').click(function() {
	$(this).parents().find(".option").children('a').removeClass("set");
	$(this).toggleClass("set");
});
$(".list li a").click(function() {
	$(this).parent("li").siblings().children('a').removeClass("selected");
	$(this).toggleClass("selected");
	if ($(this).hasClass("selected")) {
		$(this).parents().find(".option").children('a').removeClass("set");
		$(this).parent().parent().parent().parent().find(".has-children").removeClass("selected").addClass("set");		
	}
	else {
		$(this).parent().parent().parent().parent().find(".has-children").removeClass("set").addClass("selected");
	}
});
$(document).mouseup(function (e)
{
    var container = $(".floating-box");
	var call = $(".option a");

    if (!container.is(e.target) // if the target of the click isn't the container...
        && container.has(e.target).length === 0
		&& !call.is(e.target) ) // ... nor a call for container
		
    {
        container.removeClass("show");
		$(".has-children").removeClass("selected");
    }
});
});
</script> 
<script type="text/javascript">
        var map;

        var exposure_layer;
        var hazard_layer;
        var aggregation_layer;
        $(document).ready(function () {
            var exposure_layer_cbo = $("#id_exposure_layer");
            var hazard_layer_cbo = $("#id_hazard_layer");
            var aggregation_layer_cbo = $("#id_aggregation_layer");


            {# listen to change handler #}
            var retrieve_if_list = function (evt) {
                console.log('call retrieve IF list');
                var chosen_combination = {
                    'exposure_id': $("#id_exposure_layer").val(),
                    'hazard_id': $("#id_hazard_layer").val()
                };

                $.get('{% url 'geosafe:impact-function-filter' %}', chosen_combination, function (data) {
                    console.log(data);
                    var select = $("#id_impact_function_id");
                    if (data.length > 0) {
                        $("#id_impact_function_id").empty();
                    }
                    else {
                        console.log('No IF found')
                        $("<option></option>").text("No matching Impact Function").appendTo(select);
                    }
                    for (var i = 0; i < data.length; i++) {
                        var id = data[i];
                        $("<option></option>").val(id).text(id).appendTo(select);
                    }
                });
            };

            function zoom_to_box(map, bbox) {
                var bounds = [
                    [bbox[1], bbox[0]],
                    [bbox[3], bbox[2]]
                ];
                map.fitBounds(bounds);
            }

            function add_layer(map, layer_tiles_url, layer) {
                layer = L.tileLayer(layer_tiles_url,
                        {
                            'opacity': 0.8
                        });
                if (layer != null) {
                    map.addLayer(layer);
                    return layer;
                }
            }

            function update_map(layer_id, layer_purpose) {
                $.get('{% url 'geosafe:layer-tiles' %}', {'layer_id': layer_id}, function (data) {
                    console.log(data);
                    layer_tiles_url = data['layer_tiles_url'];
                    layer_bbox_x0 = data['layer_bbox_x0'];
                    layer_bbox_x1 = data['layer_bbox_x1'];
                    layer_bbox_y0 = data['layer_bbox_y0'];
                    layer_bbox_y1 = data['layer_bbox_y1'];
                    map.fitBounds([[layer_bbox_y1, layer_bbox_x1], [layer_bbox_y0, layer_bbox_x0]]);

                    if (layer_purpose == 'exposure') {
                        exposure_layer = add_layer(map, layer_tiles_url, exposure_layer);
                    } else if (layer_purpose == 'hazard') {
                        hazard_layer = add_layer(map, layer_tiles_url, hazard_layer);

                    } else if (layer_purpose == 'aggregation') {
                        aggregation_layer = add_layer(map, layer_tiles_url, aggregation_layer);

                    }
                });
            }

            function update_exposure_layer() {
                var layer_id = exposure_layer_cbo.val();
                console.log('exposure changed to ' + layer_id);

                if (layer_id) {
                    console.log('update exposure layer');
                    if (exposure_layer) {
                        console.log('remove previous exposure layer');
                        console.log(exposure_layer);
                        map.removeLayer(exposure_layer);
                    }
                    update_map(layer_id, 'exposure');
                } else {
                    console.log('delete exposure');
                    map.removeLayer(exposure_layer);
                }
            }

            function update_hazard_layer() {
                var layer_id = hazard_layer_cbo.val();
                console.log('hazard changed to ' + layer_id);

                if (layer_id) {
                    console.log('update hazard layer');
                    if (hazard_layer) {
                        console.log('remove previous hazard layer');
                        console.log(hazard_layer);
                        map.removeLayer(hazard_layer);
                    }
                    update_map(layer_id, 'hazard');
                } else {
                    console.log('delete hazard');
                    map.removeLayer(hazard_layer);
                }
            }

            function update_aggregation_layer() {
                var layer_id = aggregation_layer_cbo.val();
                console.log('aggregation changed to ' + layer_id);

                if (layer_id) {
                    console.log('update aggregation layer');
                    if (aggregation_layer) {
                        console.log('remove previous aggregation layer');
                        console.log(aggregation_layer);
                        map.removeLayer(aggregation_layer);
                    }
                    update_map(layer_id, 'aggregation');
                } else {
                    console.log('delete aggregation');
                    map.removeLayer(aggregation_layer);
                }
            }

            var map_quest = L.tileLayer('http://otile{s}.mqcdn.com/tiles/1.0.0/{type}/{z}/{x}/{y}.{ext}', {
                type: 'map',
                ext: 'jpg',
                attribution: 'Tiles Courtesy of <a href="http://www.mapquest.com/">MapQuest</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                subdomains: '1234'
            });
            map = L.map('map', {
                layers: [map_quest]
            });

            zoom_to_box(map, [0, 45, 0, -45]);

            exposure_layer_cbo.change(retrieve_if_list);
            hazard_layer_cbo.change(retrieve_if_list);

            exposure_layer_cbo.change(update_exposure_layer);
            hazard_layer_cbo.change(update_hazard_layer);
            aggregation_layer_cbo.change(update_aggregation_layer);

        });
    </script> 
{% endblock %}
