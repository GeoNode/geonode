{% extends "page_layout.html" %}
{% load i18n %}

{% block head %} 
{% include "geonode/ext_header.html" %}
{% include "geonode/geoext_header.html" %}
{% include "geonode/ux_header.html" %}
{% include "geonode/gxp_header.html" %}
{{ block.super }}
<script  type="text/javascript">
{% autoescape off %}
        {% if map_status %} 
        var checkStatus, progress, pb, process;

        function update() { 
            Ext.Ajax.request({ 
                url : "{% url geonode.maps.views.check_download %}",
                method: "GET",              
                success: function(result) { 
                    process = Ext.util.JSON.decode(result.responseText);
                    if (process["process"]["status"] === "FINISHED"){ 
                        location.href = "{{site}}geoserver/rest/process/batchDownload/download/" +  process["process"]["id"] ; ; 
                        clearInterval(checkStatus); 
                        pb.updateProgress(1,"Done....",true);
                    } 
                    else { 
                        pb.updateProgress(process["process"]["progress"]/100,"Downloading...",true); 
                    } 
                },
                failure: function() { 
                    console.log("something went wrong"); 
                }});                 
        };

        Ext.onReady(function() {         
            checkStatus = setInterval("update()",1000);
            pb = new Ext.ProgressBar({
                text:'Downloading...',
                id:'pbar',
                cls:'left-align',
                renderTo:'pb'
            });
            cancel = new Ext.Button({ 
                text: 'Cancel',
                id: 'cancel',
                renderTo: 'cancel',
                handler: function() { 
                    Ext.Ajax.request({ 
                        url : "http://localhost:8000/geoserver/rest/process/batchDownload/kill/" + process["process"]["id"], 
                        method: "GET",
                        success: function(result) { 
                            alert("You sucessfuly canceled the download"); 
                            location.href = "{{site}}maps/{{map.id}}"; 
                            clearInterval(checkStatus);
                        },
                        failure: function(result) { 
                            console.log(result); 
                            clearInterval(checkStatus); // break if something fails
                        } 
                    }) } }); 
            
        });
        {% endif %} 
{% endautoescape %}
</script>
{% endblock %} 

{% block main %}
    <h3>Download {{map.title}}</h3>
    <hr />
    <ol>
      {% for layer in map.layers %} 
      <li>{% autoescape off %}{{layer.local_link}} {% endautoescape %} </li>
    {% endfor %} 
     </ol>     
     {% if map_status %} 
        <div id="cancel"> </div>
        <div id="pb"></div>
     {% else %} 
     <form action="." method="POST"> 
       {% csrf_token %}
       <input type="submit" value="Start downloading this map" /> 
     </form>
     {% endif %} 

{% endblock %}
