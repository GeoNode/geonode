{% extends "page_layout.html" %}
{% load i18n %}

{% block title %} {{ layer.resource.title|default:layer.typename }} - {{ block.super }} {% endblock %}

{% block head %}
{% include "geonode/ext_header.html" %}
{% include "geonode/openlayers_header.html" %}
{% include "geonode/geoext_header.html" %}
{% include "geonode/gxp_header.html" %}
{{ block.super }}
    <script type="text/javascript">
        Ext.onReady(function() {
            var config = {
                /* This option works around issue #109
                 * until http://trac.openlayers.org/ticket/2178
                 * is fixed.
                 */
                alignToGrid: true,
                proxy: "/proxy/?url=",

                /* The URL to a REST map configuration service.  This service 
                 * provides listing and, with an authenticated user, saving of 
                 * maps on the server for sharing and editing.
                 */
                rest: "/maps/",
                wms: {
                    "capra": "{{ GEOSERVER_BASE_URL }}wms"
                },
                map: {
                    "layers": [{"wms": "capra", "name": "{{layer.typename}}"}]
                },
                backgroundLayers: {{ background|safe }},
                portalConfig: {
                    renderTo: "preview_map",
                    height: 350
                },
                createTools: function() {
                    return [new Ext.Button({
                        tooltip: GeoExplorer.prototype.backgroundContainerText,
                        iconCls: 'icon-layer-switcher',
                        menu: new gxp.menu.LayerMenu({
                            layers: this.mapPanel.layers
                        })
                    })]
                },
                listeners: {
                    "ready": function() {
                        var map = app.mapPanel.map;
                        map.zoomToExtent(map.layers[map.layers.length-1].maxExtent);
                    }
                }
            };

            app = new GeoExplorer.Viewer(config);

            Ext.get(Ext.DomQuery.select("input[@name='style']")).on("click", function(evt, elem) {
                var layer;
                for(var i=0, len=app.mapPanel.map.layers.length; i<len; ++i) {
                    layer = app.mapPanel.map.layers[i];
                    if(layer !== app.mapPanel.map.baseLayer && layer.getVisibility()) {
                        layer.mergeNewParams({"STYLES": elem.value});
                        break;
                    }
                }
            });
        });
    </script>
{% endblock %}

{% block main %}
<div id="description"> <h3> {{ layer.resource.title|default:layer.typename }} </h3> </div>
<p> <strong>{% trans "Abstract" %}:</strong> {{ metadata.abstract|default:_("No abstract for this layer.") }} </p>

<div id="preview_map"></div>

<p> <strong>{% trans "Type" %}:</strong> {{ layer.display_type }} </p>
<p> <strong>{% trans "Keywords" %}:</strong> {{ layer.resource.keywords|join:", " }}</p>
<p> <strong>{% trans "Citation" %}:</strong> 
    {{ layer.metadata.attribution|default:_("No attribution information for this layer.") }}
</p>
<p> <strong>{% trans "Contact" %}:</strong>
    {{ layer.metadata.attribution|default:_("No attribution information for this layer.") }}
</p>
<p> <strong>{% trans "Attributes" %}:</strong> 
    {{ layer.attribute_names|join:", " }}
</p>
<p> <strong>{% trans "Native SRS" %}:</strong> {{ layer.metadata.crsOptions.0|default:_("No SRS specified.") }} </p>

{% endblock %}

{% block sidebar %}
    <h3> {% trans "Download" %} </h3>
    <p> <strong>{% trans "Data" %}: </strong>
        {% for extension, type, link in layer.download_links %}
            <a href="{{link}}">{{type}}</a>
        {% endfor %}
    </p>
    <p> <strong>{% trans "Metadata" %}: </strong>
        {% for mimetype, mdtype, link in layer.metadata_links %}
            <a href="{{link}}">{{mdtype}}</a>
        {% empty %}
            <em> {% trans "No metadata links provided for this data." noop %} </em>
        {% endfor %}
    </p>
    <h3>{% trans "Maps" %} </h3>
    {% if layer.maps %}
    <p>{% trans "The following maps use this data set" %}:
        <ul>
            {% for map in layer.maps %} 
            <li> <a href="{{map.get_absolute_url}}">{{map.title}}</a> </li>
            {% endfor %}
        </ul>
    {% else %}
        <p> {% trans "This layer is not currently used in any maps." %} </p>
    {% endif %}
    <p><a href="{% url geonode.maps.views.newmap %}?layer={{layer.typename}}">Create new map</a></p> 
    </p>

    <h3> {% trans "Styles" %} </h3>
    <p> {% trans "The following styles are associated with this data set.  Choose a style to view it in the preview to the left.  Click on a style name to view or edit the style." %}
    <br/>
    <input type="radio" name="style" value="{{layer.publishing.default_style.name}}" checked="checked"/> {{ layer.default_style.name|title }} <br/>
        {% for style in layer.styles %} 
            <input type="radio" name="style" value="{{style.name}}"/> {{ style.name|title }} <br/>
        {% endfor %}
    </p>

    {% if user.is_authenticated %}
        <h3> {% trans "Manage" %} </h3>
        <ul>
			{% if user.is_authenticated %}
                <li><a href="?describe">{% trans "Update the description of this data" %}</a></li>
            	<li><a href="?update">{% trans "Upload a new version of this data" %}</a></li>
				<li><a href="?remove">{% trans "Remove" %}</a></li>
			{% else %}
				<li>Please authenticate to update or remove layers</li>
			{% endif %}
        </ul>
    {% endif %}
{% endblock %}
