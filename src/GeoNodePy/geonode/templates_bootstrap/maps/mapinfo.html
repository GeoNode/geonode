{% extends "maps/base.html" %}
{% load i18n %}
{% load geonode_auth %}

{% block title %}{{ map.title }} â€” {{ block.super }}{% endblock %}

{% block head %}
  {% include "geonode/ext_header.html" %}
  {% include "geonode/app_header.html" %}
  {% include "geonode/geo_header.html" %}
  {{ block.super }}
  <script type="text/javascript">
  var app;
  Ext.onReady(function() {
  {% has_obj_perm user map "maps.change_map_permissions" as can_change_permissions %}
  {% autoescape off %}
      var config = Ext.apply({
          useToolbar: false,
          proxy: "/proxy/?url=",
          rest: "/maps/",

          // tell the map viewer where and how to be rendered
          portalConfig: {
              height: 300,
              renderTo: "embedded_map"
          }
      }, {{ config }});
      app = new GeoExplorer.Viewer(config);
  {% if can_change_permissions %}
      new GeoNode.PermissionsEditor({
          levels: {
              'admin': 'map_admin',
              'readwrite': 'map_readwrite',
              'readonly': 'map_readonly',
              '_none': '_none'
          },
          renderTo: "permissions_form",
          userLookup: "{% url geonode.views.ajax_lookup %}",
          permissions: {{ permissions_json }},
          listeners: {
              updated: function(perms) {
                  var submitTo = "{% url geonode.maps.views.ajax_map_permissions map.id %}";
                  Ext.Ajax.request({ url: submitTo, jsonData: perms.writePermissions() });
              }
          }
      });
  {% endif %}
  {% endautoescape %}
  });
  </script>
{% endblock %}

{% block main %}
  <h2>{{ map.title }}</h2>
  <p><strong>{% trans "Abstract:" %}</strong> {{ map.abstract }}</p>

  <div id="embedded_map">
  </div>
  <p><strong>{% trans "Contact:" %}</strong> <a href="{{ map.owner.get_profile.get_absolute_url }}">{{ map.owner }}</a></a></p>
{% endblock %}

{% block sidebar %}
  <ul class="nav nav-list">
    <li class="nav-header">{% trans "Download" %}</li>
    <li><a href="{% url geonode.maps.views.map_download map.id %}">{% trans "Download all layers included in this map" %}</a></li>
    
    <li class="nav-header">{% trans "Layers" %}</li>
    {% for layer in layers %}
      {% if not layer.group == "background" %}
        <li>{% autoescape off %}{{layer.local_link}}{% endautoescape %}</li>
      {% endif %}
    {% endfor %}
    
    <li class="nav-header">{% trans "Manage" %}</li>
    {% has_obj_perm user map "maps.change_map" as can_change %}
    {% has_obj_perm user map "maps.delete_map" as can_delete %}
    <li><a href="{% url geonode.maps.views.view map.id %}">{% trans "View or edit this map" %}</a></li>
    {% if can_change %}
    <li><a href="{% url geonode.maps.views.map_controller map.id %}?describe">{% trans "Edit metadata" %}</a></li>
    {% endif %}
    {% if can_change_permissions %}
    <li><a href="{% url edit_map_permissions map.id %}">{% trans "Edit permissions" %}</a></li>
    {% endif %}
    {% if can_delete %}
    <li><a href="{% url geonode.maps.views.map_controller map.id %}?remove">{% trans "Delete map" %}</a></li>
    {% endif %}
    <li><a href="{% url geonode.maps.views.newmap %}?copy={{map.id}}">{% trans "Duplicate map" %}</a></li>

    {% has_obj_perm user map "maps.change_map_permissions" as can_change_permissions %}
    {% if can_change_permissions %}
    <li class="nav-header">{% trans "Permissions" %}</li>
    <li class="form-inline"> <!-- TODO: Replace Extjs -->
      <p>{% trans "Select what kind of privileges to allow." %}</p>
      <div id="permissions_form"></div>
    </li>
    {% endif %}
  </ul>
{% endblock %}
