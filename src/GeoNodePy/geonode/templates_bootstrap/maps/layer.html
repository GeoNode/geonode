{% extends "maps/base.html" %}
{% load geonode_auth %}
{% load i18n %}

{% block title %}{{ layer.resource.title|default:layer.typename }} â€” {{ block.super }}{% endblock %}

{% block head %}
  {% include "geonode/ext_header.html" %}
  {% include "geonode/app_header.html" %}
  {% include "geonode/geo_header.html" %}

  <link rel="stylesheet" type="text/css" href="{{ GEONODE_CLIENT_LOCATION }}theme/ux/colorpicker/color-picker.ux.css" />

  {{ block.super }}

  <script type="text/javascript">
  {% autoescape off %}
          var styleEditor, modified = false;
          Ext.onReady(function() {
              var config = {
                  tools: [{
                      ptype: "gxp_wmsgetfeatureinfo",
                      // uncomment the line below if you want feature info in a grid
                      //format: "grid",
                      actionTarget: "main.tbar",
                      outputConfig: {width: 400, height: 200, panIn: false}
                  }],
                  proxy: "/proxy/?url=",
                  localGeoServerBaseUrl: "{{GEOSERVER_BASE_URL}}",
                  authorizedRoles: "{{ user.is_authenticated|yesno:"ROLE_ADMINISTRATOR,ROLE_ANONYMOUS" }}",

                  /* The URL to a REST map configuration service.  This service 
                   * provides listing and, with an authenticated user, saving of 
                   * maps on the server for sharing and editing.
                   */
                  rest: "/maps/",
                  
                  portalConfig: {
                      renderTo: "preview_map",
                      height: 350
                  },

                  createTools: function() {
                      return [new Ext.Button({
                          tooltip: GeoExplorer.prototype.backgroundContainerText,
                          iconCls: 'icon-layer-switcher',
                          menu: new gxp.menu.LayerMenu({
                              layers: this.mapPanel.layers
                          })
                      })]
                  },
                  listeners: {
                      "ready": function() {
                          var map = app.mapPanel.map;
                          map.zoomToExtent(map.layers.slice(-1)[0].maxExtent);
                      },
                      "beforeunload": function() {
                          if (modified) {
                              styleEditor.show();
                              return false;
                          }
                      }
                  }
              };

              config = Ext.apply(config, {{ viewer|safe }});

              app = new GeoExplorer.Viewer(config);
              
              Ext.get(Ext.DomQuery.select("input[@name='style']")).on("click", function(evt, elem) {
                  app.selectedLayer.getLayer().mergeNewParams({
                      "STYLES": elem.value,
                      "_dc": Math.random()
                  });
              });

              Ext.get(Ext.DomQuery.select("select[@name='default-style']")).on("change", function(evt, elem) {
                  Ext.Ajax.request({
                      method: "post",
                      url: "{% url layer_style layer.typename %}",
                      params: {"defaultStyle" : elem.value}
                  });
              });
  {% has_obj_perm user layer "maps.change_layer" as can_change %}
  {% if can_change %}
              Ext.get(Ext.DomQuery.select(".style-title")).on("click", function(evt, elem) {
                  showStyle(Ext.get(elem).prev("input").getAttribute("value"));
              });
  {% endif %}

  {% has_obj_perm user layer "maps.change_layer_permissions" as can_change_permissions %}
  {% if can_change_permissions %}
              new GeoNode.PermissionsEditor({
                  renderTo: "permissions_form",
                  userLookup: "{% url geonode.views.ajax_lookup %}",
                  permissions: {{ permissions_json }},
                  levels: {
                      'admin': 'layer_admin',
                      'readwrite': 'layer_readwrite',
                      'readonly': 'layer_readonly',
                      '_none': '_none'
                  },
                  listeners: {
                      updated: function(perms) {
                          var submitTo = "{% url geonode.maps.views.ajax_layer_permissions layer.typename %}";
                          Ext.Ajax.request({ url: submitTo, jsonData: perms.writePermissions() });
                      }
                  }
              });
  {% endif %}
          });

          function showStyle(styleName) {
              
              if (!styleName) {
                  Ext.ComponentMgr.all.on("add", function(index, object) {
                      if (object instanceof gxp.WMSStylesDialog) {
                          Ext.ComponentMgr.all.un("add", arguments.callee);
                          object.on("ready", function() {
                              object.addStyle();
                          }, this, {single: true});
                      }
                  });
              }
              app.tools["styler"].actions[0].execute();
          }
  {% endautoescape %}
  </script>
{% endblock %}

{% block main %}
  <div id="description"><h3>{{ layer.resource.title|default:layer.typename }}</h3></div>
  <p> <strong>{% trans "Abstract" %}:</strong> {{ layer.abstract|default:_("No abstract for this layer.") }} </p>

  <div id="preview_map"></div>

  {% if layer.display_type %}<p> <strong>{% trans "Type" %}:</strong> {{ layer.display_type }} </p>{% endif %}
  {% if layer.keywords %}<p> <strong>{% trans "Keywords" %}:</strong> {{ layer.keywords }}</p>{% endif %}
  {% if layer.edition %}<p> <strong>{% trans "Edition" %}:</strong> {{ layer.edition }}</p>{% endif %}
  {% if layer.topic_category %}<p> <strong>{% trans "Topic Category" %}:</strong> {{ layer.topic_category }}</p>{% endif %}

  {% if layer.constraints_use or layer.constraints_other %}
  <p> <strong>{% trans "Citation" %}:</strong> 
      {{ layer.constraints_use}} {{ layer.contraints_other}}
  </p>
  {% endif %}

  {% if layer.owner %}
  <p><strong>{% trans "Owner" %}:</strong>
      <a href="{{ layer.owner.get_profile.get_absolute_url }}"> {{ layer.owner.username }} </a>
  </p>
  {% endif %}

  {% if layer.poc %}
  <p> <strong>{% trans "Point of Contact" %}:</strong>
    {% if layer.poc.user %}
      <a href="{{ layer.poc.user.get_profile.get_absolute_url }}"> {{ layer.poc.user.username }} </a>
    {% else %}
      <ul>
          {% if layer.poc.name %}<li><strong>{% trans "Name" %}:</strong> {{ layer.poc.name}}</li>{% endif %}
          {% if layer.poc.email %}<li><strong>{% trans "Email" %}:</strong>  {{ layer.poc.email }}</li>{% endif %}
          {% if layer.poc.organization %}<li><strong>{% trans "Organization" %}:</strong> {{ layer.poc.organization}}</li>{% endif %}
          {% if layer.poc.position %}<li><strong>{% trans "Position" %}:</strong>: {{ layer.poc.position}}</li>{% endif %}
          {% if layer.poc.voice %}<li><strong>{% trans "Voice" %}:</strong>  {{ layer.poc.voice}}</li>{% endif %}
          {% if layer.poc.fax %}<li><strong>{% trans "Fax" %}:</strong> {{ layer.poc.fax}}</li>{% endif %}
          {% if layer.poc.delivery %}<li><strong>{% trans "Delivery" %}:</strong> {{ layer.poc.delivery}}</li>{% endif %}
          {% if layer.poc.area %}<li><strong>{% trans "Area" %}:</strong> {{ layer.poc.area}}</li>{% endif %}
          {% if layer.poc.zipcode %}<li><strong>{% trans "Zip Code" %}:</strong> {{ layer.poc.zipcode}}</li>{% endif %}
          {% if layer.poc.country %}<li><strong>{% trans "Country" %}:</strong> {{ layer.poc.country}}</li>{% endif %}
      </ul>
    {% endif %}
  </p>
  {% endif %}

  {% if layer.attribute_names %}
  <p> <strong>{% trans "Attributes" %}:</strong> 
      {{ layer.attribute_names|join:", " }}
  </p>
  {% endif %}

  {% if layer.supplemental_information %}
  <p> <strong>{% trans "Supplemental Information" %}:</strong> 
      {{ layer.supplemental_information }}
  </p>
  {% endif %}

  {% if layer.data_quality_statement %}
  <p> <strong>{% trans "Data Quality Statement" %}:</strong> 
      {{ layer.data_quality_statement }}
  </p>
  {% endif %}

  {% if layer.geographic_bounding_box %}<p> <strong>{% trans "Bounding Box" %}:</strong> {{ layer.geographic_bounding_box }} </p>{% endif %}
  {% if layer.resource.projection %}<p> <strong>{% trans "Native SRS" %}:</strong> {{ layer.resource.projection|default:_("No SRS specified.") }} </p>{% endif %}
{% endblock %}

{% block sidebar %}

  <ul class="nav nav-list">

    <li class="nav-header">{% trans "Download Data" %}</li>
    {% for extension, type, link in layer.download_links %}
      <li><a href="{{ link }}">{{ type }}</a></li>
    {% endfor %}

    <li class="nav-header">{% trans "Download Metadata" %}</li>
    {% for mimetype, mdtype, link in layer.metadata_links %}
        <li><a href="{{ link }}">{{ mdtype }}</a></li>
    {% empty %}
        <li>{% trans "No metadata links provided for this data." %}</li>
    {% endfor %}

    <li class="nav-header">{% trans "The following maps use this data set" %}</li>
    {% for map in layer.maps %} 
      <li><a href="{{ map.get_absolute_url }}">{{ map.title }}</a></li>
    {% empty %}
      <li>{% trans "This layer is not currently used in any maps." %}</li>
    {% endfor %}
    <li>
      <a href="{% url geonode.maps.views.newmap %}?layer={{ layer.typename }}">{% trans "Create new map" %}</a>
    </li>
  </ul>

  <h5>{% trans "Styles" %}</h5>
  <p>{% trans "The following styles are associated with this data set.  Choose a style to view it in the preview to the left.  Click on a style name to view or edit the style." %}</p>
  {% has_obj_perm user layer "maps.change_layer" as can_change %}
  {% has_obj_perm user layer "maps.delete_layer" as can_delete %}
  <span class="styles-list form-inline">
    <input type="radio" name="style" id="{{layer.publishing.default_style.name}}" value="{{layer.publishing.default_style.name}}" checked="checked"/>
    <label for="{{layer.publishing.default_style.name}}" class="style-title">
     {% if layer.default_style.sld_title %}
        {{ layer.default_style.sld_title }}
     {% else %}
        {{ layer.default_style.name|title }}
     {% endif %}
    </label>
    <a href="{{ layer.default_style.body_href }}">SLD</a><br/>
    {% for style in layer.styles %} 
      <input type="radio" name="style" id="{{style.name}}" value="{{style.name}}"/>
      <label for="{{style.name}}" class="style-title">
       {% if style.sld_title %}
          {{ style.sld_title }}
       {% else %}
          {{ style.name|title }}
       {% endif %}
      </label>
      <a href="{{ style.body_href }}">SLD</a><br/>
    {% endfor %}
  </span>
  {% if user.is_authenticated and can_change %}
    {% trans "Default style:" %}
    <select name="default-style">
      <option value="{{layer.publishing.default_style.name}}" selected="selected">
        {{layer.publishing.default_style.name|title}}
      </option>
      {% for style in layer.styles %} 
        <option value="{{style.name}}"> {{ style.name|title }} </option>
      {% endfor %}
    </select><br />
    <a href="javascript:showStyle()">{% trans "Create new style" %}</a>
  {% endif %}

  <ul class="nav nav-list">
    {% if user.is_authenticated %}
      {% if can_change or can_delete or can_change_permissions %}
        <li class="nav-header">{% trans "Manage" %}</li>
        {% if user.is_authenticated %}
          {% if can_change %}
            <li> <a href="{% url layer_metadata layer.typename %}">
                {% trans "Update the description of this data" %}
            </a> </li>
            <li> <a href="{% url layer_replace layer.typename %}">
                {% trans "Upload a new version of this data" %}
            </a></li>
          {% endif %}

          {% if can_change_permissions %}
            <li><a href="{% url edit_layer_permissions layer.typename %}">
                {% trans "Edit Permissions" %}
            </a></li>
          {% endif %}

          {% if can_delete %}
            <li>
              <a href="{% url layer_remove layer.typename %}">
                {% trans "Remove" %}
              </a>
            </li>
          {% endif %}
        {% else %}
          <li>{% trans "Please authenticate to update or remove layers" %}</li>
        {% endif %}
      {% endif %}

      {% has_obj_perm user layer "maps.change_layer_permissions" as can_change_permissions %}
      {% if can_change_permissions %}
      <li class="nav-header">{% trans "Permissions" %}</li>
      <li class="form-inline">
        <div id="permissions_form"></div>
      </li>
      {% endif %}
    {% endif %}
  </ul>
{% endblock %}
