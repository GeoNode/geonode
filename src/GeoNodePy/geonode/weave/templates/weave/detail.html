{% extends "mbdc/page_layout.html" %}
{% load i18n %}
{% load geonode_auth %}
{% block title %} Weave - {{ block.super }} {% endblock %}

{% block head %}
{% include "geonode/ext_header.html" %}
{% include "geonode/app_header.html" %}
{{ block.super }}
<script type="text/javascript" src="{{ STATIC_URL }}weave/utils.js"></script>
<script language="JavaScript" type="text/javascript">
	var weaveReady = function() {
		var weave = document.getElementById("weave");
		Ext.Ajax.request({
			url: "{{ visualization.get_absolute_url }}/sessionstate",
			method: 'GET',
			success: function(xhr) {
				var sessionstate = Ext.decode(xhr.responseText);
				// show Weave in Dashboard mode without menubar
				sessionstate = setWeaveDashboard(sessionstate);
				weave.setSessionState([], sessionstate);
			},
			failure: function(xhr) {
				console.log('Failure!\n' + xhr.responseText);
			}
		});
	}
	
	{% if user.is_authenticated %}
	Ext.onReady(function(){
		{% has_obj_perm user visualization "weave.change_visualization_permissions" as can_change_permissions %}
		{% autoescape off %}
		{% if can_change_permissions %}
		new GeoNode.PermissionsEditor({
			renderTo: "permissions_form",
			submitTo: "{% url geonode.weave.views.ajax_visualization_permissions visualization.id %}",
			userLookup: "{% url geonode.views.ajax_lookup %}",
			permissions: {{ permissions_json }}
		});
		{% endif %}
		{% endautoescape %}
		});
	{% endif %}
</script>

{% endblock %}

{% block main %}

<div class="twocol">
	<div id="weavediv">
		<object width="600" height="400" id="weave" type="application/x-shockwave-flash" data="http://127.0.0.1:8080/weave.swf" id="weavediv" style="visibility: visible;">
			<param name="quality" value="high"><param name="bgcolor" value="#ffffff">
			<param name="allowfullscreen" value="true">
			<param name="allowscriptaccess" value="always">
			<param name="base" value="http://127.0.0.1:8080/">
			<param name="wmode" value="transparent">
		</object>
	</div>
</div>
<div class="threecol">
	<h3>{{ visualization.title }}</h3>
	<p>{{ visualization.abstract }}</p>
	<h3>Manage</h3>
	<ul>
		<li><a href="{{ visualization.get_absolute_url }}">View or edit this Visualization</a></li>
	</ul>



		{% has_obj_perm user visualization "weave.change_visualization_permissions" as can_change_permissions %}
		{% if can_change_permissions %}
		<h3>{% trans "Permissions" %}</h3>
		<p>{% trans "Select what kind of privileges to allow." %}</p>
		<div id="permissions_form"></div>
		{% endif %}
</div>
</div>

{% endblock %}

